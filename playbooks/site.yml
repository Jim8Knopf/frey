---
# ==============================================================================
# FREY MAIN PLAYBOOK
# ==============================================================================
# Purpose: Orchestrates the complete deployment of the Frey home server stack
#
# This playbook deploys 40+ Docker containers organized into service stacks:
#   - Infrastructure (Traefik, Authentik SSO, Portainer, Dockge, AdGuard DNS)
#   - Media (Jellyfin, Sonarr, Radarr, Audiobookshelf, qBittorrent, *arr suite)
#   - Automation (Home Assistant, n8n, Ollama AI, Piper TTS, Wyoming Whisper)
#   - Monitoring (Grafana, Prometheus, Loki, Uptime Kuma, Speedtest Tracker)
#   - Photos (Immich with face recognition and mobile sync)
#   - Cookbook (Mealie recipe manager)
#   - WiFi AP (FreyHub access point with automatic roaming)
#
# Deployment is controlled via feature toggles in group_vars/all/main.yml
# Secrets are encrypted with Ansible Vault in group_vars/all/secrets.yml
#
# Usage:
#   Full deployment:     ansible-playbook -i inventory/hosts.yml playbooks/site.yml
#   Specific stack:      ansible-playbook -i inventory/hosts.yml playbooks/site.yml --tags media
#   Dry run:             ansible-playbook -i inventory/hosts.yml playbooks/site.yml --check
#
# Tags available: wifi, security, docker, infrastructure, monitoring, media,
#                 automation, homeassistant, voice, photos, immich, cookbook, backup
# ==============================================================================

- name: Deploy Enhanced Raspberry Pi 5 Off-Grid Media & AI Hub
  hosts: all
  become: yes  # Run tasks with sudo privileges

  # Load configuration and encrypted secrets
  vars_files:
    - ../group_vars/all/main.yml      # Main configuration (feature toggles, service settings)
    - ../group_vars/all/secrets.yml   # Encrypted secrets (passwords, API tokens, OAuth secrets)

  # ==============================================================================
  # PRE-TASKS: Setup and preparation before role execution
  # ==============================================================================
  pre_tasks:

    # --------------------------------------------------------------------------
    # PRE-FLIGHT: Filesystem Health Check
    # --------------------------------------------------------------------------
    # This block attempts a benign write/read operation to detect critical
    # I/O errors early. An 'Input/output error' is unrecoverable by Ansible
    # and indicates a failing disk or corrupt filesystem.
    # --------------------------------------------------------------------------
    - name: Perform pre-flight filesystem health check
      tags: always
      block:
        - name: Write temporary health check file
          ansible.builtin.copy:
            content: "health_check"
            dest: "/tmp/frey_health_check.tmp"
            mode: '0644'
          changed_when: false

        - name: Clean up temporary health check file
          ansible.builtin.file:
            path: "/tmp/frey_health_check.tmp"
            state: absent
          changed_when: false
      rescue:
        - name: Fail playbook on critical I/O error
          ansible.builtin.fail:
            msg: |
              FATAL: Filesystem I/O error detected on the target host.
              This is a critical, unrecoverable error that Ansible cannot fix.
              It strongly indicates a hardware failure or filesystem corruption
              (e.g., a failing SD card or SSD).

              Please SSH into the host '{{ inventory_hostname }}' and run 'dmesg'
              to check for I/O errors before re-running the deployment.
          when: ansible_failed_result is defined and 'Input/output error' in (ansible_failed_result.msg | default('') or (ansible_failed_result.results | default([{}]))[0].msg | default(''))

    # --------------------------------------------------------------------------
    # PRE-FLIGHT: Stop Security Services
    # --------------------------------------------------------------------------
    # Stop fail2ban before deployment begins to prevent it from banning the
    # controller's IP if a task fails mid-run. The service will be re-enabled
    # at the end of a successful deployment.
    # --------------------------------------------------------------------------
    - name: PRE-FLIGHT - Ensure fail2ban is stopped
      tags: always
      ansible.builtin.systemd:
        name: fail2ban
        state: stopped
      ignore_errors: yes

    # TODO
    - name: Check for internet connectivity
      ansible.builtin.shell: ping -c 1 8.8.8.8
      register: internet_connection
      failed_when: false
      changed_when: false
    # --------------------------------------------------------------------------
    # FIX: Remove conflicting Docker APT sources
    # --------------------------------------------------------------------------
    # Problem: Some Docker installations leave behind conflicting apt sources
    # Solution: Find and remove old download.docker.com references to prevent
    #           package cache errors during deployment
    # --------------------------------------------------------------------------
    - name: Find apt source files
      find:
        paths: /etc/apt/sources.list.d
        patterns: '*.list'
        file_type: file
      register: apt_source_files
      ignore_errors: true

    - name: Check which apt source files reference download.docker.com
      shell: "grep -l 'download.docker.com' {{ item.path }} || true"
      loop: "{{ apt_source_files.files | default([]) }}"
      register: docker_source_matches
      changed_when: false
      failed_when: false

    - name: Remove Docker apt source files that reference download.docker.com
      file:
        path: "{{ item }}"
        state: absent
      loop: "{{ docker_source_matches.results | map(attribute='stdout') | reject('equalto','') | list }}"
      when: docker_source_matches is defined and docker_source_matches.results | length > 0
      become: true

    # --------------------------------------------------------------------------
    # Check internet connectivity before package operations
    # --------------------------------------------------------------------------
    - name: Check for internet connectivity (pre-flight)
      ansible.builtin.shell: ping -c 1 -W 3 1.1.1.1
      register: preflight_internet_check
      failed_when: false
      changed_when: false
      tags: always

    # --------------------------------------------------------------------------
    # Update package cache for all roles
    # --------------------------------------------------------------------------
    # Ensures we have latest package information before installing anything
    # cache_valid_time: 3600 = Only update if cache is older than 1 hour
    # Only runs if internet is available to avoid long retry delays
    # --------------------------------------------------------------------------
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: preflight_internet_check.rc == 0
      ignore_errors: true
      tags: always


  # ==============================================================================
  # ROLES: Service deployment in dependency order
  # ==============================================================================
  # Roles are executed in this order for dependency management:
  #   1. WiFi & Security - Network and firewall setup first
  #   2. Docker - Container runtime required by all services
  #   3. Infrastructure - Core services (Traefik, Authentik, Portainer, DNS)
  #   4. Service Stacks - Media, Automation, Monitoring, Photos, Cookbook
  #   5. System - Power monitoring and SSD optimization (if enabled)
  #
  # Each role is conditionally executed based on feature toggles in main.yml
  # Use tags for selective deployment (e.g., --tags media deploys only media stack)
  # ==============================================================================

  roles:
    - role: wifi_access_point
      tags: [wifi, networking]
      when: features.wifi_access_point

    - role: security
      tags: [security]
      when: security.ufw.enable or security.fail2ban.enable

    - role: docker_minimal
      tags: [docker, base]

    - role: infrastructure
      tags: [infrastructure, management]
      when: features.infrastructure

    - role: landing_page
      tags: [landing, infrastructure]
      when: features.landing_page | default(false)

    - role: authentication
      tags: [authentication, auth, sso]
      when: features.authentication

    - role: monitoring
      tags: [monitoring]
      when: features.monitoring

    - role: media
      tags: [media]
      when: features.media

    - role: automation
      tags: [automation, services, ai, homeassistant, voice]
      when: features.automation or features.homeassistant

    - role: bluetooth_audio
      tags: [bluetooth, audio]
      when: bluetooth_audio.enabled | default(false)

    - role: immich
      tags: [photos, immich]
      when: features.immich

    - role: cookbook
      tags: [cookbook, services]
      when: features.cookbook

    - role: backup
      tags: [backup]
      when: backup.enabled | default(false)

    - role: system
      tags: [system, optimization]
      when: system.power_monitoring.enabled | default(false) or system.ssd_optimization.enabled | default(false)

  # ==============================================================================
  # POST-TASKS: Cleanup and finalization after role execution
  # ==============================================================================
  post_tasks:
    # --------------------------------------------------------------------------
    # Copy maintenance scripts to target system
    # --------------------------------------------------------------------------
    # Scripts for common maintenance tasks (backups, updates, health checks)
    # Copied to /opt/frey/scripts/ on the Raspberry Pi
    # --------------------------------------------------------------------------
    - name: Copy maintenance scripts to target
      copy:
        src: ../scripts/
        dest: "{{ storage.base_dir | default('/opt/frey') }}/scripts/"
        mode: '0755'
      tags: always

    # --------------------------------------------------------------------------
    # FINAL STEP: Start Security Services
    # --------------------------------------------------------------------------
    # This task runs at the very end of a successful deployment.
    # By waiting until all firewall and network rules are in place, we
    # dramatically reduce the risk of accidental lockout.
    # --------------------------------------------------------------------------
    - name: FINAL - Enable and start fail2ban service
      tags: always
      ansible.builtin.systemd:
        name: fail2ban
        state: started
        enabled: yes
      when: security.fail2ban.enable | default(true)

