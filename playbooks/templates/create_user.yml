---
# Variables (defaults):
# create_user:
#   stack_name: "{{ create_user.user.name }}"  # Label for task names
#   user:                                      # Required: name; Optional: uid, groups
#   group:                                     # Required: name; Optional: gid
#   dirs:
#     base: []                                 # Directories to create (e.g., stacks, base data)
#     appdata: []                              # Additional data directories to create
#   default_mode: '0755'                       # Directory mode for created paths

- name: Create the {{ create_user.stack_name | default(create_user.user.name) }} group
  ansible.builtin.group:
    name: "{{ create_user.group.name }}"
    gid: "{{ create_user.group.gid | default(omit) }}"
    state: present

- name: Create the {{ create_user.stack_name | default(create_user.user.name) }} user
  ansible.builtin.user:
    name: "{{ create_user.user.name }}"
    uid: "{{ create_user.user.uid | default(omit) }}"
    group: "{{ create_user.group.name }}"
    groups: "{{ create_user.user.groups | default(omit) }}"
    state: present

- name: Create {{ create_user.stack_name | default(create_user.user.name) }} base directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ create_user.user.uid | default(create_user.user.name) }}"
    group: "{{ create_user.user.groups | default(create_user.group.name) }}"
    mode: "{{ create_user.default_mode | default('0755') }}"
  loop: "{{ create_user.dirs.base | default([]) }}"
  when: (create_user.dirs.base | default([])) | length > 0

- name: Create {{ create_user.stack_name | default(create_user.user.name) }} appdata directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ create_user.user.name }}"
    group: "{{ create_user.group.name }}"
    mode: "{{ create_user.default_mode | default('0755') }}"
  loop: "{{ create_user.dirs.appdata | default([]) }}"
  when: (create_user.dirs.appdata | default([])) | length > 0
