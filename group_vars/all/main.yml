---
# ================================
# FEATURE TOGGLES
# ================================
features:
  infrastructure: true
  networking: true
  wifi_access_point: true
  media_stack: true
  monitoring: true
  file_management: false
  ai_stack: false
  photo_management: false
  homeassistant: false
  backup: false
  piper: false
  cookbook: false
  power_monitoring: false
  voice_assistant: false

# (No deploy_* compatibility mappings here â€” use `features.*` toggles)

# ================================
# USER CONFIGURATION
# ================================
user:
  name: media
  uid: 1000
  gid: 1000

# ================================
# DOCKER CONFIGURATION
# ================================
docker:
  users: [ "{{ user.name }}" ]

# ================================
# STORAGE PATHS
# ================================
storage:
  base_dir: /opt/frey
  media_dir: "{{ storage.base_dir }}/media"
  appdata_dir: "{{ storage.base_dir }}/appdata"
  downloads_dir: "{{ storage.base_dir }}/downloads"
  photos_dir: "{{ storage.base_dir }}/photos"
  ai_dir: "{{ storage.base_dir }}/ai"
  backups_dir: "{{ storage.base_dir }}/backups"
  logs_dir: "{{ storage.base_dir }}/logs"
  stacks_dir: "{{ storage.base_dir }}/stacks"  # For Dockge

# ==============================================================================
# ROLE: INFRASTRUCTURE & NETWORKING
# ==============================================================================
network:
  domain_name: frey
  timezone: Australia/Hobart
  dns_rewrites:
    - name: jellyfin
    - name: sonarr
    - name: radarr
    - name: bazarr
    - name: audiobookshelf
    - name: qbittorrent
    - name: prowlarr
    - name: dockge
    - name: portainer
    - name: grafana
    - name: uptime-kuma
    - name: traefik
    - name: immich
    - name: cookbook
    - name: jellyseerr
    - name: lidarr
    - name: jellystat
  macvlan:
    enable: false
    physical_interface: "wlan0"
    network_name: "macvlan_net"
    subnet: "192.168.1.0/24"
    gateway: "192.168.1.1"
    ip_range: "192.168.1.200/28"

# ==============================================================================
# ROLE: WIFI_ACCESS_POINT
# ==============================================================================
wifi:
  ssid: "FreyHub"
  password: "YourSecurePassword"
  channel: 7
  country: "AU"
  ip: "192.168.4.1"
  dhcp_range_start: "192.168.4.10"
  dhcp_range_end: "192.168.4.50"
  interface: "wlan1"
  client_interface: "wlan0"
  network: "192.168.4.0/24"
  hw_mode: g
  macaddr_acl: 0
  auth_algs: 1
  ignore_broadcast_ssid: 0
  ieee80211n: 1
  wmm_enabled: 1

# ==============================================================================
# SERVICE PORTS
# ==============================================================================
ports:
  ai_stack:
    ollama: 11434
    openwebui: 3000
  photos_home:
    immich: 2283
    homeassistant: 8123
  infrastructure:
    traefik: 80
    traefik_dashboard: 8081
    portainer: 9000
    dockge: 5001
  monitoring:
    grafana: 3001
    prometheus: 9090
    node_exporter: 9100
    cadvisor: 8082
    loki: 3100
    promtail: 9080
    uptime_kuma: 3002
  file_management:
    filebrowser: 8083
    code_server: 8084
  network_tools:
    speedtest: 8085
    adguardhome: 3053
  cookbook:
    cookbook: 8090
  voice_assistant:
    piper: 10200

# ==============================================================================
# SECURITY SETTINGS
# ==============================================================================
security:
  fail2ban:
    enable: true
  ufw:
    enable: true
  ssh_port: 22
  firewall_tcp_ports: "{{
    [security.ssh_port, ports.infrastructure.dockge] +
    (features.infrastructure | ternary([ports.infrastructure.traefik, ports.infrastructure.traefik_dashboard, ports.infrastructure.portainer], [])) +
    (features.media_stack | ternary([
      media_stack.services.jellyfin.port,
      media_stack.services.sonarr.port,
      media_stack.services.radarr.port,
      media_stack.services.bazarr.port,
      media_stack.services.audiobookshelf.port,
      media_stack.services.qbittorrent.port,
      media_stack.services.prowlarr.port,
      media_stack.services.jellyseerr.port,
      media_stack.services.lidarr.port,
      media_stack.services.jellystat.port
    ], [])) +
    (features.ai_stack | ternary([ports.ai_stack.ollama, ports.ai_stack.openwebui], [])) +
    (features.photo_management | ternary([ports.photos_home.immich], [])) +
    (features.homeassistant | ternary([ports.photos_home.homeassistant], [])) +
    (features.monitoring | ternary([ports.monitoring.grafana, ports.monitoring.prometheus, ports.monitoring.uptime_kuma, ports.network_tools.speedtest], [])) +
    (features.networking | ternary([ports.network_tools.adguardhome], [])) +
    (features.file_management | ternary([ports.file_management.filebrowser, ports.file_management.code_server], [])) +
    (features.cookbook | ternary([ports.cookbook.cookbook], [])) +
    (features.voice_assistant | ternary([ports.voice_assistant.piper], []))
    }}"

# ==============================================================================
# OPTIMIZATION SETTINGS
# ==============================================================================
optimization:
  ssd:
    enable: false
    trim: true
  german_content:
    locale: de_DE.UTF-8
    enable_indexers: true

# ==============================================================================
# POWER MANAGEMENT (12V setup)
# ==============================================================================
power:
  low_threshold: 11.8
  critical_threshold: 11.0
  enable_graceful_shutdown: false

# ================================
# AUTOMATION SETTINGS
# ================================
automation:
  watchtower_interval: 86400
  backup_retention_days: 7

# ================================
# VOICE ASSISTANT
# ================================
voice_assistant:
  deploy: false
  wake_word: "frey"
  porcupine_access_key: "YOUR_PICOVOICE_ACCESS_KEY"
  ollama_model: "llama3:latest"
  piper_voice: "en_US-lessac-medium"
  piper_voices:
    - "en_US-lessac-medium"
    - "en_AU-southern-female"
    - "de_DE-thorsten-medium"

# Add to group_vars/all/main.yml

# ==============================================================================
# MEDIA STACK - ENHANCED WITH INTERNAL NETWORKING
# ==============================================================================
media_stack:
  media_uid: "{{ user.uid }}"
  media_gid: "{{ user.gid }}"
  timezone: "{{ network.timezone }}"
  appdata_dir: "{{ storage.appdata_dir }}"
  media_dir: "{{ storage.media_dir }}"
  downloads_dir: "{{ storage.downloads_dir }}"
  domain_name: "{{ network.domain_name }}"
  
  # Internal network configuration
  network:
    name: "media_network"
    subnet: "172.20.0.0/24"
    gateway: "172.20.0.1"
  
  # Services with internal IPs
  services:
    jellyfin:
      port: 8096
      internal_ip: "172.20.0.10"
      container_name: "jellyfin"
    
    sonarr:
      port: 8989
      internal_ip: "172.20.0.20"
      container_name: "sonarr"
      api_key: "{{ vault.media.sonarr.api_key if vault is defined and vault.media is defined and vault.media.sonarr is defined else '' }}"
      
    radarr:
      port: 7878
      internal_ip: "172.20.0.21"
      container_name: "radarr"
      api_key: "{{ vault.media.radarr.api_key if vault is defined and vault.media is defined and vault.media.radarr is defined else '' }}"
      
    prowlarr:
      port: 9696
      internal_ip: "172.20.0.22"
      container_name: "prowlarr"
      api_key: "{{ vault.media.prowlarr.api_key if vault is defined and vault.media is defined and vault.media.prowlarr is defined else '' }}"
      
    qbittorrent:
      port: 8080
      internal_ip: "172.20.0.30"
      container_name: "qbittorrent"
      
    bazarr:
      port: 6767
      internal_ip: "172.20.0.23"
      container_name: "bazarr"
      
    lidarr:
      port: 8686
      internal_ip: "172.20.0.24"
      container_name: "lidarr"
      api_key: "{{ vault.media.lidarr.api_key if vault is defined and vault.media is defined and vault.media.lidarr is defined else '' }}"
      
    jellyseerr:
      port: 5055
      internal_ip: "172.20.0.40"
      container_name: "jellyseerr"
      
    audiobookshelf:
      port: 13378
      internal_ip: "172.20.0.50"
      container_name: "audiobookshelf"
      
    audiobookrequest:
      port: 5432
      internal_ip: "172.20.0.51"
      container_name: "audiobookrequest"
      
    jellystat:
      port: 8086
      internal_ip: "172.20.0.60"
      container_name: "jellystat"
      
    jellystat_db:
      internal_ip: "172.20.0.61"
      container_name: "jellystat-db"

  # Service URLs for internal communication
  internal_urls:
    sonarr: "http://{{ media_stack.services.sonarr.internal_ip }}:{{ media_stack.services.sonarr.port }}"
    radarr: "http://{{ media_stack.services.radarr.internal_ip }}:{{ media_stack.services.radarr.port }}"
    prowlarr: "http://{{ media_stack.services.prowlarr.internal_ip }}:{{ media_stack.services.prowlarr.port }}"
    qbittorrent: "http://{{ media_stack.services.qbittorrent.internal_ip }}:{{ media_stack.services.qbittorrent.port }}"
    jellyfin: "http://{{ media_stack.services.jellyfin.internal_ip }}:{{ media_stack.services.jellyfin.port }}"
    lidarr: "http://{{ media_stack.services.lidarr.internal_ip }}:{{ media_stack.services.lidarr.port }}"