---
# ==============================================================================
# GLOBAL CONFIGURATION VARIABLES
# ==============================================================================
# This file contains only truly global variables that affect multiple roles.
# Role-specific variables have been moved to roles/*/defaults/main.yml

# ================================
# FEATURE TOGGLES
# ================================
# Control which roles are enabled/disabled
features:
  infrastructure: true
  landing_page: false
  networking: true
  wifi_access_point: true
  media: true
  monitoring: true
  automation: false
  authentication: false  # Authelia/LLDAP SSO - enable after initial setup
  file_management: false
  immich: false
  homeassistant: false  # Home Assistant + Piper TTS + Wyoming Whisper STT
  bluetooth_audio: false  # Bluetooth headphones/speakers with auto-connection
  backup: false  # Automated backup system
  cookbook: false # Mealie Recipe Manager

# ================================
# GLOBAL CONFIGURATION
# ================================
# Admin contact information
admin:
  email: "Jason.Kolb@ik.me"

# Global user definitions
users:
  default:
    name: else
    uid: 1000
    gid: 1000
  docker:
    name: docker
    uid: 362537
    groups: docker

# ================================
# STORAGE PATHS
# ================================
# Global storage paths used across all roles
storage:
  base_dir: /opt/frey
  appdata_dir: "{{ storage.base_dir }}/appdata"
  stacks: "{{ storage.base_dir }}/stacks"

# ==============================================================================
# NETWORK CONFIGURATION (GLOBAL)
# ==============================================================================
network:
  domain_name: frey
  timezone: Australia/Hobart
  # Authelia public URL for OAuth authorization (browser redirects)
  # Uses DNS via Traefik for clean OAuth flow (primary access method)
  # OAuth: grafana.frey → auth.frey → grafana.frey
  # Works offline via AdGuard local DNS resolution
  authentik_public_url: "https://auth.{{ network.domain_name }}"

  # DNS Service Resolution
  # Services configured here will be accessible via DNS (e.g., http://jellyfin.frey)
  dns_rewrites:
    # Landing + apex host
    - name: frey
      host: "{{ network.domain_name }}"
    - name: landing
    # Infrastructure services
    - name: traefik
    - name: portainer
    - name: dockge
    - name: auth  # Authelia/LLDAP SSO
    - name: lldap  # LDAP server
    # Monitoring services
    - name: grafana
    - name: prometheus
    - name: loki
    - name: metrics     # node-exporter
    - name: cadvisor
    - name: speedtest
    - name: uptime-kuma
    # Media services
    - name: jellyfin
    - name: sonarr
    - name: radarr
    - name: bazarr
    - name: audiobookshelf
    - name: audiobookrequest
    - name: nzbget
    - name: flaresolverr
    - name: qbittorrent
    - name: prowlarr
    - name: immich
    - name: cookbook
    - name: jellyseerr
    - name: lidarr
    - name: jellystat
    # Automation + smart home
    - name: homeassistant
    - name: n8n

  # WiFi Roaming Configuration (wlan0 client interface)
  wifi:
    roaming:
      enabled: true  # Toggle for automatic WiFi roaming service
      scan_intervals:
        default: 120         # Default scan interval (seconds) - 2 minutes for quick network discovery
        no_connection: 120   # Scan interval when no connection (seconds) - 2 minutes, reduced from 30s
        no_internet: 180     # Scan interval when no internet (seconds) - 3 minutes, reduced from 60s
        good: 900            # Scan interval on stable connection (seconds) - 15 minutes

    # Known networks - networks that should skip captive portal bypass
    # Add your personal hotspots, home WiFi, or other trusted networks here
    known_networks:
      # Personal hotspot - provides direct internet without captive portal
      - ssid: "NOTHING by JK"
        skip_portal_bypass: true

      # Future: Networks with known portal credentials can be added like this:
      # - ssid: "Library WiFi"
      #   portal_credentials:
      #     username: "guest"
      #     password: "password123"

# ==============================================================================
# SECURITY SETTINGS (GLOBAL)
# ==============================================================================
# Dynamic firewall port configuration based on enabled features
security:
  fail2ban:
    enable: true
  ufw:
    enable: true
  ssh_port: 22
  # Dynamically computed list of TCP ports to open based on enabled features
  firewall_tcp_ports: "{{
    [security.ssh_port, infrastructure.services.dockge.ports.http] +
    (features.infrastructure | ternary([
      infrastructure.services.traefik.ports.http,
      infrastructure.services.traefik.ports.dashboard,
      infrastructure.services.portainer.ports.http
    ], [])) +
    (features.media | ternary([
      media.services.jellyfin.port,
      media.services.sonarr.port,
      media.services.radarr.port,
      media.services.bazarr.port,
      13378,  # audiobookshelf external port (mapped from internal port 80)
      media.services.qbittorrent.port,
      media.services.prowlarr.port,
      media.services.jellyseerr.port,
      media.services.lidarr.port,
      media.services.jellystat.port
    ], [])) +
    (features.automation | ternary([
      automation.services.ollama.port,
      automation.services.openwebui.port,
      automation.services.n8n.port
    ], [])) +
    (features.immich | ternary([
      immich.services.immich.port
    ], [])) +
    (features.homeassistant | ternary([
      homeassistant.services.homeassistant.port
    ], [])) +
    (features.monitoring | ternary([
      monitoring.grafana.port,
      monitoring.prometheus.port,
      monitoring['uptime-kuma'].port,
      monitoring['speedtest-tracker'].port
    ], [])) +
    (features.cookbook | ternary([
      cookbook.services.mealie.port
    ], []))
    }}"

  # Dynamic TCP firewall ports (public access):
  # - qbittorrent.listen_port (51234): Torrent traffic (peer connections)
  firewall_public_tcp_ports: "{{
    (features.media | ternary([
      media.services.qbittorrent.listen_port
    ], []))
    }}"

  # Dynamic UDP firewall ports:
  # - qbittorrent.listen_port (51234): Torrent traffic
  # - 1900: UPnP SSDP service discovery
  # - 5351: NAT-PMP port mapping
  firewall_udp_ports: "{{
    (features.media | ternary([
      media.services.qbittorrent.listen_port,
      1900,
      5351
    ], []))
    }}"

# ==============================================================================
# OPTIMIZATION SETTINGS (GLOBAL)
# ==============================================================================
optimization:
  ssd:
    enable: false
    trim: true
  german_content:
    locale: de_DE.UTF-8
    enable_indexers: true


infrastructure:
  services:
    step_ca:
      force_reinit: false
