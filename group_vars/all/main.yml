---
# ================================
# FEATURE TOGGLES
# ================================
features:
  infrastructure: true
  networking: true
  wifi_access_point: true
  media: true
  monitoring: true
  automation: true
  authentication: true  # Authentik SSO - enable after initial setup
  file_management: false
  immich: true
  homeassistant: true  # Home Assistant + Piper TTS + Wyoming Whisper STT
  bluetooth_audio: true  # Bluetooth headphones/speakers with auto-connection
  backup: false  # Automated backup system
  cookbook: true
  power_monitoring: false  # Deprecated - use system.power_monitoring.enabled instead
  voice_assistant: false  # Deprecated - integrated into homeassistant role

# ================================
# CONFIGURATION
# ================================
# Admin contact information
admin_email: "Jason.Kolb@ik.me"

users:
  default: 
    name: else
    uid: 1000
    gid: 1000
  docker:
    name: docker
    uid: 362537
    groups: docker



# ================================
# STORAGE PATHS
# ================================
storage:
  base_dir: /opt/frey
  appdata_dir: "{{ storage.base_dir }}/appdata"
  stacks: "{{ storage.base_dir }}/stacks"

# ==============================================================================
# ROLE: INFRASTRUCTURE & NETWORKING
# ==============================================================================
network:
  domain_name: frey
  timezone: Australia/Hobart
  # Authentik public URL for OAuth authorization (browser redirects)
  # Uses DNS via Traefik for clean OAuth flow (primary access method)
  # OAuth: grafana.frey → auth.frey → grafana.frey
  # Works offline via AdGuard local DNS resolution
  authentik_public_url: "https://auth.{{ network.domain_name }}"
  wifi:
    # Network identification
    ssid: "FreyHub"                 # Network name visible to clients
    password: "{{ wifi_ap.password }}"  # Password from secrets.yml
    
    # Geographic settings (affects channels and power levels)
    country: "AU"                   # Two-letter country code
    
    # Network configuration
    ip: "10.20.0.1"                # AP's IP address
    network: "10.20.0.0/24"        # Network subnet for WiFi clients
    dhcp_range_start: "10.20.0.50" # Start of DHCP address pool
    dhcp_range_end: "10.20.0.150"  # End of DHCP address pool
    
    # Interface configuration
    interface: "wlan1"             # WiFi interface for AP mode
    client_interface: "wlan0"      # Client interface for roaming
    client_interface_ip: "192.168.0.252" #TODO Client interface IP (for authentik)
    roaming:
      enabled: true
      client_interface: "wlan0"  # Interface for connecting to public WiFi
      mqtt_topic: "frey/wifi/roaming"
      known_networks: "{{ wifi_ap.known_networks }}"  # From secrets.yml
    
    # WiFi radio settings
    # Set hw_mode to 'auto' to prefer 5GHz when supported, else fall back to 2.4GHz
    hw_mode: auto                  # auto: prefer 5GHz (a) if supported; else 2.4GHz (g)
    # channel: 7                     # Desired channel; auto logic overrides to 36 on 5GHz if invalid
    ieee80211n: 1                  # Enable 802.11n features
    wmm_enabled: 1                 # Enable WiFi multimedia (QoS)
    
    # Security settings
    macaddr_acl: 0                 # MAC address filtering
    auth_algs: 1                   # WPA authentication
    ignore_broadcast_ssid: 0       # Broadcast SSID

  # DNS Service Resolution
  dns_rewrites:
    # Infrastructure services
    - name: traefik
    - name: portainer
    - name: dockge
    - name: auth  # Authentik SSO
    # Monitoring services
    - name: grafana
    - name: prometheus
    - name: metrics     # node-exporter
    - name: cadvisor
    - name: speedtest
    - name: uptime-kuma
    # Media services
    - name: jellyfin
    - name: sonarr
    - name: radarr
    - name: bazarr
    - name: audiobookshelf
    - name: qbittorrent
    - name: prowlarr
    - name: immich
    - name: cookbook
    - name: jellyseerr
    - name: lidarr
    - name: jellystat


# ==============================================================================
# SECURITY SETTINGS
# ==============================================================================
security:
  fail2ban:
    enable: true
  ufw:
    enable: true
  ssh_port: 22
  firewall_tcp_ports: "{{
    [security.ssh_port, ports.infrastructure.dockge] +
    (features.infrastructure | ternary([
      ports.infrastructure.traefik, 
      ports.infrastructure.traefik_dashboard, 
      ports.infrastructure.portainer
    ], [])) +
    (features.media | ternary([
      media.services.jellyfin.port,
      media.services.sonarr.port,
      media.services.radarr.port,
      media.services.bazarr.port,
      media.services.audiobookshelf.port,
      media.services.qbittorrent.port,
      media.services.prowlarr.port,
      media.services.jellyseerr.port,
      media.services.lidarr.port,
      media.services.jellystat.port
    ], [])) +
    (features.automation | ternary([
      automation.ollama.port,
      automation.openwebui.port,
      automation.n8n.port
    ], [])) +
    (features.immich | ternary([
      ports.photos_home.immich
    ], [])) +
    (features.homeassistant | ternary([
      ports.photos_home.homeassistant
    ], [])) +
    (features.monitoring | ternary([
      ports.monitoring.grafana, 
      ports.monitoring.prometheus, 
      ports.monitoring.uptime_kuma, 
      ports.network_tools.speedtest
    ], [])) +
    (features.networking | ternary([
      ports.network_tools.adguardhome
    ], [])) +
    (features.file_management | ternary([
      ports.file_management.filebrowser, 
      ports.file_management.code_server
    ], [])) +
    (features.cookbook | ternary([
      cookbook.services.mealie.port
    ], [])) +
    (features.voice_assistant | ternary([
      ports.voice_assistant.piper
    ], []))
    }}"

# ==============================================================================
# OPTIMIZATION SETTINGS
# ==============================================================================
optimization:
  ssd:
    enable: false
    trim: true
  german_content:
    locale: de_DE.UTF-8
    enable_indexers: true

# ==============================================================================
# POWER MANAGEMENT (12V setup)
# ==============================================================================
power:
  low_threshold: 11.8
  critical_threshold: 11.0
  enable_graceful_shutdown: false

# ================================
# AUTOMATION SETTINGS
# ================================
automation:
  watchtower_interval: 86400 #?
  backup_retention_days: 7  #?
  group:
    name: automation
    gid: 2886
  user:
    name: automation_manager
    uid: 463288672
    groups: "{{ automation.group.name }}"
  dir: "{{ storage.base_dir }}/automation"

  services:
    ollama:
      enabled: true
      image: "ollama/ollama:latest"
      port: 11434
      gpu_enabled: false
    openwebui:
      enabled: true
      image: "ghcr.io/open-webui/open-webui:main"
      port: 3002
    n8n:
      enabled: true
      image: "n8nio/n8n:latest"
      port: 5678

# ================================
# VOICE ASSISTANT
# ================================
voice_assistant:
  deploy: true
  wake_word: "frey"
  ollama_model: "llama3:latest"
  piper_voice: "en_US-lessac-medium"
  piper_voices:
    - "en_US-lessac-medium"
    - "en_AU-southern-female"
    - "de_DE-thorsten-medium"


monitoring:
  group:
    name: monitoring
    gid: 12341
  user:
    name: monitoring_manager
    uid: 12341
    groups: "{{ monitoring.group.name }}"
  dir: "{{ storage.base_dir }}/monitoring"
  dockge:
    enabled: true
    port: 5001
    image: "louislam/dockge"
    version: 1
  prometheus:
    enabled: true
    port: 9090
    image: "prom/prometheus"
    version: "latest"
  node-exporter:
    enabled: true
    port: 9100
    image: "prom/node-exporter"
    version: "latest"
  cadvisor:
    enabled: true
    port: 8081
    image: "gcr.io/cadvisor/cadvisor"
    version: "latest"
  grafana:
    enabled: true
    port: 3000
    image: "grafana/grafana"
    version: "latest"
    # OIDC/SSO Configuration (enabled when infrastructure.services.authentik.enabled is true)
    # All OAuth URLs use clean DNS names without ports (http://auth.frey)
    # Browser: auth.frey → AdGuard DNS → Traefik → Authentik
    # Backend: auth.frey → Traefik network alias → Traefik → Authentik
    # Works offline via AdGuard local DNS and Docker network aliases through Traefik
    oidc_client_id: "grafana"
    oidc_scopes: "openid profile email"
    oidc_auth_url: "{{ network.authentik_public_url }}/application/o/authorize/"
    oidc_token_url: "{{ network.authentik_public_url }}/application/o/token/"
    oidc_api_url: "{{ network.authentik_public_url }}/application/o/userinfo/"
    oidc_role_attribute_path: "contains(groups, 'grafana_admins') && 'Admin' || contains(groups, 'grafana_editors') && 'Editor' || 'Viewer'"
  loki:
    enabled: true
    port: 3100
    image: "grafana/loki"
    version: "latest"
  promtail:
    enabled: true
    image: "grafana/promtail"
    version: "latest"
  uptime-kuma:
    enabled: true
    port: 3001
    image: "louislam/uptime-kuma"
    version: 1
  watchtower:
    enabled: true
    image: "containrrr/watchtower"
    version: "latest"
  speedtest-tracker:
    enabled: true
    port: 8181
    image: "lscr.io/linuxserver/speedtest-tracker"
    version: "latest"


# ===================================================================
# INFRASTRUCTURE - REFACTORED FOR DYNAMIC COMPOSE GENERATION
# ===================================================================
infrastructure:
  group:
    name: infrastructure
    gid: 46372
  user:
    name: infrastructure_manager
    uid: 46372
    groups: "{{ infrastructure.group.name }}"
  dir: "{{ storage.base_dir }}/infrastructure"
  services:
    traefik:
      enabled: true
      version: "latest"
      ports:
        http: 80
        https: 443
        dashboard: 8082
      config:
        acme_email: "{{ admin_email }}"  # Using admin email for Let's Encrypt notifications
    portainer:
      enabled: true
      version: "latest"
      ports:
        http: 9000
    dockge:
      enabled: true
      version: "1"
      ports:
        http: 5001
    authentik:
      enabled: true  # Enable after initial infrastructure setup
      version: "2025.2.4"  # Pinned version for reproducible deployments
      port: 9300  # Changed from 9000 to avoid conflict with Portainer
      port_https: 9446
      postgres_version: "16-alpine"
      redis_version: "alpine"
      # Blueprint re-apply control:
      # - Set to a list of filenames to re-apply specific blueprints
      #   e.g., ['11-oidc-audiobookshelf.yaml', '10-oidc-immich.yaml']
      # - Or set to 'all' to re-apply every blueprint file
      reapply_blueprints: ['11-oidc-audiobookshelf.yaml','14-oidc-mealie.yaml']
    step_ca:
      enabled: true  # Enable when ready to implement ACME-based certificate management
      version: "latest"
      port: 9336  # External port mapping (maps to internal 9443)
      # After enabling, run: docker exec -it step-ca step ca init
      # Then configure ACME provisioner: docker exec -it step-ca step ca provisioner add acme --type ACME

# ===================================================================
# MEDIA STACK - REFACTORED FOR DYNAMIC COMPOSE GENERATION
# ===================================================================
media:
  group:
    name: media
    gid: 63342
  user:
    name: media_manager
    uid: 63342
    groups: "{{ media.group.name }}"
  dir: "{{ storage.base_dir }}/media"
  downloads: "{{ storage.base_dir }}/downloads"

  network:
    name: "media_network"
    subnet: "10.20.0.0/24" # TODO probably unnessecarry 
    gateway: "10.20.0.1"

  vpn:
    enabled: false
    port: 8888

  services:
    audiobookshelf:
      enabled: true
      version: "latest"
      image: "ghcr.io/advplyr/audiobookshelf"
      port: 80  # Internal container port for Traefik routing
      ports:
        - 13378:80  # External:Internal port mapping
      volumes:
        - "{{ storage.appdata_dir }}/audiobookshelf:/config"
        - "{{ media.dir }}/audiobooks:/audiobooks"
        - "{{ media.dir }}/podcasts:/podcasts"
        # Trust Step-CA root for outbound TLS to Authentik (OIDC discovery)
        - "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt:/etc/ssl/certs/step-ca.crt:ro"
      environment:
        # Ensure Node trusts Step-CA when calling https://auth.frey
        - "NODE_EXTRA_CA_CERTS=/etc/ssl/certs/step-ca.crt"
      # OIDC/SSO Configuration (enabled when infrastructure.services.authentik.enabled is true)
      # NOTE: Audiobookshelf OIDC CANNOT be configured via environment variables
      # Must be configured manually via web UI: Settings → Authentication → OpenID Connect
      # Use these values when configuring in UI:
      oidc_issuer_url: "{{ network.authentik_public_url }}/application/o/audiobookshelf/"
      oidc_client_id: "audiobookshelf"
      # Client secret is in secrets.yml: audiobookshelf_oidc_client_secret
      oidc_button_text: "Login with Authentik"
      oidc_auto_register: true
      oidc_auto_launch: false

    jellyfin:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/jellyfin"
      port: 8096
      volumes:
        - "{{ storage.appdata_dir }}/jellyfin:/config"
        - "{{ media.dir }}/tv:/data/tvshows"
        - "{{ media.dir }}/movies:/data/movies"
      # LDAP Configuration (enabled when infrastructure.services.authentik.enabled is true)
      # Requires LDAP Authentication plugin from Jellyfin catalog (installed manually via UI)
      # Plugin location: Dashboard > Plugins > Catalog > "LDAP Authentication"
      # Uses internal Docker service name for reliable communication across networks
      # NOTE: Configuration is managed via XML file (plugin doesn't support env vars)
      ldap_server: "ak-outpost-jellyfin-ldap-outpost"
      ldap_port: 3389                # Authentik LDAP outpost uses non-standard port 3389 (not 389)
      ldap_use_ssl: false            # No SSL for internal Docker network communication
      ldap_use_starttls: false       # No STARTTLS needed
      ldap_skip_ssl_verify: false    # N/A when SSL disabled
      ldap_base_dn: "dc=ldap,dc=goauthentik,dc=io"
      # Authentik LDAP outpost uses uid as the RDN for users; DN must use uid
      ldap_bind_user: "uid=ldap_bind,ou=users,dc=ldap,dc=goauthentik,dc=io"
      ldap_search_filter: "(uid=*)"  # Rely on Authentik provider search_group to restrict users
      ldap_admin_base_dn: ""         # Same as ldap_base_dn (empty uses default)
      ldap_admin_filter: "(memberOf=cn=jellyfin_admins,ou=groups,dc=ldap,dc=goauthentik,dc=io)"
      # User creation and library access settings
      ldap_create_users: true        # Auto-create Jellyfin users on first LDAP login
      ldap_enable_all_folders: true  # Grant LDAP users access to all media libraries
      # LDAP attribute mappings (standard Authentik LDAP schema)
      ldap_search_attributes: "uid, cn, mail, displayName"
      ldap_uid_attribute: "uid"
      ldap_username_attribute: "uid"
      ldap_password_attribute: "userPassword"
      ldap_allow_pass_change: false  # Users change passwords in Authentik, not Jellyfin
    
    jellyseerr:
      enabled: true
      version: "latest"
      port: 5055
    
    qbittorrent:
      enabled: true
      version: "latest"
      port: 8080
      ports: 
        - "8080:8080"    # Web UI
        - "51234:51234/tcp"    # Torrent Port
        - "51234:51234/udp"    # Torrent Port

    nzbget:
      enabled: true
      version: "latest"
      port: 6789

    prowlarr:
      enabled: true
      version: "latest"
      port: 9696

    flaresolverr:
      enabled: true
      version: "latest"
      port: 8191

    sonarr:
      enabled: true
      version: "latest"
      port: 8989

    radarr:
      enabled: true
      version: "latest"
      port: 7878

    bazarr:
      enabled: true
      version: "latest"
      port: 6767

    lidarr:
      enabled: true
      version: "latest"
      port: 8686
        
    audiobookrequest:
      enabled: true
      version: "latest"
      port: 5432

    jellystat:
      enabled: false
      version: "latest"
      port: 8086

    jellystat_db:
      enabled: "{{ media.services.jellystat.enabled }}" # Jellystat dependency
      version: 15
      image: "postgres"
      environment:
        - "POSTGRES_DB=jellystat"
        - "POSTGRES_USER=jellystat"
        - "POSTGRES_PASSWORD=jellystat"

    ytdl-sub:
      enabled: false
      version: "latest"

    mopidy:
      enabled: false  # DISABLED: No ARM64-compatible image available
      # TODO: Build custom ARM64 Mopidy image or use alternative music player
      # For now, use Jellyfin directly for music playback
      version: "latest"
      image: "wernight/mopidy"  # Note: Only supports AMD64
      port: 6680  # Required for pre-pull task (web interface port)
      mpd_port: 6600  # MPD protocol for Home Assistant integration
      http_port: 6680  # Web interface

    audiobook_bridge:
      enabled: true  # Enable for local audiobook playback with progress sync
      version: "3.11-slim"
      image: "python"
      port: 0  # No port exposed (internal service only)
      sync_interval: 5  # Progress sync interval in seconds

# ===================================================================
# PHOTO MANAGEMENT - IMMICH STACK
# ===================================================================
immich:
  group:
    name: photos
    gid: 74686
  user:
    name: photos_manager
    uid: 74686
    groups: "{{ immich.group.name }}"
  dir: "{{ storage.base_dir }}/photos"

  services:
    immich:
      enabled: true
      version: "release"
      port: 2283
      # Hardware acceleration for Pi 5
      hw_accel: "rkmpp"  # RK3588 hardware acceleration
      # Storage paths
      upload_location: "{{ storage.base_dir }}/photos/library"
      db_data_location: "{{ storage.appdata_dir }}/immich-db"
      ml_cache_location: "{{ storage.appdata_dir }}/immich-ml-cache"
      # OIDC/SSO Configuration (enabled when infrastructure.services.authentik.enabled is true)
      # Issuer URL uses auth.frey DNS (accessible via localdns Docker network)
      # NOTE: OAuth must be enabled in Immich UI: Administration → Settings → OAuth Authentication
      oidc_issuer_url: "https://auth.{{ network.domain_name }}/application/o/immich/"
      oidc_client_id: "immich"
      oidc_scope: "openid profile email"
      oidc_button_text: "Login with Authentik"
      oidc_auto_register: true
      oidc_auto_launch: false
      oidc_mobile_redirect_uri: "app.immich:/"
      oidc_signing_algorithm: "RS256"

# ===================================================================
# COOKBOOK - MEALIE RECIPE MANAGER
# ===================================================================
cookbook:
  group:
    name: cookbook
    gid: 74690
  user:
    name: cookbook_manager
    uid: 74690
    groups: "{{ cookbook.group.name }}"
  dir: "{{ storage.base_dir }}/cookbook"

  # Database credentials
  db_user: mealie
  db_password: "{{ mealie_db_password }}"
  db_name: mealie

  services:
    mealie:
      enabled: true
      version: "latest"
      port: 9900
      ports:
        - "9900:9000"
      image: "hay-kot/mealie"
      # Database
      db_type: "postgres"
      # Storage paths
      data_dir: "{{ storage.appdata_dir }}/mealie/data"
      db_data_location: "{{ storage.appdata_dir }}/mealie/db"
      container_uid: 911
      container_gid: 911
      postgres_uid: 999
      postgres_gid: 999
      # API settings
      api_docs: true
      base_url: "https://cookbook.{{ network.domain_name }}"
      # Security
      allow_signup: false
      # SSO Configuration
      oidc_enabled: true
      oidc_client_id: "mealie"
      oidc_configuration_url: "https://auth.{{ network.domain_name }}/application/o/mealie/.well-known/openid-configuration"
      oidc_user_group: "mealie_users"
      oidc_admin_group: "mealie_admins"
      oidc_auto_redirect: false
      oidc_provider_name: "Authentik"
      oidc_signup_enabled: true
      oidc_remember_me: true
      # Features
      enable_meal_planner: true
      recipe_scraping: true

# ===================================================================
# HOME ASSISTANT - HOME AUTOMATION PLATFORM
# ===================================================================
homeassistant:
  group:
    name: homeassistant
    gid: 8123
  user:
    name: homeassistant_manager
    uid: 8123
    groups: "{{ homeassistant.group.name }}"
  dir: "{{ storage.base_dir }}/homeassistant"

  services:
    homeassistant:
      enabled: true  # Enable after initial setup
      version: "stable"
      image: "ghcr.io/home-assistant/home-assistant:{{ homeassistant.services.homeassistant.version | default('stable') }}"
      port: 8123
      # OIDC/SSO Configuration (enabled when infrastructure.services.authentik.enabled is true)
      # NOTE: OIDC must be configured manually in Home Assistant UI
      # Settings → Users → Add Integration → OpenID Connect
      oidc_issuer_url: "{{ network.authentik_public_url }}/application/o/homeassistant/"
      oidc_client_id: "homeassistant"

    piper:
      enabled: true  # Text-to-Speech via Wyoming protocol
      version: "latest"
      image: "rhasspy/wyoming-piper:{{ homeassistant.services.piper.version | default('latest') }}"
      port: 10200
      default_voice: "en_US-lessac-medium"
      voices:
        - "en_US-lessac-medium"
        - "en_AU-southern-female"

    wyoming_whisper:
      enabled: true  # Speech-to-Text (optional, resource-intensive)
      version: "latest"
      image: "rhasspy/wyoming-whisper:{{ homeassistant.services.wyoming_whisper.version | default('latest') }}"
      port: 10300
      model: "tiny-int8"  # tiny-int8, base-int8, small-int8
      language: "en"

# ===================================================================
# SYSTEM - SYSTEM-LEVEL OPTIMIZATIONS
# ===================================================================
system:
  power_monitoring:
    enabled: false  # Enable for 12V battery-powered setups
    low_threshold: 11.8
    critical_threshold: 11.0
    enable_graceful_shutdown: false

  ssd_optimization:
    enabled: false  # Enable if running on SSD
    trim: true

# ===================================================================
# BLUETOOTH AUDIO - AUTOMATIC DEVICE CONNECTION
# ===================================================================
bluetooth_audio:
  enabled: true  # Enable for Bluetooth audio support

  # Automatic connection settings
  auto_connect: true
  scan_interval: 10  # seconds between device scans

  # Paired devices (populated by frey-bluetooth-pair script)
  devices: []
    # Example devices (add via frey-bluetooth-pair):
    # - name: "Headphones"
    #   mac_address: "AA:BB:CC:DD:EE:FF"
    #   priority: 100  # Higher = more preferred
    #   profiles: [a2dp_sink, hsp_hs]  # Audio output + microphone
    # - name: "Car Radio"
    #   mac_address: "11:22:33:44:55:66"
    #   priority: 50
    #   profiles: [a2dp_sink]  # Audio output only

  # Audio routing configuration
  audio_routing:
    default_sink: "bluetooth"    # bluetooth | local | auto
    fallback_to_local: true      # Use Pi speakers if no Bluetooth connected
    auto_switch: true            # Automatically switch to Bluetooth when connected

  # Home Assistant integration
  homeassistant:
    integration: true                  # Enable MQTT sensors/controls
    tts_to_bluetooth: true             # Route Piper TTS to Bluetooth speakers
    voice_from_bluetooth: true         # Use Bluetooth mic for Whisper STT
    mqtt_topic: "frey/bluetooth"       # MQTT topic prefix

  # Connection settings
  connection:
    retry_attempts: 3
    retry_delay: 5           # seconds between retries
    connection_timeout: 15   # seconds to wait for connection

# ===================================================================
# BACKUP - AUTOMATED BACKUP SYSTEM
# ===================================================================
backup:
  enabled: false  # Enable after initial setup
  schedule:
    minute: "0"
    hour: "3"  # 3 AM daily
  retention_days: 7
  backup_dir: "{{ storage.base_dir }}/backups"
