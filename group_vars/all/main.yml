---
# ================================
# FEATURE TOGGLES
# ================================
features:
  infrastructure: true
  networking: true
  wifi_access_point: true
  media: true
  monitoring: true
  automation: true
  file_management: false
  photo_management: false
  homeassistant: false
  backup: false
  piper: false
  cookbook: false
  power_monitoring: false
  voice_assistant: false

# ================================
# CONFIGURATION
# ================================
users:
  default: 
    name: else
    uid: 1000
    gid: 1000
  docker:
    name: docker
    uid: 362537
    groups: docker



# ================================
# STORAGE PATHS
# ================================
storage:
  base_dir: /opt/frey
  appdata_dir: "{{ storage.base_dir }}/appdata"
  stacks: "{{ storage.base_dir }}/stacks"

# ==============================================================================
# ROLE: INFRASTRUCTURE & NETWORKING
# ==============================================================================
network:
  domain_name: frey
  timezone: Australia/Hobart
  wifi:
    # Network identification
    ssid: "FreyHub"                 # Network name visible to clients
    password: "{{ wifi_ap.password }}"  # Password from secrets.yml
    
    # Geographic settings (affects channels and power levels)
    country: "AU"                   # Two-letter country code
    
    # Network configuration
    ip: "10.20.0.1"                # AP's IP address
    network: "10.20.0.0/24"        # Network subnet for WiFi clients
    dhcp_range_start: "10.20.0.50" # Start of DHCP address pool
    dhcp_range_end: "10.20.0.150"  # End of DHCP address pool
    
    # Interface configuration
    interface: "wlan1"             # WiFi interface for AP mode
    client_interface: "eth0"       # Interface for internet connection
    client_interface_ip: "192.168.0.251" # Client interface IP
    
    # WiFi radio settings
    channel: 7                     # WiFi channel (1-11 for 2.4GHz)
    hw_mode: g                     # g = 2.4GHz band
    ieee80211n: 1                  # Enable 802.11n features
    wmm_enabled: 1                 # Enable WiFi multimedia (QoS)
    
    # Security settings
    macaddr_acl: 0                 # MAC address filtering
    auth_algs: 1                   # WPA authentication
    ignore_broadcast_ssid: 0       # Broadcast SSID

  # DNS Service Resolution
  dns_rewrites:
    # Infrastructure services
    - name: traefik
    - name: portainer
    - name: dockge
    # Monitoring services
    - name: grafana
    - name: prometheus
    - name: metrics     # node-exporter
    - name: cadvisor
    - name: speedtest
    - name: uptime-kuma
    # Media services
    - name: jellyfin
    - name: sonarr
    - name: radarr
    - name: bazarr
    - name: audiobookshelf
    - name: qbittorrent
    - name: prowlarr
    - name: immich
    - name: cookbook
    - name: jellyseerr
    - name: lidarr
    - name: jellystat


# ==============================================================================
# SECURITY SETTINGS
# ==============================================================================
security:
  fail2ban:
    enable: true
  ufw:
    enable: true
  ssh_port: 22
  firewall_tcp_ports: "{{
    [security.ssh_port, ports.infrastructure.dockge] +
    (features.infrastructure | ternary([
      ports.infrastructure.traefik, 
      ports.infrastructure.traefik_dashboard, 
      ports.infrastructure.portainer
    ], [])) +
    (features.media | ternary([
      media.services.jellyfin.port,
      media.services.sonarr.port,
      media.services.radarr.port,
      media.services.bazarr.port,
      media.services.audiobookshelf.port,
      media.services.qbittorrent.port,
      media.services.prowlarr.port,
      media.services.jellyseerr.port,
      media.services.lidarr.port,
      media.services.jellystat.port
    ], [])) +
    (features.automation | ternary([
      automation.ollama.port,
      automation.openwebui.port,
      automation.n8n.port
    ], [])) +
    (features.photo_management | ternary([
      ports.photos_home.immich
    ], [])) +
    (features.homeassistant | ternary([
      ports.photos_home.homeassistant
    ], [])) +
    (features.monitoring | ternary([
      ports.monitoring.grafana, 
      ports.monitoring.prometheus, 
      ports.monitoring.uptime_kuma, 
      ports.network_tools.speedtest
    ], [])) +
    (features.networking | ternary([
      ports.network_tools.adguardhome
    ], [])) +
    (features.file_management | ternary([
      ports.file_management.filebrowser, 
      ports.file_management.code_server
    ], [])) +
    (features.cookbook | ternary([
      ports.cookbook.cookbook
    ], [])) +
    (features.voice_assistant | ternary([
      ports.voice_assistant.piper
    ], []))
    }}"

# ==============================================================================
# OPTIMIZATION SETTINGS
# ==============================================================================
optimization:
  ssd:
    enable: false
    trim: true
  german_content:
    locale: de_DE.UTF-8
    enable_indexers: true

# ==============================================================================
# POWER MANAGEMENT (12V setup)
# ==============================================================================
power:
  low_threshold: 11.8
  critical_threshold: 11.0
  enable_graceful_shutdown: false

# ================================
# AUTOMATION SETTINGS
# ================================
automation:
  watchtower_interval: 86400 #?
  backup_retention_days: 7  #?
  group:
    name: automation
    gid: 2886
  user:
    name: automation_manager
    uid: 463288672
    groups: "{{ automation.group.name }}"
  dir: "{{ storage.base_dir }}/automation"

  ollama:
    port: 11434
  openwebui:
    port: 3002
  n8n:
    port: 5678

# ================================
# VOICE ASSISTANT
# ================================
voice_assistant:
  deploy: false
  wake_word: "frey"
  porcupine_access_key: "YOUR_PICOVOICE_ACCESS_KEY"
  ollama_model: "llama3:latest"
  piper_voice: "en_US-lessac-medium"
  piper_voices:
    - "en_US-lessac-medium"
    - "en_AU-southern-female"
    - "de_DE-thorsten-medium"


monitoring:
  group:
    name: monitoring
    gid: 12341
  user:
    name: monitoring_manager
    uid: 12341
    groups: "{{ monitoring.group.name }}"
  dir: "{{ storage.base_dir }}/monitoring"
  dockge:
    enabled: true
    port: 5001
    image: "louislam/dockge"
    version: 1
  prometheus:
    enabled: true
    port: 9090
    image: "prom/prometheus"
    version: "latest"
  node-exporter:
    enabled: true
    port: 9100
    image: "prom/node-exporter"
    version: "latest"
  cadvisor:
    enabled: true
    port: 8081
    image: "gcr.io/cadvisor/cadvisor"
    version: "latest"
  grafana:
    enabled: true
    port: 3000
    image: "grafana/grafana"
    version: "latest"
  loki:
    enabled: true
    port: 3100
    image: "grafana/loki"
    version: "latest"
  promtail:
    enabled: true
    image: "grafana/promtail"
    version: "latest"
  uptime-kuma:
    enabled: true
    port: 3001
    image: "louislam/uptime-kuma"
    version: 1
  watchtower:
    enabled: true
    image: "containrrr/watchtower"
    version: "latest"
  speedtest-tracker:
    enabled: true
    port: 8181
    image: "lscr.io/linuxserver/speedtest-tracker"
    version: "latest"


# ===================================================================
# INFRASTRUCTURE - REFACTORED FOR DYNAMIC COMPOSE GENERATION
# ===================================================================
infrastructure:
  group:
    name: infrastructure
    gid: 46372
  user:
    name: infrastructure_manager
    uid: 46372
    groups: "{{ infrastructure.group.name }}"
  dir: "{{ storage.base_dir }}/infrastructure"
  services:
    traefik:
      enabled: true
      version: "latest"
      ports:
        http: 80
        https: 443
        dashboard: 8082
    portainer:
      enabled: true
      version: "latest"
      ports:
        http: 9000
    dockge:
      enabled: true
      version: "1"
      ports:
        http: 5001

# ===================================================================
# MEDIA STACK - REFACTORED FOR DYNAMIC COMPOSE GENERATION
# ===================================================================
media:
  group:
    name: media
    gid: 63342
  user:
    name: media_manager
    uid: 63342
    groups: "{{ media.group.name }}"
  dir: "{{ storage.base_dir }}/media"
  downloads: "{{ storage.base_dir }}/downloads"

  network:
    name: "media_network"
    subnet: "10.20.0.0/24" # TODO probably unnessecarry 
    gateway: "10.20.0.1"

  vpn:
    enabled: false
    port: 8888

  services:
    audiobookshelf:
      enabled: true
      version: "latest"
      port: 80  # Internal container port for Traefik routing
      ports:
        - 13378:80  # External:Internal port mapping

    jellyfin:
      enabled: true
      version: "latest"
      port: 8096
    
    jellyseerr:
      enabled: true
      version: "latest"
      port: 5055
    
    qbittorrent:
      enabled: true
      version: "latest"
      port: 8080
      ports: 
       - "{{ media.vpn.port }}:{{ media.vpn.port }}"
       - 8080:8080 # Web UI
       - 6881:6881 # Torrent Port

    nzbget:
      enabled: true
      version: "latest"
      port: 6789

    prowlarr:
      enabled: true
      version: "latest"
      port: 9696

    flaresolverr:
      enabled: true
      version: "latest"
      port: 8191

    sonarr:
      enabled: true
      version: "latest"
      port: 8989

    radarr:
      enabled: true
      version: "latest"
      port: 7878

    bazarr:
      enabled: true
      version: "latest"
      port: 6767

    lidarr:
      enabled: true
      version: "latest"
      port: 8686
        
    audiobookrequest:
      enabled: true
      version: "latest"
      port: 5432

    jellystat:
      enabled: false
      version: "latest"
      port: 8086

    jellystat_db:
      enabled: "{{ media.services.jellystat.enabled }}" # Jellystat dependency
      version: 15
      image: "postgres"
      environment:
        - "POSTGRES_DB=jellystat"
        - "POSTGRES_USER=jellystat"
        - "POSTGRES_PASSWORD=jellystat"

    ytdl-sub:
      enabled: false
      version: "latest"

