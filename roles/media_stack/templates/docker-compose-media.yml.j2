version: '3.8'

services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    user: "{{ media_uid }}:{{ media_gid }}"
    restart: unless-stopped
    ports:
      - "{{ jellyfin_port }}:8096"
    volumes:
      - "{{ appdata_dir }}/jellyfin:/config"
      - "{{ media_dir }}:/media"
      - /opt/vc/lib:/opt/vc/lib
    environment:
      - JELLYFIN_PublishedServerUrl=http://{{ ansible_host }}:{{ jellyfin_port }}
    devices:
      - /dev/vcsm-cma:/dev/vcsm-cma
      - /dev/vchiq:/dev/vchiq
    group_add:
      - "video"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.{{ domain_name }}`)"
      - "traefik.http.routers.jellyfin.entrypoints=web"
      - "traefik.http.services.jellyfin.loadbalancer.server.port={{ jellyfin_port }}"
    networks:
      - default
      - infrastructure_network

  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    ports:
      - "{{ sonarr_port }}:8989"
    volumes:
      - "{{ appdata_dir }}/sonarr:/config"
      - "{{ media_dir }}/tv:/tv"
      - "{{ downloads_dir }}:/downloads"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}

  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    ports:
      - "{{ radarr_port }}:7878"
    volumes:
      - "{{ appdata_dir }}/radarr:/config"
      - "{{ media_dir }}/movies:/movies"
      - "{{ downloads_dir }}:/downloads"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}

  readarr:
    image: linuxserver/readarr:develop
    container_name: readarr
    restart: unless-stopped
    ports:
      - "{{ readarr_port }}:8787"
    volumes:
      - "{{ appdata_dir }}/readarr:/config"
      - "{{ media_dir }}/audiobooks:/audiobooks"
      - "{{ downloads_dir }}:/downloads"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}

  bazarr:
    image: linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    ports:
      - "{{ bazarr_port }}:6767"
    volumes:
      - "{{ appdata_dir }}/bazarr:/config"
      - "{{ media_dir }}/movies:/movies"
      - "{{ media_dir }}/tv:/tv"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    restart: unless-stopped
    ports:
      - "{{ audiobookshelf_port }}:80"
    volumes:
      - "{{ appdata_dir }}/audiobookshelf:/config"
      - "{{ media_dir }}/audiobooks:/audiobooks"
      - "{{ media_dir }}/music:/music"
    environment:
      - AUDIOBOOKSHELF_UID={{ media_uid }}
      - AUDIOBOOKSHELF_GID={{ media_gid }}

  qbittorrent:
    image: linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    ports:
      - "{{ qbittorrent_port }}:8080"
      - "6881:6881"
      - "6881:6881/udp"
    volumes:
      - "{{ appdata_dir }}/qbittorrent:/config"
      - "{{ downloads_dir }}:/downloads"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
      - WEBUI_PORT={{ qbittorrent_port }}

  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    ports:
      - "{{ prowlarr_port }}:9696"
    volumes:
      - "{{ appdata_dir }}/prowlarr:/config"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}

  audiobookrequest:
    image: ghcr.io/markbeep/audiobookrequest:latest
    container_name: audiobookrequest
    restart: unless-stopped
    ports:
      - "{{ audiobookrequest_port }}:3000"
    volumes:
      - "{{ appdata_dir }}/audiobookrequest:/config"
      - "{{ media_dir }}/audiobooks:/audiobooks"
      - "{{ downloads_dir }}:/downloads"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.audiobookrequest.rule=Host(`audiobookrequest.{{ domain_name }}`)"
      - "traefik.http.routers.audiobookrequest.entrypoints=web"
      - "traefik.http.services.audiobookrequest.loadbalancer.server.port=3000"

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    ports:
      - "{{ jellyseerr_port }}:5055"
    volumes:
      - "{{ appdata_dir }}/jellyseerr:/app/config"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
      - LOG_LEVEL=info
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyseerr.rule=Host(`jellyseerr.{{ domain_name }}`)"
      - "traefik.http.routers.jellyseerr.entrypoints=web"
      - "traefik.http.services.jellyseerr.loadbalancer.server.port=5055"
    networks:
      - default
      - infrastructure_network

  lidarr:
    image: linuxserver/lidarr:latest
    container_name: lidarr
    restart: unless-stopped
    ports:
      - "{{ lidarr_port }}:8686"
    volumes:
      - "{{ appdata_dir }}/lidarr:/config"
      - "{{ media_dir }}/music:/music"
      - "{{ downloads_dir }}:/downloads"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lidarr.rule=Host(`lidarr.{{ domain_name }}`)"
      - "traefik.http.routers.lidarr.entrypoints=web"
      - "traefik.http.services.lidarr.loadbalancer.server.port=8686"
    networks:
      - default
      - infrastructure_network

  jellystat:
    image: cyfershep/jellystat:latest
    container_name: jellystat
    restart: unless-stopped
    ports:
      - "{{ jellystat_port }}:8080"
    volumes:
      - "{{ appdata_dir }}/jellystat:/config"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellystat.rule=Host(`jellystat.{{ domain_name }}`)"
      - "traefik.http.routers.jellystat.entrypoints=web"
      - "traefik.http.services.jellystat.loadbalancer.server.port=8080"
    networks:
      - default
      - infrastructure_network

networks:
  default:
    name: media_network
  infrastructure_network:
    external: true
    name: infrastructure_network