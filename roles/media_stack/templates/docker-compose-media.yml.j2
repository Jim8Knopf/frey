networks:
  proxy:
    external: true

services:
  jellyfin:
    image: linuxserver/jellyfin:latest
    container_name: jellyfin
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
    volumes:
      - "{{ media_stack.appdata_dir }}/jellyfin:/config"
      - "{{ media_stack.media_dir }}:/data/media"
    ports:
      - "{{ media_stack.jellyfin.port }}:8096"
    networks: [proxy]
    restart: unless-stopped

  sonarr:
    image: linuxserver/sonarr:latest
    container_name: show_downloader
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
    volumes:
      - "{{ media_stack.appdata_dir }}/sonarr:/config"
      - "{{ media_stack.downloads_dir }}:/downloads"
      - "{{ media_stack.media_dir }}/tv:/tv"
    ports:
      - "{{ media_stack.sonarr.port }}:8989"
    networks: [proxy]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.sonarr.entrypoints=web"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"

  radarr:
    image: linuxserver/radarr:latest
    container_name: movie_downloader
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
    volumes:
      - "{{ media_stack.appdata_dir }}/radarr:/config"
      - "{{ media_stack.downloads_dir }}:/downloads"
      - "{{ media_stack.media_dir }}/movies:/movies"
    ports:
      - "{{ media_stack.radarr.port }}:7878"
    networks: [proxy]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.radarr.rule=Host(`radarr.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.radarr.entrypoints=web"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"

  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: indexer_manager
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
    volumes:
      - "{{ media_stack.appdata_dir }}/prowlarr:/config"
    ports:
      - "{{ media_stack.prowlarr.port }}:9696"
    networks: [proxy]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.prowlarr.entrypoints=web"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"

  qbittorrent:
    image: linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
      - WEBUI_PORT={{ media_stack.qbittorrent.port }}
    volumes:
      - "{{ media_stack.appdata_dir }}/qbittorrent:/config"
      - "{{ media_stack.downloads_dir }}:/downloads"
    ports:
      - "{{ media_stack.qbittorrent.port }}:{{ media_stack.qbittorrent.port }}"
      - "6881:6881"
      - "6881:6881/udp"
    networks: [proxy]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qbittorrent.rule=Host(`qbittorrent.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.qbittorrent.entrypoints=web"
      - "traefik.http.services.qbittorrent.loadbalancer.server.port={{ media_stack.qbittorrent.port }}"

  bazarr:
    image: linuxserver/bazarr:latest
    container_name: subtitle_manager
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
    volumes:
      - "{{ media_stack.appdata_dir }}/bazarr:/config"
      - "{{ media_stack.media_dir }}/movies:/movies"
      - "{{ media_stack.media_dir }}/tv:/tv"
    ports:
      - "{{ media_stack.bazarr.port }}:6767"
    networks: [proxy]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bazarr.rule=Host(`bazarr.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.bazarr.entrypoints=web"
      - "traefik.http.services.bazarr.loadbalancer.server.port=6767"

  lidarr:
    image: linuxserver/lidarr:latest
    container_name: music_downloader
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
    volumes:
      - "{{ media_stack.appdata_dir }}/lidarr:/config"
      - "{{ media_stack.downloads_dir }}:/downloads"
      - "{{ media_stack.media_dir }}/music:/music"
    ports:
      - "{{ media_stack.lidarr.port }}:8686"
    networks: [proxy]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lidarr.rule=Host(`lidarr.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.lidarr.entrypoints=web"
      - "traefik.http.services.lidarr.loadbalancer.server.port=8686"

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: tv_and_movie_request_manager
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
      - LOG_LEVEL=info
    volumes:
      - "{{ media_stack.appdata_dir }}/jellyseerr:/app/config"
    ports:
      - "{{ media_stack.jellyseerr.port }}:5055"
    networks: [proxy]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyseerr.rule=Host(`jellyseerr.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.jellyseerr.entrypoints=web"
      - "traefik.http.services.jellyseerr.loadbalancer.server.port=5055"

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
    volumes:
      - "{{ media_stack.appdata_dir }}/audiobookshelf/config:/config"
      - "{{ media_stack.appdata_dir }}/audiobookshelf/metadata:/metadata"
      - "{{ media_stack.media_dir }}/audiobooks:/audiobooks"
      - "{{ media_stack.media_dir }}/podcasts:/podcasts"
    ports:
      - "{{ media_stack.audiobookshelf.port }}:80"
    networks: [proxy]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.audiobookshelf.rule=Host(`audiobookshelf.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.audiobookshelf.entrypoints=web"
      - "traefik.http.services.audiobookshelf.loadbalancer.server.port=80"

  audiobookrequest:
    image: markbeep/audiobookrequest:latest
    ports:
      - "{{ media_stack.audiobookrequest.port }}:5432"
    volumes:
      - ./config:/config
    environment:
      ABR_APP__PORT: 5432
      ABR_APP__OPENAPI_ENABLED: true
    networks: [proxy]
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.audiobookrequest.rule=Host(`audiobookrequest.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.audiobookrequest.entrypoints=web"
      - "traefik.http.services.audiobookrequest.loadbalancer.server.port=80"


# Fixed Jellystat configuration
  jellystat:
    image: cyfershepard/jellystat:latest
    container_name: jellystat
    environment:
      - PUID={{ media_stack.media_uid }}
      - PGID={{ media_stack.media_gid }}
      - TZ={{ media_stack.timezone }}
      # Required environment variables for Jellystat
      - POSTGRES_USER=jellystat
      - POSTGRES_PASSWORD={{ media_stack.postgres.default_password }}
      - POSTGRES_IP=jellystat-db
      - POSTGRES_PORT=5432
      - POSTGRES_DATABASE=jfstat
      - JWT_SECRET={{ media_stack.tandoor.secret_key }}  # Reusing existing secret
    volumes:
      - "{{ media_stack.appdata_dir }}/jellystat:/app/backend/backup-data"
    ports:
      - "{{ media_stack.jellystat.port }}:3000"
    networks: [proxy]
    restart: unless-stopped
    depends_on:
      - jellystat-db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellystat.rule=Host(`jellystat.{{ media_stack.domain_name }}`)"
      - "traefik.http.routers.jellystat.entrypoints=web"
      - "traefik.http.services.jellystat.loadbalancer.server.port=3000"

  # PostgreSQL database for Jellystat
  jellystat-db:
    image: postgres:15-alpine
    container_name: jellystat-db
    environment:
      - POSTGRES_DB=jfstat
      - POSTGRES_USER=jellystat
      - POSTGRES_PASSWORD={{ media_stack.postgres.default_password }}
    volumes:
      - "{{ media_stack.appdata_dir }}/jellystat-db:/var/lib/postgresql/data"
    networks: [proxy]
    restart: unless-stopped