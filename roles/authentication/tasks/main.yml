---
# Authentication Stack Deployment (LLDAP + Authelia)

- name: Include common user creation tasks
  include_tasks: templates/create_user.yml
  vars:
    stack: authentication
    folders:
      - lldap
      - authelia
    checkVar:
      - authentication

- name: Ensure auth_network Docker network exists
  community.docker.docker_network:
    name: auth_network
    driver: bridge
    state: present

- name: Check OIDC secrets
  ansible.builtin.assert:
    that:
      - "(vars[item.name ~ '_oidc_secret'] | default('')) | length > 0"
    success_msg: "Secret defined for {{ item.name }}"
    fail_msg: "Define {{ item.name }}_oidc_secret in group_vars/all/secrets.yml"
  loop: "{{ authentication.oidc_clients }}"
  loop_control:
    label: "{{ item.name }}"

- name: Template Authelia configuration
  template:
    src: authelia-configuration.yml.j2
    dest: "{{ storage.appdata_dir }}/authelia/configuration.yml"
    owner: "{{ authentication.user.name }}"
    group: "{{ authentication.group.name }}"
    mode: '0600'
  notify: Restart authelia

- name: Template LLDAP configuration
  template:
    src: lldap_config.toml.j2
    dest: "{{ storage.appdata_dir }}/lldap/lldap_config.toml"
    owner: "{{ authentication.user.name }}"
    group: "{{ authentication.group.name }}"
    mode: '0600'

- name: Template docker-compose file for authentication stack
  template:
    src: docker-compose-authentication.yml.j2
    dest: "{{ authentication.dir }}/docker-compose.yml"
    owner: "{{ authentication.user.name }}"
    group: "{{ authentication.group.name }}"
    mode: '0644'
  register: auth_compose_template

- name: Validate docker-compose syntax
  command: docker compose -f {{ authentication.dir }}/docker-compose.yml config --quiet
  changed_when: false
  failed_when: false
  register: auth_compose_validation

- name: Display validation results
  debug:
    msg: "Docker Compose validation {{ 'passed' if auth_compose_validation.rc == 0 else 'failed' }}"

- name: Deploy authentication stack
  block:
    - name: Pull Docker images for authentication stack
      community.docker.docker_image:
        name: "{{ item.image }}"
        source: pull
        state: present
      loop:
        - { image: "lldap/lldap:{{ authentication.services.lldap.version }}" }
        - { image: "authelia/authelia:{{ authentication.services.authelia.version }}" }
      retries: 3
      delay: 10
      register: auth_pull_result
      until: auth_pull_result is not failed

    - name: Deploy authentication stack with docker compose
      community.docker.docker_compose_v2:
        project_src: "{{ authentication.dir }}"
        state: present
        pull: always
      register: auth_deploy_result

    - name: Display authentication stack deployment status
      ansible.builtin.debug:
        msg: >-
          Authentication deploy changed={{ auth_deploy_result.changed }};
          Containers: {%- for c in auth_deploy_result.containers | default([]) -%}
          {{ c.Name }}={{ c.Status }}{%- if not loop.last %}, {% endif -%}
          {%- endfor -%}

    - name: Wait for LLDAP to be healthy
      command: docker inspect --format='{% raw %}{{.State.Health.Status}}{% endraw %}' lldap
      register: lldap_health
      until: lldap_health.stdout == 'healthy'
      retries: 30
      delay: 10
      changed_when: false

    - name: Wait for Authelia to be healthy
      command: docker inspect --format='{% raw %}{{.State.Health.Status}}{% endraw %}' authelia
      register: authelia_health
      until: authelia_health.stdout == 'healthy'
      retries: 5
      delay: 10
      changed_when: false

    - name: Check LLDAP admin login
      ansible.builtin.uri:
        url: "http://localhost:{{ authentication.services.lldap.port }}/auth/simple/login"
        method: POST
        headers:
          Content-Type: application/json
        body_format: json
        body:
          username: "{{ authentication.services.lldap.admin_username }}"
          password: "{{ lldap_admin_password }}"
        status_code: 200
      register: lldap_login_check
      changed_when: false
      failed_when: false

    - name: Reset LLDAP admin password when login fails
      block:
        - name: Stop LLDAP container (if running)
          community.docker.docker_container:
            name: lldap
            state: stopped
          ignore_errors: true

        - name: Run one-time LLDAP admin password reset
          ansible.builtin.command: >
            docker run --rm
            -v {{ storage.appdata_dir }}/lldap:/data
            -e LLDAP_LDAP_BASE_DN="{{ authentication.services.lldap.base_dn }}"
            -e LLDAP_LDAP_USER_DN="{{ authentication.services.lldap.admin_username }}"
            -e LLDAP_LDAP_USER_PASS="{{ lldap_admin_password }}"
            -e LLDAP_JWT_SECRET="{{ lldap_jwt_secret }}"
            -e LLDAP_KEY_SEED="{{ lldap_key_seed }}"
            lldap/lldap:{{ authentication.services.lldap.version }}
            run --config-file /data/lldap_config.toml --force-ldap-user-pass-reset true
          register: lldap_reset_result
          changed_when: true
          failed_when:
            - lldap_reset_result.rc != 0
            - "lldap_reset_result.rc != 1 or 'Successfully (re)set password' not in lldap_reset_result.stdout"

        - name: Start LLDAP container after reset
          community.docker.docker_container:
            name: lldap
            state: started

        - name: Wait for LLDAP to be healthy after reset
          command: docker inspect --format='{% raw %}{{.State.Health.Status}}{% endraw %}' lldap
          register: lldap_health_after_reset
          until: lldap_health_after_reset.stdout == 'healthy'
          retries: 10
          delay: 5
          changed_when: false
      when: lldap_login_check.status | default(0) != 200

    - name: Copy LLDAP group creation script to remote
      ansible.builtin.copy:
        src: create_lldap_groups.py
        dest: /tmp/create_lldap_groups.py
        mode: '0755'

    - name: Install Python requests package
      ansible.builtin.package:
        name: python3-requests
        state: present

    - name: Create LLDAP groups
      ansible.builtin.shell:
        cmd: >
          python3 /tmp/create_lldap_groups.py
          http://localhost:17170
          admin
          '{{ lldap_admin_password }}'
          {{ authentication.ldap_groups | map(attribute='name') | join(' ') }}
      register: lldap_groups_result
      changed_when: (lldap_groups_result.stdout | from_json).changed
      failed_when: lldap_groups_result.rc != 0

    - name: Display group results
      ansible.builtin.debug:
        msg: "{{ (lldap_groups_result.stdout | from_json).msg }}"
      when: lldap_groups_result.stdout | default('') != ''

  rescue:
    - name: Get recent logs
      command: "docker logs {{ item }} --tail 20"
      register: container_logs
      failed_when: false
      loop:
        - lldap
        - authelia

    - name: Show error summary
      debug:
        msg: |
          Authentication deployment failed. Recent logs:
          {% for result in container_logs.results %}
          === {{ result.item }} ===
          {{ result.stdout_lines | last | default('No output') }}
          {% endfor %}

    - name: Fail deployment
      fail:
        msg: "Check logs: docker logs lldap && docker logs authelia"
