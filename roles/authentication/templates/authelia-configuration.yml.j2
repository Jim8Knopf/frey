---
# Authelia Configuration
# Docs: https://www.authelia.com/configuration/prologue/introduction/

server:
  host: 0.0.0.0
  port: 9091

log:
  level: {{ authentication.services.authelia.log_level }}
  format: text

theme: dark

totp:
  disable: false
  issuer: {{ network.domain_name }}

# Session configuration
session:
  name: authelia_session
  domain: {{ network.domain_name }}
  same_site: lax
  expiration: 1h
  inactivity: 5m
  remember_me_duration: 1M

# Storage backend (SQLite for simplicity)
storage:
  local:
    path: /config/db.sqlite3

# Notification provider (file-based for now, can be extended to SMTP)
notifier:
  filesystem:
    filename: /config/notification.txt

# Authentication backend (LLDAP)
authentication_backend:
  password_reset:
    disable: false

  refresh_interval: 5m

  ldap:
    implementation: lldap
    url: ldap://lldap:3890
    timeout: 5s
    start_tls: false

    # Base DN and search
    base_dn: {{ authentication.services.lldap.base_dn }}
    username_attribute: uid
    additional_users_dn: ou=people
    users_filter: (&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))

    # Groups
    additional_groups_dn: ou=groups
    groups_filter: (member={dn})
    group_name_attribute: cn

    # Attributes
    mail_attribute: mail
    display_name_attribute: displayName

    # Service account for LDAP queries
    user: uid={{ authentication.services.lldap.admin_username }},ou=people,{{ authentication.services.lldap.base_dn }}
    password: {{ lldap_admin_password }}

# Access control rules
access_control:
  default_policy: deny

  rules:
    # Allow access to all services for authenticated users in allowed groups
    - domain:
        - "*.{{ network.domain_name }}"
      policy: {{ authentication.services.authelia.default_policy }}
      subject:
        - "group:admin_users"
        - "group:media_users"
        - "group:monitoring_users"
        - "group:automation_users"

    # Public access to landing page
    - domain:
        - "{{ network.domain_name }}"
      policy: bypass

# Identity Providers (OIDC)
identity_providers:
  oidc:
    # HMAC secret for signing tokens
    hmac_secret: {{ authelia_oidc_hmac_secret }}

    # Private key for signing JWT tokens (RS256)
    issuer_private_key: |
{{ authelia_oidc_private_key | indent(6, first=True) }}

    # Access token lifespan
    access_token_lifespan: 1h
    authorize_code_lifespan: 1m
    id_token_lifespan: 1h
    refresh_token_lifespan: 90m

    # Enable PKCE
    enable_client_debug_messages: false
    enforce_pkce: public_clients_only

    # CORS settings
    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins:
        - https://{{ network.domain_name }}
      allowed_origins_from_client_redirect_uris: true

    # OIDC clients
    clients:
{% for client in authentication.oidc_clients %}
      # {{ client.description }}
      - id: {{ client.name }}
        description: {{ client.description }}
        secret: {{ lookup('vars', client.name ~ '_oidc_secret_hash') }}
        public: false
        authorization_policy: {{ authentication.services.authelia.default_policy }}
        redirect_uris:
{% for uri in client.redirect_uris %}
          - {{ uri }}
{% endfor %}
        scopes:
{% for scope in client.scopes %}
          - {{ scope }}
{% endfor %}
        grant_types:
          - authorization_code
          - refresh_token
        response_types:
          - code
        response_modes:
          - form_post
          - query
          - fragment
        userinfo_signing_algorithm: none

{% endfor %}
