---
- name: Setup media stack user
  include_tasks: "templates/create_user.yml"
  vars:
    stack: "media"  
    folders: [movies, tv, music, audiobooks, podcasts,audiobook-bridge]
    checkVar: [media, storage.base_dir, media.user.name]


- name: Pre-pull all enabled media stack images
  community.docker.docker_image:
    name: "{{ item.value.image }}"
    source: pull
    state: present
    timeout: 300
  loop: "{{ media.services | dict2items }}"
  loop_control:
    label: "{{ item.value.image | default(item.key) }}"
  when:
    - item.value.enabled | default(false)
    - item.value.image is defined
    - item.key not in ['mopidy', 'audiobook_bridge', 'jellystat_db']
  register: image_pull_results
  retries: 2
  delay: 10
  failed_when: false

- name: Set failed pulls fact
  ansible.builtin.set_fact:
    failed_pulls: "{{ image_pull_results.results | default([]) | select('failed') | map(attribute='item.value.image') | list }}"

- name: Report failed image pulls
  ansible.builtin.debug:
    msg: "Warning: Failed to pull the following images: {{ failed_pulls }}. Will retry during compose."
  when: failed_pulls | length > 0

- name: Deploy audiobook bridge playback script
  ansible.builtin.template:
    src: audiobook-bridge/play_book.py.j2
    dest: "{{ storage.appdata_dir }}/audiobook-bridge/play_book.py"
    owner: "{{ media.user.name }}"
    group: "{{ media.group.name }}"
    mode: '0755'
  when: media.services.audiobook_bridge.enabled | default(false)

- name: Warn when Audiobookshelf API token is missing (disables audiobook-bridge integration)
  ansible.builtin.debug:
    msg: "audiobookshelf_api_token not defined ‚Äî audiobook-bridge will deploy without API token. Add it to group_vars/all/secrets.yml to enable Audiobookshelf sync. Get token from Audiobookshelf Settings ‚Üí Users ‚Üí [Your User] ‚Üí API Tokens."
  when:
    - media.services.audiobook_bridge.enabled | default(false)
    - audiobookshelf_api_token is not defined

# ==============================================================================
# STEP-CA CERTIFICATE MOUNT FIX
# ==============================================================================
# Fix broken directory mounts caused by Docker creating directories when
# certificate files don't exist yet. This happens when containers start
# before Step-CA has generated certificates.

- name: Check Step-CA root certificate file status
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
  register: step_ca_cert_check
  when: media.services.audiobookshelf.enabled | default(false)

- name: Remove broken Step-CA cert directory mount (Docker created dir instead of file)
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
    state: absent
  when:
    - media.services.audiobookshelf.enabled | default(false)
    - step_ca_cert_check.stat.exists | default(false)
    - step_ca_cert_check.stat.isdir | default(false)

- name: Warn when Step-CA certificate not available for Audiobookshelf OIDC
  ansible.builtin.debug:
    msg: "Step-CA certificate not found ‚Äî Audiobookshelf will deploy without CA trust. OIDC to https://auth.{{ network.domain_name }} may fail. Run playbook again after Step-CA initializes to add certificate mount."
  when:
    - media.services.audiobookshelf.enabled | default(false)
    - infrastructure.services.step_ca.enabled | default(false)
    - not (step_ca_cert_check.stat.exists | default(false) and step_ca_cert_check.stat.isreg | default(false))

- name: Set fact for Step-CA cert availability
  ansible.builtin.set_fact:
    step_ca_cert_available: "{{ step_ca_cert_check.stat.exists | default(false) and step_ca_cert_check.stat.isreg | default(false) }}"
  when: media.services.audiobookshelf.enabled | default(false)

- name: Deploy media stack compose file
  ansible.builtin.template:
    src: docker-compose-media.yml.j2
    dest: "{{ storage.stacks }}/media/docker-compose.yml"
    owner: "{{ media.user.name }}"
    group: "{{ media.group.name }}"
    mode: '0644'
    backup: yes
  register: compose_template_result

- name: Ensure media Docker network exists
  vars:
    media_network_cfg: "{{ media.network | default({}) }}"
    media_network_ipam: >-
      {{
        (
          [
            {
              'subnet': media_network_cfg.subnet
            }
            | combine(
                (
                  {'gateway': media_network_cfg.gateway}
                  if (media_network_cfg.gateway is defined)
                  else {}
                ),
                recursive=True
              )
          ]
        )
        if (media_network_cfg.subnet is defined)
        else []
      }}
  community.docker.docker_network:
    name: "{{ media_network_cfg.name | default('media_network') }}"
    driver: "{{ media_network_cfg.driver | default('bridge') }}"
    state: present
    ipam_config: "{{ media_network_ipam | default(omit) }}"

- name: Ensure downloads directory exists with proper permissions
  ansible.builtin.file:
    path: "{{ media.downloads }}"
    state: directory
    owner: "{{ media.user.name }}"
    group: "{{ media.group.name }}"
    mode: '0775'

- name: Check if qBittorrent container exists
  community.docker.docker_container_info:
    name: "{{ media.services.qbittorrent.container_name }}"
  register: qbittorrent_container_info
  when: not media.vpn.enabled
  ignore_errors: true

- name: Stop qBittorrent container before config modification
  community.docker.docker_container:
    name: "{{ media.services.qbittorrent.container_name }}"
    state: stopped
  when:
    - not media.vpn.enabled
    - qbittorrent_container_info.exists is defined
    - qbittorrent_container_info.exists

- name: Ensure qBittorrent config directory exists
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/qbittorrent/qBittorrent"
    state: directory
    owner: "{{ media.user.name }}"
    group: "{{ media.group.name }}"
    mode: '0775'
  when: not media.vpn.enabled

- name: Deploy optimized qBittorrent configuration (only if not exists)
  ansible.builtin.template:
    src: qBittorrent.conf.j2
    dest: "{{ storage.appdata_dir }}/qbittorrent/qBittorrent/qBittorrent.conf"
    owner: "{{ media.user.name }}"
    group: "{{ media.group.name }}"
    mode: '0644'
    force: no
  when: not media.vpn.enabled

- name: Start qBittorrent container after config modification
  community.docker.docker_container:
    name: "{{ media.services.qbittorrent.container_name }}"
    state: started
  when:
    - not media.vpn.enabled
    - qbittorrent_container_info.exists is defined
    - qbittorrent_container_info.exists

- name: Show rendered compose
  ansible.builtin.shell: |
    nl -ba /opt/frey/stacks/media/docker-compose.yml
  register: compose_snippet
  when: debug_enabled | default(false) | bool

- debug:
    var: compose_snippet.stdout_lines
  when: debug_enabled | default(false) | bool

- name: Validate Docker Compose file syntax
  ansible.builtin.command:
    cmd: docker compose -f "{{ storage.stacks }}/media/docker-compose.yml" config --quiet
  register: compose_validation
  failed_when: compose_validation.rc != 0
  changed_when: false

- name: Ensure Step-CA root certificate is present for media mounts
  block:
    - name: Check Step-CA root certificate source
      ansible.builtin.stat:
        path: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
      register: media_step_ca_src

    - name: Remove invalid Step-CA root source when it's a directory
      ansible.builtin.file:
        path: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
        state: absent
      when:
        - media_step_ca_src.stat.isdir | default(false)
          or (media_step_ca_src.stat.exists | default(false)
              and (media_step_ca_src.stat.size | default(0) == 0))

    - name: Check Step-CA root certificate target
      ansible.builtin.stat:
        path: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
      register: media_step_ca_dest

    - name: Remove invalid Step-CA root target when it's a directory
      ansible.builtin.file:
        path: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
        state: absent
      when:
        - media_step_ca_dest.stat.isdir | default(false)
          or (media_step_ca_dest.stat.exists | default(false)
              and (media_step_ca_dest.stat.size | default(0) == 0))

    - name: Ensure Step-CA cert directory exists
      ansible.builtin.file:
        path: "{{ storage.appdata_dir }}/step-ca/certs"
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'

    - name: Try exporting Step-CA root certificate when missing
      ansible.builtin.command:
        cmd: docker exec step-ca step ca root
      register: media_step_ca_export
      changed_when: false
      failed_when: false
      when:
        - not media_step_ca_src.stat.exists | default(false)

    - name: Write exported Step-CA root certificate when available
      ansible.builtin.copy:
        dest: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
        content: "{{ media_step_ca_export.stdout }}"
        owner: "{{ infrastructure.user.name }}"
        group: "{{ infrastructure.group.name }}"
        mode: '0644'
      when:
        - not media_step_ca_src.stat.exists | default(false)
        - media_step_ca_export.rc == 0
        - media_step_ca_export.stdout is defined
        - media_step_ca_export.stdout | length > 0

    - name: Re-check Step-CA root certificate source
      ansible.builtin.stat:
        path: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
      register: media_step_ca_src

    - name: Copy Step-CA root certificate for media mounts
      ansible.builtin.copy:
        src: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
        dest: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
        owner: 1000
        group: 1000
        mode: '0644'
        remote_src: true
      when: media_step_ca_src.stat.exists | default(false)

    - name: Fail early when Step-CA root certificate is missing
      ansible.builtin.fail:
        msg: "Step-CA root certificate missing at {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}. Run the infrastructure role to generate it, then re-run media."
      when: not media_step_ca_src.stat.exists | default(false)

    - name: Verify Step-CA root certificate is a file
      ansible.builtin.stat:
        path: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
      register: media_step_ca_verified
      failed_when: not media_step_ca_verified.stat.isreg
  when: media.services.audiobookshelf.enabled | default(false)

- name: Start media stack with graceful error handling
  block:
    - name: Start media stack containers using compose
      community.docker.docker_compose_v2:
        project_src: "{{ storage.stacks }}/media"
        state: present
        remove_orphans: true
        timeout: 300
      register: compose_result
      retries: 2
      delay: 30

  rescue:
    - name: Identify failed containers
      ansible.builtin.shell: |
        docker compose -f "{{ storage.stacks }}/media/docker-compose.yml" ps --format '{% raw %}{{.Service}} {{.State}}{% endraw %}' \
        | awk '$2 != "running" {printf "%s(%s) ", $1, $2}' | sed 's/ $//'
      register: failed_containers
      failed_when: false

    - name: Extract concise error message from compose failure
      ansible.builtin.set_fact:
        error_summary: >-
          {% if compose_result.msg is defined %}
          {{ compose_result.msg | regex_search('error mounting.*', ignorecase=True) | default(compose_result.msg | truncate(200)) }}
          {% else %}
          Unknown deployment error
          {% endif %}

    - name: Show deployment error summary
      ansible.builtin.debug:
        msg: |
          ‚ùå Media stack deployment failed

          Failed containers: {{ failed_containers.stdout | default('none identified') }}

          Error: {{ error_summary }}

          üí° Common fixes:
             ‚Ä¢ Step-CA cert issue: Re-run playbook after infrastructure role completes
             ‚Ä¢ Volume mount errors: Check 'docker ps -a' and remove broken containers
             ‚Ä¢ Full logs: docker compose -f {{ storage.stacks }}/media/docker-compose.yml logs

    - name: Fail with concise message
      ansible.builtin.fail:
        msg: "Media deployment failed - see summary above"
