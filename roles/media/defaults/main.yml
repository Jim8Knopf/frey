---
# ==============================================================================
# MEDIA ROLE - DEFAULT VARIABLES
# ==============================================================================

# Network Architecture:
# - All web services are accessed through Traefik (proxy network)
# - Inter-container communication uses localdns network
# - Media services are isolated in their own network (10.20.0.0/24)
# - Direct port access should be avoided unless absolutely necessary
# - VPN routing through gluetun for torrent-related services when enabled

media:
  group:
    name: media
    gid: 63342
  user:
    name: media_manager
    uid: 63342
    groups: "{{ media.group.name }}"
  dir: "{{ storage.base_dir }}/media"
  downloads: "{{ storage.base_dir }}/downloads"

  network:
    name: "media_network"
    subnet: "10.20.7.0/24"  # Media services subnet
    gateway: "10.20.7.1"

  # DNS resolvers used by media stack containers (avoids relying on host DNS)
  dns_servers:
    - 1.1.1.1
    - 1.0.0.1

  vpn:
    enabled: false
    port: 8888

  services:
    audiobookshelf:
      enabled: true
      version: "latest"
      image: "ghcr.io/advplyr/audiobookshelf"
      port: 80  # Internal container port for Traefik routing
      ports:
        - 13378:80  # External:Internal port mapping
      volumes:
        - "{{ storage.appdata_dir }}/audiobookshelf:/config"
        - "{{ media.dir }}/audiobooks:/audiobooks"
        - "{{ media.dir }}/podcasts:/podcasts"
        # Trust Step-CA root for outbound TLS to Authentik (OIDC discovery)
        - "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt:/etc/ssl/certs/step-ca.crt:ro"
      environment:
        # Ensure Node trusts Step-CA when calling https://auth.frey
        - "NODE_EXTRA_CA_CERTS=/etc/ssl/certs/step-ca.crt"
      # OIDC/SSO Configuration (enabled when infrastructure.services.authentik.enabled is true)
      # NOTE: Audiobookshelf OIDC CANNOT be configured via environment variables
      # Must be configured manually via web UI: Settings → Authentication → OpenID Connect
      # Use these values when configuring in UI:
      oidc_issuer_url: "{{ network.authentik_public_url }}/application/o/audiobookshelf/"
      oidc_client_id: "audiobookshelf"
      # Client secret is in secrets.yml: audiobookshelf_oidc_client_secret
      oidc_button_text: "Login with Authentik"
      oidc_auto_register: true
      oidc_auto_launch: false

    jellyfin:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/jellyfin"
      port: 8096
      volumes:
        - "{{ storage.appdata_dir }}/jellyfin:/config"
        - "{{ media.dir }}/tv:/data/tvshows"
        - "{{ media.dir }}/movies:/data/movies"
      # LDAP Configuration (enabled when infrastructure.services.authentik.enabled is true)
      # Requires LDAP Authentication plugin from Jellyfin catalog (installed manually via UI)
      # Plugin location: Dashboard > Plugins > Catalog > "LDAP Authentication"
      # Uses internal Docker service name for reliable communication across networks
      # NOTE: Configuration is managed via XML file (plugin doesn't support env vars)
      ldap_server: "ak-outpost-jellyfin-ldap-outpost"
      ldap_port: 3389                # Authentik LDAP outpost uses non-standard port 3389 (not 389)
      ldap_use_ssl: false            # No SSL for internal Docker network communication
      ldap_use_starttls: false       # No STARTTLS needed
      ldap_skip_ssl_verify: false    # N/A when SSL disabled
      ldap_base_dn: "dc=ldap,dc=goauthentik,dc=io"
      # Authentik LDAP outpost uses uid as the RDN for users; DN must use uid
      ldap_bind_user: "uid=ldap_bind,ou=users,dc=ldap,dc=goauthentik,dc=io"
      ldap_search_filter: "(uid=*)"  # Rely on Authentik provider search_group to restrict users
      ldap_admin_base_dn: ""         # Same as ldap_base_dn (empty uses default)
      ldap_admin_filter: "(memberOf=cn=jellyfin_admins,ou=groups,dc=ldap,dc=goauthentik,dc=io)"
      # User creation and library access settings
      ldap_create_users: true        # Auto-create Jellyfin users on first LDAP login
      ldap_enable_all_folders: true  # Grant LDAP users access to all media libraries
      # LDAP attribute mappings (standard Authentik LDAP schema)
      ldap_search_attributes: "uid, cn, mail, displayName"
      ldap_uid_attribute: "uid"
      ldap_username_attribute: "uid"
      ldap_password_attribute: "userPassword"
      ldap_allow_pass_change: false  # Users change passwords in Authentik, not Jellyfin

    jellyseerr:
      enabled: true
      version: "latest"
      port: 5055

    qbittorrent:
      enabled: true
      version: "latest"
      port: 8080
      listen_port: 51234  # Torrent peer connection port (TCP/UDP)
      ports:
        - "8080:8080"    # Web UI
        - "51234:51234/tcp"    # Torrent Port
        - "51234:51234/udp"    # Torrent Port

    nzbget:
      enabled: true
      version: "latest"
      port: 6789

    prowlarr:
      enabled: true
      version: "latest"
      port: 9696

    flaresolverr:
      enabled: true
      version: "latest"
      port: 8191

    sonarr:
      enabled: true
      version: "latest"
      port: 8989

    radarr:
      enabled: true
      version: "latest"
      port: 7878

    bazarr:
      enabled: true
      version: "latest"
      port: 6767

    lidarr:
      enabled: true
      version: "latest"
      port: 8686

    audiobookrequest:
      enabled: true
      version: "latest"
      port: 5432

    jellystat:
      enabled: false
      version: "latest"
      port: 8086

    jellystat_db:
      enabled: "{{ media.services.jellystat.enabled }}" # Jellystat dependency
      version: 15
      image: "postgres"
      environment:
        - "POSTGRES_DB=jellystat"
        - "POSTGRES_USER=jellystat"
        - "POSTGRES_PASSWORD=jellystat"

    ytdl-sub:
      enabled: false
      version: "latest"

    mopidy:
      enabled: false  # DISABLED: No ARM64-compatible image available
      # TODO: Build custom ARM64 Mopidy image or use alternative music player
      # For now, use Jellyfin directly for music playback
      version: "latest"
      image: "wernight/mopidy"  # Note: Only supports AMD64
      port: 6680  # Required for pre-pull task (web interface port)
      mpd_port: 6600  # MPD protocol for Home Assistant integration
      http_port: 6680  # Web interface

    audiobook_bridge:
      enabled: true  # Enable for local audiobook playback with progress sync
      version: "3.11-slim"
      image: "python"
      port: 0  # No port exposed (internal service only)
      sync_interval: 5  # Progress sync interval in seconds
