---
# Media Services Configuration
# Following the network architecture guide at roles/wifi_access_point/network-architecture-guide.md

# Network Architecture:
# - All web services are accessed through Traefik (proxy network)
# - Inter-container communication uses localdns network
# - Media services are isolated in their own network (10.20.0.0/24)
# - Direct port access should be avoided unless absolutely necessary
# - VPN routing through gluetun for torrent-related services when enabled

media:
  group:
    name: media
    gid: 63342
  user:
    name: media_manager
    uid: 63342
    groups: "{{ media.group.name }}"
  dir: "{{ storage.base_dir }}/media"
  downloads: "{{ storage.base_dir }}/downloads"

  network:
    name: "media_network"
    subnet: "10.20.7.0/24"  # Media services subnet
    gateway: "10.20.2.1"

  vpn:
    enabled: false
    port: 8888

  services:
    audiobookshelf:
      enabled: true
      verion: "latest"
      image: "ghcr.io/advplyr/audiobookshelf"
      container_name: "audiobookshelf"
      port: 13378    # Container's internal port for Traefik 
      ports: 
        - 13378:80
      volumes:
        - "{{ storage.appdata_dir }}/audiobookshelf:/config"
        - "{{ media.dir }}/audiobooks:/audiobooks"
        - "{{ media.dir }}/podcasts:/podcasts"

    jellyfin:
      enabled: true
      verion: "latest"
      image: "lscr.io/linuxserver/jellyfin"
      container_name: "jellyfin"
      port: 8096   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/jellyfin:/config"
        - "{{ media.dir }}/tv:/data/tvshows"
        - "{{ media.dir }}/movies:/data/movies"
        - "{{ media.dir }}/music:/data/music"

    jellyseerr:
      enabled: true
      verion: "latest"
      image: "fallenbagel/jellyseerr"
      container_name: "jellyseerr"
      port: 5055   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/jellyseerr:/app/config"
      environment:
        - JELLYFIN_TYPE=jellyfin
        - JELLYFIN_URL=http://jellyfin:{{ media.services.jellyfin.port }}

    qbittorrent:
      enabled: true
      verion: "latest"
      image: "lscr.io/linuxserver/qbittorrent"
      container_name: "qbittorrent"
      port: 8080   # Container's internal port for Traefik
      ports: 
        - "{{ media.vpn.port }}:{{ media.vpn.port }}"  # VPN port
        - "8080:8080"    # Web UI
        - "51234:51234/tcp"    # Torrent Port
        - "51234:51234/udp"    # Torrent Port
      volumes:
        - "{{ storage.appdata_dir }}/qbittorrent:/config"
        - "{{ media.downloads }}:/downloads"
      environment:
        - "WEBUI_PORT=8080"
        
    nzbget:
      enabled: true
      verion: "latest"
      image: "lscr.io/linuxserver/nzbget"
      container_name: "nzbget"
      port: 6789   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/nzbget:/config"
        - "{{ media.downloads }}:/downloads"
        - /data:/data
        - /etc/localtime:/etc/localtime:ro
        - ./nzbget:/config      #TODO

    prowlarr:
      enabled: true
      verion: "latest"
      image: "lscr.io/linuxserver/prowlarr"
      container_name: "prowlarr"
      port: 9696   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/prowlarr:/config"

    flaresolverr:
      enabled: true
      verion: "latest"
      image: "ghcr.io/flaresolverr/flaresolverr"
      container_name: "flaresolverr"
      port: 8191   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/prowlarr:/config"
      environment:
        - LOG_LEVEL=${LOG_LEVEL:-info}
        - LOG_HTML=${LOG_HTML:-false}
        - CAPTCHA_SOLVER=${CAPTCHA_SOLVER:-none}

    sonarr:
      enabled: true
      verion: "latest"
      image: "lscr.io/linuxserver/sonarr"
      container_name: "sonarr"
      port: 8989   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/sonarr:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ media.dir }}/tv:/tv"

    radarr:
      enabled: true
      verion: "latest"
      image: "lscr.io/linuxserver/radarr"
      container_name: "radarr"
      port: 7878   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/radarr:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ media.dir }}/movies:/movies"

    bazarr:
      enabled: true
      verion: "latest"
      image: "lscr.io/linuxserver/bazarr"
      container_name: "bazarr"
      port: 6767   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/bazarr:/config"
        - "{{ media.dir }}/movies:/movies"
        - "{{ media.dir }}/tv:/tv"

    lidarr:
      enabled: true
      verion: "latest"
      image: "lscr.io/linuxserver/lidarr"
      container_name: "lidarr"
      port: 8686   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/lidarr:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ media.dir }}/music:/music"

    audiobookrequest:
      enabled: true
      verion: "latest"
      image: "markbeep/audiobookrequest"
      container_name: "audiobookrequest"
      port: 5432
      volumes:
        - ./config:/config
      environment:
        - "ABR_APP__PORT={{ media.services.audiobookrequest.port }}"
        - "ABR_APP__OPENAPI_ENABLED=true"

    jellystat:
      enabled: false
      verion: "latest"
      image: "cyfershep/jellystat"
      container_name: "jellystat"
      port: 8086
      volumes:
        - "{{ storage.appdata_dir }}/jellystat/config.json:/app/config/config.json"

    jellystat_db:
      enabled: "{{ media.services.jellystat.enabled }}" # Jellystat dependency
      version: 15
      image: "postgres"
      container_name: "jellystat-db"
      volumes:
        - "{{ storage.appdata_dir }}/jellystat/db:/var/lib/postgresql/data"
      environment:
        - "POSTGRES_DB=jellystat"
        - "POSTGRES_USER={{ media.services.jellystat.postgres.user }}"
        - "POSTGRES_PASSWORD={{ media.services.jellystat.postgres.password }}"

    ytdl-sub:
      enabled: false
      verion: "latest"
      image: "ghcr.io/jmbannon/ytdl-sub"
      container_name: "ytdl-sub"
      volumes:
        - "{{ storage.appdata_dir }}/ytdl-sub:/config"
        - "{{ media.downloads }}:/downloads"
