---
# ==============================================================================
# MEDIA ROLE - DEFAULT VARIABLES
# ==============================================================================

# Network Architecture:
# - All web services are accessed through Traefik (proxy network)
# - Inter-container communication uses localdns network
# - Media services are isolated in their own network (10.20.0.0/24)
# - Direct port access should be avoided unless absolutely necessary
# - VPN routing through gluetun for torrent-related services when enabled

media:
  group:
    name: media
    gid: 63342
  user:
    name: media_manager
    uid: 63342
    groups: "{{ media.group.name }}"
  dir: "{{ storage.base_dir }}/media"
  downloads: "{{ storage.base_dir }}/downloads"

  network:
    name: "media_network"
    subnet: "10.20.7.0/24"  # Media services subnet
    gateway: "10.20.7.1"

  # DNS resolvers used by media stack containers (avoids relying on host DNS)
  dns_servers:
    - 1.1.1.1
    - 1.0.0.1

  vpn:
    enabled: false
    port: 8888

  services:
    audiobookshelf:
      enabled: true
      version: "2.31.0"
      image: "ghcr.io/advplyr/audiobookshelf"
      container_name: "audiobookshelf"
      port: 13378    # External port for firewall/direct access
      internal_port: 80  # Container's internal port for Traefik
      ports:
        - 13378:80
      volumes:
        - "{{ storage.appdata_dir }}/audiobookshelf:/config"
        - "{{ media.dir }}/audiobooks:/audiobooks"
        - "{{ media.dir }}/podcasts:/podcasts"
        - "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt:/usr/local/share/ca-certificates/step-ca-root.crt:ro"
      environment:
        - "NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/step-ca-root.crt"

    jellyfin:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/jellyfin"
      container_name: "jellyfin"
      port: 8096   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/jellyfin:/config"
        - "{{ media.dir }}/tv:/data/tvshows"
        - "{{ media.dir }}/movies:/data/movies"
        - "{{ media.dir }}/music:/data/music"

    jellyseerr:
      enabled: true
      version: "latest"
      image: "fallenbagel/jellyseerr"
      container_name: "jellyseerr"
      port: 5055   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/jellyseerr:/app/config"
      environment:
        - JELLYFIN_TYPE=jellyfin
        - JELLYFIN_URL=http://jellyfin:{{ media.services.jellyfin.port }}

    qbittorrent:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/qbittorrent"
      container_name: "qbittorrent"
      listen_port: 51234
      port: 8080   # Container's internal port for Traefik
      ports:
        - "{{ media.vpn.port }}:{{ media.vpn.port }}"  # VPN port
        - "8080:8080"    # Web UI
        - "{{ media.services.qbittorrent.listen_port | default(51234) }}:{{ media.services.qbittorrent.listen_port | default(51234) }}/tcp"    # Torrent Port
        - "{{ media.services.qbittorrent.listen_port | default(51234) }}:{{ media.services.qbittorrent.listen_port | default(51234) }}/udp"    # Torrent Port
      volumes:
        - "{{ storage.appdata_dir }}/qbittorrent:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ monitoring.dir }}/logs/qbittorrent:/logs"
      environment:
        - "WEBUI_PORT=8080"
      # Smart healthcheck configuration
      # Monitors download activity and internet connectivity
      # Restarts container if no downloads for stall_threshold seconds despite having internet
      healthcheck:
        stall_threshold: 300      # Seconds of no downloads before restart (default: 5 minutes)
        internet_host: "1.1.1.1"  # Host to ping for internet check
        interval: "60s"           # How often to run healthcheck
        timeout: "10s"            # Healthcheck timeout
        retries: 3                # Failed checks before marking unhealthy
        start_period: "60s"       # Grace period after container start
        
    nzbget:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/nzbget"
      container_name: "nzbget"
      port: 6789   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/nzbget:/config"
        - "{{ media.downloads }}:/downloads"
        - /data:/data
        - /etc/localtime:/etc/localtime:ro
        - ./nzbget:/config      #TODO

    prowlarr:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/prowlarr"
      container_name: "prowlarr"
      port: 9696   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/prowlarr:/config"

    flaresolverr:
      enabled: true
      version: "latest"
      image: "ghcr.io/flaresolverr/flaresolverr"
      container_name: "flaresolverr"
      port: 8191   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/prowlarr:/config"
      environment:
        - LOG_LEVEL=${LOG_LEVEL:-info}
        - LOG_HTML=${LOG_HTML:-false}
        - CAPTCHA_SOLVER=${CAPTCHA_SOLVER:-none}

    sonarr:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/sonarr"
      container_name: "sonarr"
      port: 8989   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/sonarr:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ media.dir }}/tv:/tv"

    radarr:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/radarr"
      container_name: "radarr"
      port: 7878   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/radarr:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ media.dir }}/movies:/movies"

    bazarr:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/bazarr"
      container_name: "bazarr"
      port: 6767   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/bazarr:/config"
        - "{{ media.dir }}/movies:/movies"
        - "{{ media.dir }}/tv:/tv"

    lidarr:
      enabled: true
      version: "latest"
      image: "lscr.io/linuxserver/lidarr"
      container_name: "lidarr"
      port: 8686   # Container's internal port for Traefik
      volumes:
        - "{{ storage.appdata_dir }}/lidarr:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ media.dir }}/music:/music"

    audiobookrequest:
      enabled: true
      version: "latest"  # v2.31.0 tag was removed upstream
      image: "markbeep/audiobookrequest"
      container_name: "audiobookrequest"
      port: 5432
      volumes:
        - ./config:/config
      environment:
        - "ABR_APP__PORT={{ media.services.audiobookrequest.port }}"
        - "ABR_APP__OPENAPI_ENABLED=true"

    jellystat:
      enabled: false
      version: "latest"
      image: "cyfershepard/jellystat"
      port: 8086
      volumes:
        - "{{ storage.appdata_dir }}/jellystat/config.json:/app/config/config.json"
      postgres:
        user: "jellystat"
        password: "eGXqQKeW#Daq$BGYIJp784Qa1Z$OgAe%"

    jellystat_db:
      enabled: "{{ media.services.jellystat.enabled }}" # Jellystat dependency
      version: 15
      image: "postgres"
      container_name: "jellystat-db"
      volumes:
        - "{{ storage.appdata_dir }}/jellystat/db:/var/lib/postgresql/data"
      environment:
        - "POSTGRES_DB=jellystat"
        - "POSTGRES_USER={{ media.services.jellystat.postgres.user }}"
        - "POSTGRES_PASSWORD={{ media.services.jellystat.postgres.password }}"

    ytdl-sub:
      enabled: false
      version: "latest"
      image: "ghcr.io/jmbannon/ytdl-sub"
      container_name: "ytdl-sub"
      volumes:
        - "{{ storage.appdata_dir }}/ytdl-sub:/config"
        - "{{ media.downloads }}:/downloads"

    mopidy:
      enabled: false  # DISABLED: No ARM64-compatible image available
      # TODO: Build custom ARM64 Mopidy image or use alternative music player
      # For now, use Jellyfin directly for music playback
      version: "latest"
      image: "wernight/mopidy"  # Note: Only supports AMD64
      port: 6680  # Required for pre-pull task (web interface port)
      mpd_port: 6600  # MPD protocol for Home Assistant integration
      http_port: 6680  # Web interface

    audiobook_bridge:
      enabled: true  # Enable for local audiobook playback with progress sync
      version: "3.11-slim"
      image: "python"
      port: 0  # No port exposed (internal service only)
      sync_interval: 5  # Progress sync interval in seconds
