---
# Media Services Configuration
# Following the network architecture guide at roles/wifi_access_point/network-architecture-guide.md

# Network Architecture:
# - All web services are accessed through Traefik (proxy network)
# - Inter-container communication uses localdns network
# - Media services are isolated in their own network (10.20.0.0/24)
# - Direct port access should be avoided unless absolutely necessary
# - VPN routing through gluetun for torrent-related services when enabled

media:
  group:
    name: media
    gid: 63342
  user:
    name: media_manager
    uid: 63342
    groups: "{{ media.group.name }}"
  dir: "{{ storage.base_dir }}/media"
  downloads: "{{ storage.base_dir }}/downloads"

  network:
    name: "media_network"
    subnet: "10.20.7.0/24"  # Media services subnet
    gateway: "10.20.2.1"

  vpn:
    enabled: false
    port: 8888

  services:
    audiobookshelf:
      enabled: true
      image: "ghcr.io/advplyr/audiobookshelf:latest"
      container_name: "audiobookshelf"
      internal_ip: "10.20.2.50"
      port: 13378    # Container's internal port for Traefik (matching API port)
      ports:
        - "80:80"      # Main interface
        - "13378:13378"  # API port
      volumes:
        - "{{ storage.appdata_dir }}/audiobookshelf:/config"
        - "{{ media.dir }}/audiobooks:/audiobooks"
        - "{{ media.dir }}/podcasts:/podcasts"

    jellyfin:
      enabled: true
      image: "lscr.io/linuxserver/jellyfin:latest"
      container_name: "jellyfin"
      internal_ip: "10.20.2.10"
      port: 8096   # Container's internal port for Traefik
      ports:
        - "8096:8096"    # Main interface
      volumes:
        - "{{ storage.appdata_dir }}/jellyfin:/config"
        - "{{ media.dir }}/tv:/data/tvshows"
        - "{{ media.dir }}/movies:/data/movies"

    jellyseerr:
      enabled: true
      image: "fallenbagel/jellyseerr:latest"
      container_name: "jellyseerr"
      internal_ip: "10.20.2.40"
      port: 5055   # Container's internal port for Traefik
      ports:
        - "5055:5055"    # Web UI
      volumes:
        - "{{ storage.appdata_dir }}/jellyseerr:/app/config"
      environment:
        - JELLYFIN_TYPE=jellyfin
        - JELLYFIN_URL=http://jellyfin:8096

    qbittorrent:
      enabled: true
      image: "lscr.io/linuxserver/qbittorrent:latest"
      container_name: "qbittorrent"
      internal_ip: "10.20.2.30"
      port: 8080   # Container's internal port for Traefik
      ports: 
        - "{{ media.vpn.port }}:{{ media.vpn.port }}"  # VPN port
        - "8080:8080"    # Web UI
        - "6881:6881"    # Torrent Port
      volumes:
        - "{{ storage.appdata_dir }}/qbittorrent:/config"
        - "{{ media.downloads }}:/downloads"
      environment:
        - "WEBUI_PORT=8080"
        - "TORRENT_PORT=6881"
        - TORRENTING_PORT={{ media.vpn.port }}

    prowlarr:
      enabled: true
      image: "lscr.io/linuxserver/prowlarr:latest"
      container_name: "prowlarr"
      internal_ip: "10.20.2.22"
      port: 9696   # Container's internal port for Traefik
      ports:
        - "9696:9696"    # Web UI
      volumes:
        - "{{ storage.appdata_dir }}/prowlarr:/config"

    flaresolverr:
      enabled: true
      image: "ghcr.io/flaresolverr/flaresolverr:latest"
      container_name: "flaresolverr"
      internal_ip: "10.20.2.19"
      port: 8191   # Container's internal port for Traefik
      ports:
        - "8191:8191"    # Web UI
      volumes:
        - "{{ storage.appdata_dir }}/prowlarr:/config"
      environment:
        - LOG_LEVEL=${LOG_LEVEL:-info}
        - LOG_HTML=${LOG_HTML:-false}
        - CAPTCHA_SOLVER=${CAPTCHA_SOLVER:-none}

    sonarr:
      enabled: true
      image: "lscr.io/linuxserver/sonarr:latest"
      container_name: "sonarr"
      internal_ip: "10.20.2.20"
      port: 8989   # Container's internal port for Traefik
      ports:
        - "8989:8989"    # Web UI
      volumes:
        - "{{ storage.appdata_dir }}/sonarr:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ media.dir }}/tv:/tv"

    radarr:
      enabled: true
      image: "lscr.io/linuxserver/radarr:latest"
      container_name: "radarr"
      internal_ip: "10.20.2.21"
      port: 7878   # Container's internal port for Traefik
      ports:
        - "7878:7878"    # Web UI
      volumes:
        - "{{ storage.appdata_dir }}/radarr:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ media.dir }}/movies:/movies"

    bazarr:
      enabled: true
      image: "lscr.io/linuxserver/bazarr:latest"
      container_name: "bazarr"
      internal_ip: "10.20.2.23"
      port: 6767   # Container's internal port for Traefik
      ports:
        - "6767:6767"    # Web UI
      volumes:
        - "{{ storage.appdata_dir }}/bazarr:/config"
        - "{{ media.dir }}/movies:/movies"
        - "{{ media.dir }}/tv:/tv"

    lidarr:
      enabled: true
      image: "lscr.io/linuxserver/lidarr:latest"
      container_name: "lidarr"
      internal_ip: "10.20.2.24"
      port: 8686   # Container's internal port for Traefik
      ports:
        - "8686:8686"    # Web UI
      volumes:
        - "{{ storage.appdata_dir }}/lidarr:/config"
        - "{{ media.downloads }}:/downloads"
        - "{{ media.dir }}/music:/music"
        
    nzbget:
      enabled: true
      image: "lscr.io/linuxserver/nzbget:latest"
      container_name: "nzbget"
      internal_ip: "10.20.2.31"
      port: 6789   # Container's internal port for Traefik
      ports:
        - "6789:6789"    # Web UI
      volumes:
        - "{{ storage.appdata_dir }}/nzbget:/config"
        - "{{ media.downloads }}:/downloads"
        - /data:/data
        - /etc/localtime:/etc/localtime:ro
        - ./nzbget:/config

    audiobookrequest:
      enabled: true
      image: "markbeep/audiobookrequest:latest"
      container_name: "audiobookrequest"
      port: 5432
      internal_ip: "10.20.2.32"
      volumes:
        - ./config:/config
      environment:
        - "ABR_APP__PORT=5432"
        - "ABR_APP__OPENAPI_ENABLED=true"

    jellystat:
      enabled: false
      image: "cyfershep/jellystat:latest"
      container_name: "jellystat"
      port: 8086
      internal_ip: "10.20.2.60"
      volumes:
        - "{{ storage.appdata_dir }}/jellystat/config.json:/app/config/config.json"

    jellystat_db:
      enabled: false
      image: "postgres:15"
      container_name: "jellystat-db"
      internal_ip: "10.20.2.61"
      volumes:
        - "{{ storage.appdata_dir }}/jellystat/db:/var/lib/postgresql/data"
      environment:
        - "POSTGRES_DB=jellystat"
        - "POSTGRES_USER=jellystat"
        - "POSTGRES_PASSWORD=jellystat"

    ytdl-sub:
      enabled: false
      image: "ghcr.io/jmbannon/ytdl-sub:latest"
      container_name: "ytdl-sub"
      internal_ip: "10.20.2.70"
      volumes:
        - "{{ storage.appdata_dir }}/ytdl-sub:/config"
        - "{{ media.downloads }}:/downloads"
