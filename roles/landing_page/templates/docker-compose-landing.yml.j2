{% set landing_hosts = [landing_page.hostname] %}
{% if landing_page.alt_hostname is defined and landing_page.alt_hostname %}
{%   set landing_hosts = landing_hosts + [landing_page.alt_hostname] %}
{% endif %}
{% set landing_rule = landing_hosts | map('regex_replace', '^(.*)$', 'Host(`\\1`)') | join(' || ') %}
{% set services_json = landing_page.sections | to_json %}

networks:
  proxy:
    external: true
  localdns:
    external: true

services:
  landing:
    build:
      context: "{{ landing_page.app_dir }}"
      dockerfile: Dockerfile
    image: "frey-landing:latest"
    container_name: "{{ landing_page.container_name }}"
    restart: unless-stopped
    environment:
      - TZ={{ network.timezone }}
      - NODE_ENV=production
      - PORT={{ landing_page.port | default(8080) }}
      - OIDC_ISSUER={{ network.authentik_public_url }}/application/o/{{ landing_page.oidc.client_id }}/
      - OIDC_CLIENT_ID={{ landing_page.oidc.client_id }}
      - OIDC_REDIRECT_URI={{ landing_page.public_url }}/auth/callback
      - OIDC_SCOPE={{ landing_page.oidc.scope }}
      - SESSION_SECRET={{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}
      - SERVICES_CONFIG={{ services_json | to_json }}
      - WIFI_ENABLED={{ network.wifi.enabled | default(false) | lower }}
      - WIFI_SSID={{ network.wifi.ssid | default('') }}
    volumes:
      - "{{ landing_page.assets_dir }}:/app/public/assets:ro"
    networks:
      proxy: {}
      localdns: {}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.landing.rule={{ landing_rule }}"
      - "traefik.http.routers.landing.entrypoints=websecure"
      - "traefik.http.routers.landing.tls=true"
      - "traefik.http.routers.landing.tls.certresolver=step-ca"
      - "traefik.http.routers.landing.service=landing"
      - "traefik.http.services.landing.loadbalancer.server.port={{ landing_page.port | default(8080) }}"
      - "traefik.http.routers.landing-http.rule={{ landing_rule }}"
      - "traefik.http.routers.landing-http.entrypoints=web"
      - "traefik.http.routers.landing-http.service=landing"
