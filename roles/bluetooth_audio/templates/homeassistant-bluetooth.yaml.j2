# ==============================================================================
# HOME ASSISTANT BLUETOOTH INTEGRATION
# ==============================================================================
# Purpose: MQTT sensors and controls for Frey Bluetooth system
# Location: config/packages/bluetooth.yaml
#
# Generated by Ansible bluetooth_audio role
# ==============================================================================

# Enable packages (add this to configuration.yaml if not present)
# homeassistant:
#   packages: !include_dir_named packages/

# ==============================================================================
# MQTT SENSORS - Bluetooth Status
# ==============================================================================

mqtt:
  sensor:
    # Connected device name
    - name: "Frey Bluetooth Device"
      unique_id: frey_bluetooth_device_name
      state_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/device_name"
      icon: mdi:bluetooth-audio
      availability_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/daemon"
      payload_available: "running"
      payload_not_available: "stopped"

    # Device MAC address
    - name: "Frey Bluetooth Device MAC"
      unique_id: frey_bluetooth_device_mac
      state_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/device_mac"
      icon: mdi:bluetooth
      availability_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/daemon"

    # Device priority
    - name: "Frey Bluetooth Device Priority"
      unique_id: frey_bluetooth_device_priority
      state_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/priority"
      icon: mdi:sort-numeric-ascending
      unit_of_measurement: "priority"
      availability_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/daemon"

    # Scan interval
    - name: "Frey Bluetooth Scan Interval"
      unique_id: frey_bluetooth_scan_interval
      state_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/scan_interval"
      icon: mdi:timer
      unit_of_measurement: "seconds"
      availability_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/daemon"

  # ==============================================================================
  # BINARY SENSORS - Connection Status
  # ==============================================================================

  binary_sensor:
    # Device connected status
    - name: "Frey Bluetooth Connected"
      unique_id: frey_bluetooth_connected
      state_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/connected"
      payload_on: "true"
      payload_off: "false"
      device_class: connectivity
      icon: mdi:bluetooth-connect
      availability_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/daemon"

    # Devices available
    - name: "Frey Bluetooth Available"
      unique_id: frey_bluetooth_available
      state_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/available"
      payload_on: "true"
      payload_off: "false"
      device_class: connectivity
      icon: mdi:bluetooth-audio
      availability_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/daemon"

    # Daemon running
    - name: "Frey Bluetooth Daemon"
      unique_id: frey_bluetooth_daemon_status
      state_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/daemon"
      payload_on: "running"
      payload_off: "stopped"
      device_class: running
      icon: mdi:cog

    # Devices configured
    - name: "Frey Bluetooth Configured"
      unique_id: frey_bluetooth_configured
      state_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/configured"
      payload_on: "true"
      payload_off: "false"
      icon: mdi:check-circle
      availability_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/status/daemon"

# ==============================================================================
# CONTROLS - Manual Connection Management
# ==============================================================================

# Manual rescan trigger
button:
  - platform: mqtt
    name: "Frey Bluetooth Force Rescan"
    unique_id: frey_bluetooth_force_rescan
    command_topic: "{{ bluetooth_audio.homeassistant.mqtt_topic | default('frey/bluetooth') }}/control/rescan"
    payload_press: "true"
    icon: mdi:bluetooth-audio

# ==============================================================================
# TEMPLATE SENSORS - Enhanced Information
# ==============================================================================

template:
  - sensor:
      # Connection status text
      - name: "Frey Bluetooth Status"
        unique_id: frey_bluetooth_status_text
        state: >
          {% raw %}{% if states('binary_sensor.frey_bluetooth_connected') == 'on' %}
            Connected to {{ states('sensor.frey_bluetooth_device') }}
          {% elif states('binary_sensor.frey_bluetooth_available') == 'on' %}
            Available devices found
          {% elif states('binary_sensor.frey_bluetooth_configured') == 'off' %}
            No devices paired
          {% else %}
            Disconnected
          {% endif %}{% endraw %}
        icon: >
          {% raw %}{% if states('binary_sensor.frey_bluetooth_connected') == 'on' %}
            mdi:bluetooth-connect
          {% else %}
            mdi:bluetooth-off
          {% endif %}{% endraw %}

# ==============================================================================
# AUTOMATIONS - Bluetooth Event Handling
# ==============================================================================

automation:
  # Notification when Bluetooth device connects
  - id: frey_bluetooth_connected_notification
    alias: "Frey: Bluetooth Device Connected"
    trigger:
      - platform: state
        entity_id: binary_sensor.frey_bluetooth_connected
        from: "off"
        to: "on"
    action:
      - service: notify.persistent_notification
        data:
          title: "Bluetooth Connected"
          message: "{% raw %}Connected to {{ states('sensor.frey_bluetooth_device') }}{% endraw %}"

  # Notification when Bluetooth device disconnects
  - id: frey_bluetooth_disconnected_notification
    alias: "Frey: Bluetooth Device Disconnected"
    trigger:
      - platform: state
        entity_id: binary_sensor.frey_bluetooth_connected
        from: "on"
        to: "off"
    action:
      - service: notify.persistent_notification
        data:
          title: "Bluetooth Disconnected"
          message: "Bluetooth audio device disconnected"

{% if bluetooth_audio.homeassistant.tts_to_bluetooth | default(true) %}
  # Route TTS to Bluetooth when connected
  - id: frey_tts_to_bluetooth
    alias: "Frey: Route TTS to Bluetooth"
    trigger:
      - platform: state
        entity_id: binary_sensor.frey_bluetooth_connected
        to: "on"
    action:
      - service: notify.persistent_notification
        data:
          title: "Audio Routing Updated"
          message: "{% raw %}TTS will now play through {{ states('sensor.frey_bluetooth_device') }}{% endraw %}"
{% endif %}

# ==============================================================================
# DASHBOARD CARD CONFIGURATION (Optional)
# ==============================================================================

# Add this card to your dashboard:
#
# type: entities
# title: Frey Bluetooth Audio
# entities:
#   - entity: binary_sensor.frey_bluetooth_connected
#     name: Connection Status
#   - entity: sensor.frey_bluetooth_device
#     name: Connected Device
#   - entity: sensor.frey_bluetooth_status
#     name: Status
#   - type: divider
#   - entity: button.frey_bluetooth_force_rescan
#     name: Force Rescan
#   - type: divider
#   - entity: binary_sensor.frey_bluetooth_daemon
#     name: Auto-Connection Daemon
#   - entity: sensor.frey_bluetooth_scan_interval
#     name: Scan Interval

# ==============================================================================
# LOVELACE CARD - Bluetooth Media Player (Optional)
# ==============================================================================

# For media player controls, add this card:
#
# type: media-control
# entity: media_player.frey_bluetooth
#
# Note: Media player entity is created automatically by Home Assistant
#       when PulseAudio Bluetooth sink is detected
