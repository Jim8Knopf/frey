# ==============================================================================
# PULSEAUDIO DEFAULT CONFIGURATION
# ==============================================================================
# Location: /etc/pulse/default.pa
# Purpose: Load Bluetooth modules and configure audio routing
#
# Generated by Ansible bluetooth_audio role
# ==============================================================================

.fail

# Load core modules
.ifexists module-device-restore.so
load-module module-device-restore
.endif

.ifexists module-stream-restore.so
load-module module-stream-restore
.endif

.ifexists module-card-restore.so
load-module module-card-restore
.endif

# ==============================================================================
# AUDIO HARDWARE DETECTION
# ==============================================================================

# Detect PCI audio devices
.ifexists module-udev-detect.so
load-module module-udev-detect
.else
# Fallback: detect ALSA devices
.ifexists module-detect.so
load-module module-detect
.endif
.endif

# ==============================================================================
# BLUETOOTH SUPPORT
# ==============================================================================

# Load Bluetooth discover module (auto-detects Bluetooth audio devices)
.ifexists module-bluez5-discover.so
load-module module-bluez5-discover autodetect_mtu=yes
.endif

# Load Bluetooth policy module (handles device connections)
.ifexists module-bluetooth-policy.so
load-module module-bluetooth-policy auto_switch=2
.endif

# ==============================================================================
# AUTOMATIC AUDIO ROUTING
# ==============================================================================

{% if bluetooth_audio.audio_routing.auto_switch | default(true) %}
# Automatically switch to newly connected devices
load-module module-switch-on-connect
{% endif %}

# ==============================================================================
# NETWORK AUDIO (For Home Assistant, etc.)
# ==============================================================================

# Allow audio streaming over the network (for Home Assistant integration)
load-module module-native-protocol-unix auth-anonymous=1

# TCP network audio (commented out for security, enable if needed)
# load-module module-native-protocol-tcp auth-anonymous=1

# ==============================================================================
# EQUALIZER AND FILTERS
# ==============================================================================

# Load equalizer (optional, commented out by default)
# .ifexists module-equalizer-sink.so
# load-module module-equalizer-sink
# .endif

# ==============================================================================
# SESSION MANAGEMENT
# ==============================================================================

# Remember which sink/source was selected
.ifexists module-default-device-restore.so
load-module module-default-device-restore
.endif

# Save and restore stream volumes
load-module module-rescue-streams

# ==============================================================================
# AUTOMATIC DEVICE MANAGEMENT
# ==============================================================================

# Automatically suspend idle sinks/sources to save power
load-module module-suspend-on-idle timeout=5

# Detect when devices are added/removed
load-module module-udev-detect

# ==============================================================================
# POSITION EVENT SOUNDS
# ==============================================================================

# Position event sounds in space
load-module module-position-event-sounds

# ==============================================================================
# CORK MUSIC ON PHONE CALLS
# ==============================================================================

# Automatically cork (pause) music when a phone call starts
load-module module-role-cork

# ==============================================================================
# X11 INTEGRATION (if available)
# ==============================================================================

.ifexists module-x11-publish.so
.nofail
load-module module-x11-publish
.fail
.endif

# ==============================================================================
# CONSOLE KIT / SYSTEMD LOGIN SESSION TRACKING
# ==============================================================================

.ifexists module-console-kit.so
load-module module-console-kit
.endif

.ifexists module-systemd-login.so
load-module module-systemd-login
.endif

# ==============================================================================
# DEFAULT SINK/SOURCE CONFIGURATION
# ==============================================================================

{% if bluetooth_audio.audio_routing.default_sink == 'bluetooth' %}
# Prefer Bluetooth sink if available
# This is handled automatically by module-switch-on-connect
# No explicit configuration needed
{% elif bluetooth_audio.audio_routing.default_sink == 'local' %}
# Prefer local audio sink
set-default-sink 0
{% endif %}

# ==============================================================================
# ALLOW MODULE LOADING
# ==============================================================================

# Enable remote module loading (needed for dynamic configuration)
.nofail
load-module module-cli-protocol-unix
.fail

# ==============================================================================
# DONE
# ==============================================================================

.nofail
