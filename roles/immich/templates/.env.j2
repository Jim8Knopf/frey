# ==============================================================================
# IMMICH ENVIRONMENT VARIABLES (2025 Configuration)
# ==============================================================================
# This file configures the Immich photo backup server
# All passwords and secrets should be in secrets.yml
# ==============================================================================

# ------------------------------------------------------------------------------
# IMMICH VERSION
# ------------------------------------------------------------------------------
# Use 'release' for stable, or specific version like 'v1.117.0'
IMMICH_VERSION=release

# ------------------------------------------------------------------------------
# DATABASE CONFIGURATION (PostgreSQL with VectorChord)
# ------------------------------------------------------------------------------
DB_HOSTNAME=database
DB_PORT=5432
DB_USERNAME=immich
DB_PASSWORD={{ immich_db_password | default('changeThisSecurePassword123!') }}
DB_DATABASE_NAME=immich

# Vector extension - Auto-detected by Immich (VectorChord, pgvecto.rs, or pgvector)
# NOTE: Do NOT set DB_VECTOR_EXTENSION - Immich auto-detects the extension at startup
# The postgres image includes VectorChord which will be used automatically

# ------------------------------------------------------------------------------
# REDIS/VALKEY CONFIGURATION
# ------------------------------------------------------------------------------
# NOTE: 2025 uses Valkey (Redis fork), but variable name stays REDIS_HOSTNAME
REDIS_HOSTNAME=redis
REDIS_PORT=6379
REDIS_DBINDEX=0
REDIS_PASSWORD=

# ------------------------------------------------------------------------------
# UPLOAD & STORAGE PATHS
# ------------------------------------------------------------------------------
# These paths are configured in group_vars and mounted in docker-compose
UPLOAD_LOCATION={{ immich.services.immich.upload_location }}

# ------------------------------------------------------------------------------
# MACHINE LEARNING CONFIGURATION
# ------------------------------------------------------------------------------
# URL for ML service (internal Docker network)
IMMICH_MACHINE_LEARNING_URL=http://immich-machine-learning:3003

# Enable/disable specific ML features
MACHINE_LEARNING_ENABLED=true
MACHINE_LEARNING_CLIP_ENABLED=true
MACHINE_LEARNING_FACIAL_RECOGNITION_ENABLED=true

# Hardware acceleration for ML (Pi 5 RK3588)
# Options: cpu, armnn, cuda, openvino, rkmpp
# Note: Requires additional configuration in hwaccel.ml.yml
MACHINE_LEARNING_WORKER_DEVICE=cpu

# ------------------------------------------------------------------------------
# TIMEZONE & LOCALE
# ------------------------------------------------------------------------------
TZ={{ network.timezone | default('Australia/Hobart') }}
# Locale for date/time formatting (Alpine containers use C.UTF-8)
LC_ALL=C.UTF-8

# ------------------------------------------------------------------------------
# LOG LEVEL
# ------------------------------------------------------------------------------
# Options: verbose, debug, log, warn, error
LOG_LEVEL=log

# ------------------------------------------------------------------------------
# PUBLIC & SECURITY SETTINGS
# ------------------------------------------------------------------------------
# Allow public sharing of albums and photos
PUBLIC_LOGIN_PAGE_MESSAGE=Welcome to Immich on {{ ansible_hostname }}

# Telemetry disabled by default (opt-in only)
# To enable: Set IMMICH_TELEMETRY_INCLUDE to comma-separated list of: host,api,io,repo,job,all
# Leave unset to disable telemetry (privacy-friendly default)

# ------------------------------------------------------------------------------
# OIDC AUTHENTICATION (SSO with Authelia)
# ------------------------------------------------------------------------------
# Enable OIDC authentication for single sign-on
# Controlled by features.authentication flag
{% if features.authentication | default(false) %}
IMMICH_AUTH_TYPE=oidc
OIDC_ENABLED=true
OIDC_ISSUER_URL={{ immich.services.immich.oidc_issuer_url }}
OIDC_CLIENT_ID={{ immich.services.immich.oidc_client_id }}
OIDC_CLIENT_SECRET={{ immich_oidc_secret }}
OIDC_SCOPE={{ immich.services.immich.oidc_scope }}
OIDC_BUTTON_TEXT={{ immich.services.immich.oidc_button_text }}
OIDC_AUTO_REGISTER={{ immich.services.immich.oidc_auto_register }}
OIDC_AUTO_LAUNCH={{ immich.services.immich.oidc_auto_launch }}
OIDC_MOBILE_REDIRECT_URI_OVERRIDE={{ immich.services.immich.oidc_mobile_redirect_uri }}
OIDC_SIGNING_ALGORITHM={{ immich.services.immich.oidc_signing_algorithm }}
{% else %}
# OIDC authentication is disabled
# To enable: Set features.authentication: true in group_vars
{% endif %}

# ------------------------------------------------------------------------------
# REVERSE PROXY CONFIGURATION
# ------------------------------------------------------------------------------
# Trust proxy headers from Traefik
# This allows Immich to see real client IPs behind Traefik
IMMICH_TRUSTED_PROXIES=172.16.0.0/12,192.168.0.0/16,10.0.0.0/8

# ------------------------------------------------------------------------------
# JOB WORKERS & PERFORMANCE
# ------------------------------------------------------------------------------
# Number of concurrent workers for various tasks
# Adjust based on Pi 5 resources (4-core CPU, 4-8GB RAM)
IMMICH_WORKERS_INCLUDE=api,microservices

# Thumbnail generation quality (0-100, higher = better quality, more storage)
THUMBNAIL_QUALITY=80

# Video transcoding quality (Options: original, high, medium, low, very_low)
VIDEO_TRANSCODING_PRESET=medium

# ------------------------------------------------------------------------------
# BACKUP CONFIGURATION
# ------------------------------------------------------------------------------
# Automatic database backup schedule (cron format)
# Default: Daily at 2 AM
DB_BACKUP_SCHEDULE=0 2 * * *

# Number of backups to retain
DB_BACKUP_RETENTION_DAYS=14

# ------------------------------------------------------------------------------
# HARDWARE ACCELERATION (Video Transcoding)
# ------------------------------------------------------------------------------
# NOTE: Pi 5 RK3588 supports hardware video encoding/decoding
# Uncomment and set to 'rkmpp' if you configure hwaccel.transcoding.yml
# IMMICH_WORKERS_INCLUDE=api,microservices,video-transcoding
# VIDEO_TRANSCODING_HARDWARE_ACCEL=rkmpp

# ==============================================================================
# NOTES
# ==============================================================================
#
# FIRST-TIME SETUP:
# 1. Immich will initialize database on first start (may take 2-3 minutes)
# 2. Access web UI at http://immich.{{ network.domain_name }}
# 3. Create admin account (this becomes your main account)
# 4. Configure mobile app with server URL
#
# SECURITY:
# - Change DB_PASSWORD in secrets.yml
# - Keep this .env file secure (contains credentials)
# - Consider enabling HTTPS via Traefik for external access
#
# PERFORMANCE TUNING:
# - For 4GB Pi 5: Keep defaults
# - For 8GB Pi 5: Can increase worker counts
# - Monitor with: docker stats immich_server
#
# TROUBLESHOOTING:
# - Logs: docker compose logs -f immich-server
# - Database: docker compose logs -f database
# - ML: docker compose logs -f immich-machine-learning
# ==============================================================================
