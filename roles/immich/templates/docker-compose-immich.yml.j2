# ==============================================================================
# IMMICH PHOTO BACKUP SERVER - Docker Compose Configuration (2025)
# ==============================================================================
# Self-hosted photo and video backup solution with Google Photos-like interface
#
# FEATURES:
# - Automatic photo/video backup from mobile apps (iOS/Android)
# - AI-powered face recognition and smart search
# - Hardware-accelerated video transcoding (Pi 5 RK3588)
# - Multi-user support with album sharing
# - Timeline view with EXIF data and location
# - Automatic organization and duplicate detection
#
# ARCHITECTURE (2025 Update):
# - immich-server: Combined API, web interface, and microservices (replaces 3 containers)
# - immich-machine-learning: AI processing (face detection, smart search)
# - valkey: In-memory cache (Redis 8 alternative)
# - database: PostgreSQL with VectorChord extension (replaces pgvecto.rs)
#
# ACCESS:
# - Web UI: http://immich.{{ network.domain_name }}
# - Direct: http://{{ network.wifi.ip }}:{{ immich.services.immich.port }}
# - Mobile apps: Configure server URL in app settings
# - First-time: Create admin account on first access
# ==============================================================================

name: immich

services:
  # ==============================================================================
  # IMMICH SERVER - Main Application (Combined in 2025)
  # ==============================================================================
  # Handles web interface, API, photo/video uploads, transcoding, and microservices
  # NOTE: In 2025, immich-server combines server, microservices, and web into one container
  immich-server:
    container_name: immich_server
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    volumes:
      # Photo/video library storage (bind mount for direct access)
      - "{{ immich.services.immich.upload_location }}:/usr/src/app/upload"
      # Timezone for correct timestamp display
      - /etc/localtime:/etc/localtime:ro
    env_file:
      - .env
    ports:
      - "{{ immich.services.immich.port }}:2283"
    depends_on:
      - redis
      - database
    restart: unless-stopped
    networks:
      - photos
      - proxy
    labels:
      # Traefik routing configuration
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.immich.rule=Host(`immich.{{ network.domain_name }}`)"
      - "traefik.http.routers.immich.entrypoints=web"
      - "traefik.http.services.immich.loadbalancer.server.port=2283"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:2283/api/server/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # ==============================================================================
  # IMMICH MACHINE LEARNING - AI Processing
  # ==============================================================================
  # Handles face recognition, smart search, and automatic tagging
  # Uses hardware acceleration on Pi 5 for faster processing
  immich-machine-learning:
    container_name: immich_machine_learning
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    volumes:
      # ML model cache (stores downloaded AI models)
      - "{{ immich.services.immich.ml_cache_location }}:/cache"
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - photos
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import requests; requests.get(\"http://localhost:3003/ping\", timeout=10)'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # ==============================================================================
  # REDIS (Valkey 8) - In-Memory Cache (2025 Update)
  # ==============================================================================
  # Caches API responses and job queue for better performance
  # NOTE: 2025 uses Valkey 8 instead of Redis 6.2
  redis:
    container_name: immich_redis
    image: docker.io/valkey/valkey:8-alpine
    restart: unless-stopped
    networks:
      - photos
    healthcheck:
      test: ["CMD-SHELL", "valkey-cli ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================================================
  # POSTGRESQL DATABASE - Metadata Storage (2025 VectorChord Update)
  # ==============================================================================
  # Stores photo metadata, user accounts, albums, and AI embeddings
  # NOTE: 2025 uses VectorChord instead of pgvecto.rs for better performance
  database:
    container_name: immich_postgres
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_DB: ${DB_DATABASE_NAME}
      POSTGRES_INITDB_ARGS: '--data-checksums'
    volumes:
      # Database storage (persistent)
      - "{{ immich.services.immich.db_data_location }}:/var/lib/postgresql/data"
    restart: unless-stopped
    networks:
      - photos
    healthcheck:
      test: ["CMD-SHELL", "pg_isready --dbname='${DB_DATABASE_NAME}' --username='${DB_USERNAME}' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    command: ["postgres", "-c", "shared_preload_libraries=vchord.so", "-c", 'search_path="$$user", public, vectors', "-c", "logging_collector=on", "-c", "max_wal_size=2GB", "-c", "shared_buffers=512MB", "-c", "wal_compression=on"]

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  photos:
    name: photos_network
    driver: bridge
  proxy:
    external: true

# ==============================================================================
# CONFIGURATION NOTES
# ==============================================================================
#
# 2025 UPDATES:
# - immich-server now combines server, microservices, and web (3-in-1)
# - Port changed from 3001 to 2283
# - Database: pgvecto.rs → VectorChord (better performance)
# - Cache: Redis 6.2 → Valkey 8 (open-source Redis fork)
# - immich-web container removed (merged into immich-server)
#
# HARDWARE ACCELERATION (Pi 5):
# - For video transcoding: Add hwaccel.transcoding.yml with rkmpp config
# - For ML inference: Add hwaccel.ml.yml with armnn config
# - Pi 5 RK3588 supports hardware video encoding/decoding
#
# STORAGE:
# - Photos: {{ immich.services.immich.upload_location }}
# - Database: {{ immich.services.immich.db_data_location }}
# - ML Cache: {{ immich.services.immich.ml_cache_location }}
#
# BACKUP:
# - Database: Automatic daily backups at 2 AM (configurable in .env)
# - Photos: Regular filesystem backups recommended
#
# FIRST-TIME SETUP:
# 1. Access http://immich.{{ network.domain_name }}
# 2. Create admin account
# 3. Download mobile app (iOS/Android)
# 4. Configure server URL in app
# 5. Enable auto-backup in app settings
#
# MOBILE APP CONFIGURATION:
# - Server URL: http://{{ network.wifi.ip }}:{{ immich.services.immich.port }}
# - Or: http://immich.{{ network.domain_name }}
# - Enable background upload for automatic backup
# - Configure WiFi-only upload to save mobile data
#
# MULTI-USER:
# - Admin can create additional user accounts
# - Each user has separate library and albums
# - Users can share albums with each other
#
# MAINTENANCE:
# - Update: docker compose pull && docker compose up -d
# - Logs: docker compose logs -f immich-server
# - Database backup: See Immich docs for backup procedures
# ==============================================================================
