---
# ==============================================================================
# PHOTO MANAGEMENT ROLE - IMMICH STACK
# ==============================================================================
# Deploys Immich photo backup server with AI-powered features
#
# SERVICES:
# - immich-server: Main API & web interface
# - immich-machine-learning: AI processing (face recognition, search)
# - valkey: In-memory cache
# - postgres: Database with VectorChord extension
#
# FEATURES:
# - Automatic photo/video backup from mobile apps
# - AI face recognition and smart search
# - Multi-user support with album sharing
# - Hardware acceleration on Pi 5
# ==============================================================================

# ==============================================================================
# PHASE 1: START IMAGE DOWNLOADS IN BACKGROUND
# ==============================================================================
# Kickoff downloads of large images (especially 4GB ML model) immediately.
# These run in the background while we do setup work below.

- name: Start background image pulls for Immich stack
  include_tasks: "../playbooks/templates/async_prepull_start.yml"
  vars:
    stack: "immich"
    image_list:
      - "ghcr.io/immich-app/immich-server:release"
      - "ghcr.io/immich-app/immich-machine-learning:release"  # 4GB+ ML model
      - "docker.io/valkey/valkey:8"
      - "ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0"
    prepull_timeout: 600  # Allow 10 minutes for large ML image
  tags:
    - images

# ==============================================================================
# PHASE 2: SETUP WORK (RUNS WHILE IMAGES DOWNLOAD)
# ==============================================================================

- name: Setup photo management stack user and directories
  include_tasks: "../playbooks/templates/create_user.yml"
  vars:
    stack: "immich"
    folders: [library, backups]

- name: Create additional Immich directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ immich.user.name }}"
    group: "{{ immich.group.name }}"
    mode: '0755'
  loop:
    - "{{ immich.services.immich.upload_location }}"
    - "{{ immich.services.immich.db_data_location }}"
    - "{{ immich.services.immich.ml_cache_location }}"
  tags:
    - directories

- name: Deploy .env file for Immich
  ansible.builtin.template:
    src: .env.j2
    dest: "{{ storage.stacks }}/immich/.env"
    owner: "{{ immich.user.name }}"
    group: "{{ immich.group.name }}"
    mode: '0600'  # Secure permissions for secrets
  tags:
    - config

# ==============================================================================
# PHASE 3: WAIT FOR IMAGE DOWNLOADS TO COMPLETE
# ==============================================================================
# Now wait for the background downloads started in Phase 1 to finish.

- name: Wait for Immich stack images to finish downloading
  include_tasks: "../playbooks/templates/async_prepull_wait.yml"
  vars:
    stack: "immich"
    prepull_retries: 120  # 120 * 5s = 10 minutes for large ML image
    prepull_delay: 5
  tags:
    - images

# ==============================================================================
# PHASE 4: DEPLOY STACK
# ==============================================================================

- name: Ensure required Docker networks for Immich exist
  include_tasks: "../playbooks/templates/create_networks.yml"
  vars:
    networks: [proxy, backend]
  tags:
    - config

- name: Deploy Immich stack
  include_tasks: "../playbooks/templates/deploy_compose_stack.yml"
  vars:
    stack: "immich"
    compose_template: "docker-compose-immich.yml.j2"
    error_handling: "rescue"
    deploy_timeout: 300
    deploy_retries: 2
  tags:
    - deploy

# ==============================================================================
# PHASE 5: HEALTH CHECK WITH DETAILED DIAGNOSTICS
# ==============================================================================
# Immich requires custom health check with detailed diagnostics on failure

- name: Wait for Immich server to be ready and collect diagnostics on failure
  block:
    - name: Wait for Immich server to be ready
      ansible.builtin.uri:
        url: "http://localhost:{{ immich.services.immich.port }}/api/server/ping"
        status_code: 200
        timeout: 10
      register: immich_health
      until: immich_health.status == 200
      retries: 20
      delay: 5
      tags: [health_check]
  rescue:
    - name: Show Immich compose ps
      ansible.builtin.command:
        cmd: docker compose -f "{{ storage.stacks }}/immich/docker-compose.yml" ps
      register: immich_ps
      changed_when: false

    - name: Tail Immich server logs
      ansible.builtin.command:
        cmd: docker compose -f "{{ storage.stacks }}/immich/docker-compose.yml" logs --tail=120 immich-server
      register: immich_server_logs
      changed_when: false
      failed_when: false

    - name: Tail Immich database logs
      ansible.builtin.command:
        cmd: docker compose -f "{{ storage.stacks }}/immich/docker-compose.yml" logs --tail=80 database
      register: immich_db_logs
      changed_when: false
      failed_when: false

    - name: Tail Immich redis logs
      ansible.builtin.command:
        cmd: docker compose -f "{{ storage.stacks }}/immich/docker-compose.yml" logs --tail=40 redis
      register: immich_redis_logs
      changed_when: false
      failed_when: false

    - name: Display Immich diagnostics
      ansible.builtin.debug:
        msg: |
          Immich failed readiness check; diagnostics follow.
          docker ps:
          {{ immich_ps.stdout }}

          immich-server logs (last 120 lines):
          {{ immich_server_logs.stdout }}

          database logs (last 80 lines):
          {{ immich_db_logs.stdout }}

          redis logs (last 40 lines):
          {{ immich_redis_logs.stdout }}

    - name: Fail with helpful message after diagnostics
      ansible.builtin.fail:
        msg: "Immich readiness check failed. See diagnostics above."

- name: Display Immich stack deployment summary
  ansible.builtin.debug:
    msg: |
      ‚úÖ Immich Photo Backup Server Deployed Successfully

      üì± WEB ACCESS:
         - Via Traefik: http://immich.{{ network.domain_name }}
         - Direct: http://{{ network.wifi.ip }}:{{ immich.services.immich.port }}

      üì± MOBILE APP SETUP:
         1. Download Immich app (iOS/Android)
         2. Server URL: http://{{ network.wifi.ip }}:{{ immich.services.immich.port }}
         3. Create admin account on first access
         4. Enable auto-backup in app settings

      üóÇÔ∏è STORAGE:
         - Photos: {{ immich.services.immich.upload_location }}
         - Database: {{ immich.services.immich.db_data_location }}
         - ML Cache: {{ immich.services.immich.ml_cache_location }}

      ü§ñ AI FEATURES:
         - Face recognition: Enabled
         - Smart search: Enabled
         - Auto-tagging: Enabled

      üìä SERVICES:
         - immich-server: Main API & web interface
         - immich-machine-learning: AI processing
         - valkey: Cache (Redis alternative)
         - postgres: Database with VectorChord

      üîß MANAGEMENT:
         - Logs: docker compose -f {{ storage.stacks }}/immich/docker-compose.yml logs -f
         - Restart: docker compose -f {{ storage.stacks }}/immich/docker-compose.yml restart
         - Update: docker compose -f {{ storage.stacks }}/immich/docker-compose.yml pull && docker compose -f {{ storage.stacks }}/immich/docker-compose.yml up -d
  when: immich_health.status == 200
