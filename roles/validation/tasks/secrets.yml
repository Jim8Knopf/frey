---
# Secrets and credentials validation tasks

- name: Validate secrets file structure
  block:
    - name: Check if secrets are properly loaded
      ansible.builtin.assert:
        that:
          - vault_secrets is defined or
            ansible_vault_password_file is defined or
            lookup('env', 'ANSIBLE_VAULT_PASSWORD_FILE') | length > 0
        fail_msg: |
          SECRETS WARNING: Unable to verify if secrets are properly loaded.
          If using Ansible Vault, ensure vault password is provided.
        success_msg: "✓ Secrets system appears to be configured"
      ignore_errors: yes

- name: Validate password complexity requirements
  when: features.wifi_access_point | default(false)
  block:
    - name: Check WiFi password meets WPA2 requirements
      ansible.builtin.assert:
        that:
          - network.wifi.password is defined
          - network.wifi.password | length >= 8
          - network.wifi.password | length <= 63
        fail_msg: |
          SECURITY ERROR: WiFi password does not meet WPA2 requirements.
          Password must be between 8 and 63 characters.
          Current length: {{ network.wifi.password | default('undefined') | length }}
        success_msg: "✓ WiFi password meets WPA2 complexity requirements"

- name: Validate media service credentials
  when: features.media | default(false)
  block:
    - name: Check qBittorrent credentials are set
      when: media.services.qbittorrent.enabled | default(false)
      ansible.builtin.assert:
        that:
          - media.services.qbittorrent.username is defined
          - media.services.qbittorrent.password is defined
          - media.services.qbittorrent.username | length > 0
          - media.services.qbittorrent.password | length >= 6
        fail_msg: |
          SECURITY ERROR: qBittorrent requires valid credentials.
          Username and password must be set, password minimum 6 characters.
        success_msg: "✓ qBittorrent credentials are configured"
      when:
        - media.services.qbittorrent.username is defined
        - media.services.qbittorrent.password is defined

    - name: Warn about default credentials
      when: media.services.qbittorrent.enabled | default(false)
      ansible.builtin.debug:
        msg: |
          SECURITY REMINDER: Ensure qBittorrent credentials are not default values.
          Default username 'admin' and password 'adminadmin' should be changed.
      when:
        - media.services.qbittorrent.username is defined
        - media.services.qbittorrent.username == 'admin'

- name: Validate monitoring credentials
  when: features.monitoring | default(false)
  block:
    - name: Check Grafana admin credentials
      when: monitoring.services.grafana.enabled | default(false)
      ansible.builtin.assert:
        that:
          - monitoring.services.grafana.admin_user is defined
          - monitoring.services.grafana.admin_password is defined
          - monitoring.services.grafana.admin_user | length > 0
          - monitoring.services.grafana.admin_password | length >= 8
        fail_msg: |
          SECURITY ERROR: Grafana admin credentials must be set.
          Password must be at least 8 characters for security.
        success_msg: "✓ Grafana admin credentials are configured"
      when:
        - monitoring.services.grafana.admin_user is defined
        - monitoring.services.grafana.admin_password is defined

    - name: Warn about Grafana default admin password
      when:
        - monitoring.services.grafana.enabled | default(false)
        - monitoring.services.grafana.admin_password is defined
        - monitoring.services.grafana.admin_password == 'admin'
      ansible.builtin.fail:
        msg: |
          CRITICAL SECURITY ERROR: Grafana admin password is set to default 'admin'.
          This is a severe security risk. Please set a strong password immediately.

- name: Validate automation service credentials
  when: features.automation | default(false)
  block:
    - name: Check n8n encryption key is set
      when: automation.services.n8n.enabled | default(false)
      ansible.builtin.assert:
        that:
          - automation.services.n8n.encryption_key is defined
          - automation.services.n8n.encryption_key | length >= 32
        fail_msg: |
          SECURITY ERROR: n8n requires a strong encryption key.
          The encryption key must be at least 32 characters for proper security.
        success_msg: "✓ n8n encryption key is properly configured"
      when: automation.services.n8n.encryption_key is defined

- name: Validate API tokens and keys
  block:
    - name: Warn about exposed API keys in configuration
      ansible.builtin.debug:
        msg: |
          SECURITY BEST PRACTICE:
          Ensure all API keys, tokens, and secrets are stored in secrets.yml (encrypted with Ansible Vault).
          Never commit unencrypted secrets to version control.
          Review your configuration files for any exposed credentials.

- name: Check for common password patterns
  block:
    - name: Validate WiFi password is not common weak password
      when:
        - features.wifi_access_point | default(false)
        - network.wifi.password is defined
      ansible.builtin.assert:
        that:
          - network.wifi.password not in validation_common_weak_passwords
        fail_msg: |
          SECURITY ERROR: WiFi password appears to be a commonly used weak password.
          Please choose a stronger, unique password.
        success_msg: "✓ WiFi password does not match common weak passwords"
      when: validation_common_weak_passwords is defined

- name: Validate no hardcoded credentials in plain text
  block:
    - name: Security reminder about credential management
      ansible.builtin.debug:
        msg: |
          SECURITY CHECKLIST:
          ✓ All passwords should be in secrets.yml (Ansible Vault encrypted)
          ✓ API keys should never be in main.yml
          ✓ Database passwords should be random and strong (16+ characters)
          ✓ Service-to-service authentication should use API tokens
          ✓ Regular credential rotation is recommended

          Files to audit:
          - group_vars/all/main.yml (should NOT contain secrets)
          - group_vars/all/secrets.yml (should be vault encrypted)
