---
# Validate that required secrets are defined (without exposing values)

- name: Validation | Validate WiFi password is defined
  ansible.builtin.assert:
    that:
      - network.wifi.password is defined
      - network.wifi.password | length > 0
    fail_msg: "WiFi password (network.wifi.password) must be defined and non-empty"
    success_msg: "✓ WiFi password is defined"
  when: features.wifi_access_point | default(false)
  no_log: true

- name: Validation | Validate Authentik secrets
  block:
    - name: Validation | Check Authentik secret key
      ansible.builtin.assert:
        that:
          - infrastructure.services.authentik.secret_key is defined
          - infrastructure.services.authentik.secret_key | length >= 32
        fail_msg: "Authentik secret_key must be defined and at least 32 characters"
        success_msg: "✓ Authentik secret key is defined"
      no_log: true
      when: infrastructure.services.authentik.enabled | default(false)

    - name: Validation | Check Authentik PostgreSQL password
      ansible.builtin.assert:
        that:
          - infrastructure.services.authentik.postgres_password is defined
          - infrastructure.services.authentik.postgres_password | length > 0
        fail_msg: "Authentik PostgreSQL password must be defined"
        success_msg: "✓ Authentik PostgreSQL password is defined"
      no_log: true
      when: infrastructure.services.authentik.enabled | default(false)
  when: features.infrastructure | default(false)

- name: Validation | Validate media service database passwords
  block:
    - name: Validation | Check Mealie database password
      ansible.builtin.assert:
        that:
          - media.services.mealie.db_password is defined
          - media.services.mealie.db_password | length > 0
        fail_msg: "Mealie database password (media.services.mealie.db_password) must be defined"
        success_msg: "✓ Mealie database password is defined"
      no_log: true
      when:
        - media.services.mealie is defined
        - media.services.mealie.enabled | default(false)
  when: features.media | default(false)

- name: Validation | Validate monitoring service credentials
  block:
    - name: Validation | Check Grafana admin password
      ansible.builtin.assert:
        that:
          - monitoring.services.grafana.admin_password is defined
          - monitoring.services.grafana.admin_password | length >= 8
        fail_msg: "Grafana admin password must be defined and at least 8 characters"
        success_msg: "✓ Grafana admin password is defined"
      no_log: true
      when:
        - monitoring.services.grafana is defined
        - monitoring.services.grafana.enabled | default(false)
  when: features.monitoring | default(false)

- name: Validation | Validate Immich secrets
  block:
    - name: Validation | Check Immich database password
      ansible.builtin.assert:
        that:
          - immich.services.database.password is defined
          - immich.services.database.password | length > 0
        fail_msg: "Immich database password must be defined"
        success_msg: "✓ Immich database password is defined"
      no_log: true
      when:
        - immich.services.database is defined
        - immich.services.database.enabled | default(false)
  when: features.immich | default(false)

- name: Validation | Validate AdGuard Home password
  ansible.builtin.assert:
    that:
      - infrastructure.services.adguard.password is defined
      - infrastructure.services.adguard.password | length > 0
    fail_msg: "AdGuard Home password must be defined"
    success_msg: "✓ AdGuard Home password is defined"
  no_log: true
  when:
    - features.infrastructure | default(false)
    - infrastructure.services.adguard is defined
    - infrastructure.services.adguard.enabled | default(false)

- name: Validation | Check for plaintext secrets in main.yml (security warning)
  block:
    - name: Validation | Read main.yml for password strings
      ansible.builtin.shell: |
        grep -n "password:" {{ playbook_dir }}/group_vars/all/main.yml | grep -v "db_password\|admin_password" | head -5 || true
      register: password_check
      changed_when: false
      delegate_to: localhost

    - name: Validation | Warn about potential plaintext passwords
      ansible.builtin.debug:
        msg: "WARNING: Potential plaintext passwords found in main.yml. Consider moving to secrets.yml (vault-encrypted)"
      when: password_check.stdout | length > 0
  ignore_errors: yes

- name: Validation | Display secrets validation success
  ansible.builtin.debug:
    msg: "✓ Required secrets are defined (values not displayed for security)"
