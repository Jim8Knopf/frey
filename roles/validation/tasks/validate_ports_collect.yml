---
# Collect ports from a single stack (called via include_tasks loop)
# Variables available: stack_config (contains name, feature_flag, has_services, has_user_group)

- name: Validation | Collect ports from {{ stack_config.name }} stack
  set_fact:
    all_configured_ports: "{{ all_configured_ports + [item.value.port | string] }}"
  loop: "{{ vars[stack_config.name].services | default({}) | dict2items }}"
  when:
    - vars[stack_config.name] is defined
    - features[stack_config.feature_flag] | default(false)
    - stack_config.has_services | default(false)
    - vars[stack_config.name].services is defined
    - item.value.enabled | default(false)
    - item.value.port is defined
  loop_control:
    label: "{{ stack_config.name }}/{{ item.key }}: {{ item.value.port | default('N/A') }}"
