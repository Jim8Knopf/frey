---
# Validate port assignments to prevent conflicts

- name: Validation | Build list of all configured ports
  set_fact:
    all_configured_ports: []

- name: Validation | Collect infrastructure service ports
  set_fact:
    all_configured_ports: "{{ all_configured_ports + [item.value.port | string] }}"
  loop: "{{ infrastructure.services | dict2items }}"
  when:
    - features.infrastructure | default(false)
    - item.value.enabled | default(false)
    - item.value.port is defined
  loop_control:
    label: "{{ item.key }}: {{ item.value.port | default('N/A') }}"

- name: Validation | Collect media service ports
  set_fact:
    all_configured_ports: "{{ all_configured_ports + [item.value.port | string] }}"
  loop: "{{ media.services | dict2items }}"
  when:
    - features.media | default(false)
    - item.value.enabled | default(false)
    - item.value.port is defined
  loop_control:
    label: "{{ item.key }}: {{ item.value.port | default('N/A') }}"

- name: Validation | Collect monitoring service ports
  set_fact:
    all_configured_ports: "{{ all_configured_ports + [item.value.port | string] }}"
  loop: "{{ monitoring.services | dict2items }}"
  when:
    - features.monitoring | default(false)
    - item.value.enabled | default(false)
    - item.value.port is defined
  loop_control:
    label: "{{ item.key }}: {{ item.value.port | default('N/A') }}"

- name: Validation | Collect automation service ports
  set_fact:
    all_configured_ports: "{{ all_configured_ports + [item.value.port | string] }}"
  loop: "{{ automation.services | dict2items }}"
  when:
    - features.automation | default(false)
    - item.value.enabled | default(false)
    - item.value.port is defined
  loop_control:
    label: "{{ item.key }}: {{ item.value.port | default('N/A') }}"

- name: Validation | Collect immich service ports
  set_fact:
    all_configured_ports: "{{ all_configured_ports + [item.value.port | string] }}"
  loop: "{{ immich.services | dict2items }}"
  when:
    - features.immich | default(false)
    - item.value.enabled | default(false)
    - item.value.port is defined
  loop_control:
    label: "{{ item.key }}: {{ item.value.port | default('N/A') }}"

- name: Validation | Add additional system ports
  set_fact:
    all_configured_ports: "{{ all_configured_ports + ['80', '443'] }}"
  when: features.infrastructure | default(false)

- name: Validation | Display collected ports for debugging
  ansible.builtin.debug:
    msg: "Configured ports: {{ all_configured_ports | sort }}"
    verbosity: 1

- name: Validation | Check for duplicate port assignments
  block:
    - name: Validation | Count port occurrences
      set_fact:
        port_counts: {}

    - name: Validation | Build port frequency map
      set_fact:
        port_counts: "{{ port_counts | combine({item: (port_counts[item] | default(0)) + 1}) }}"
      loop: "{{ all_configured_ports }}"

    - name: Validation | Find duplicate ports
      set_fact:
        duplicate_ports: "{{ port_counts | dict2items | selectattr('value', 'gt', 1) | map(attribute='key') | list }}"

    - name: Validation | Assert no duplicate ports
      ansible.builtin.assert:
        that:
          - duplicate_ports | length == 0
        fail_msg: "Port conflict detected! The following ports are assigned to multiple services: {{ duplicate_ports | join(', ') }}"
        success_msg: "✓ No port conflicts detected"
  when: all_configured_ports | length > 0

- name: Validation | Validate port numbers are in valid range
  ansible.builtin.assert:
    that:
      - item | int >= 1
      - item | int <= 65535
    fail_msg: "Invalid port number: {{ item }}. Ports must be between 1-65535"
    success_msg: "✓ Port {{ item }} is in valid range"
  loop: "{{ all_configured_ports }}"
  loop_control:
    label: "Port {{ item }}"
  when: all_configured_ports | length > 0

- name: Validation | Validate privileged ports (< 1024) are intentional
  ansible.builtin.debug:
    msg: "WARNING: Privileged port {{ item }} (<1024) is configured. Ensure Docker has appropriate permissions."
  loop: "{{ all_configured_ports }}"
  loop_control:
    label: "Port {{ item }}"
  when:
    - all_configured_ports | length > 0
    - item | int < 1024

- name: Validation | Validate firewall ports configuration
  block:
    - name: Validation | Check firewall ports list is defined
      ansible.builtin.assert:
        that:
          - security.firewall_tcp_ports is defined
          - security.firewall_tcp_ports is sequence
        fail_msg: "security.firewall_tcp_ports must be defined as a list"
        success_msg: "✓ Firewall ports configuration is defined"

    - name: Validation | Validate firewall port numbers
      ansible.builtin.assert:
        that:
          - item | int >= 1
          - item | int <= 65535
        fail_msg: "Invalid firewall port: {{ item }}"
      loop: "{{ security.firewall_tcp_ports }}"
      loop_control:
        label: "Port {{ item }}"
  when: features.security | default(false)

- name: Validation | Display port validation success
  ansible.builtin.debug:
    msg: "✓ Port configuration is valid ({{ all_configured_ports | length }} ports checked)"
