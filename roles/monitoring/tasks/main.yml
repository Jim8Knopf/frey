---
- name: Assert required monitoring variables
  ansible.builtin.assert:
    that:
      - monitoring is defined
      - storage.base_dir is defined
      - storage.stacks is defined
      - storage.appdata_dir is defined
      - monitoring.user.name is defined
      - monitoring.user.uid is defined
      - monitoring.group.name is defined
      - monitoring.group.gid is defined
      - monitoring.services is defined
    msg: "Required monitoring variables are not defined. Check group_vars/all/main.yml"
    quiet: false

- name: Setup media stack user
  include_tasks: "templates/create_user.yml"
  vars:
    stack: "monitoring"
    folders: [logs, prometheus, grafana, loki, promtail, uptime-kuma, speedtest]

- name: Ensure logs directory exists for promtail
  ansible.builtin.file:
    path: "{{ monitoring.dir }}/logs"
    state: directory
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0777'

- name: Ensure Prometheus data directory exists
  ansible.builtin.file:
    path: "{{storage.appdata_dir }}/prometheus/data"
    state: directory
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0777'

- name: Ensure Grafana plugins directory exists
  ansible.builtin.file:
    path: "{{storage.appdata_dir }}/grafana/plugins"
    state: directory
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0777'

- name: Ensure Loki appdata directory exists
  ansible.builtin.file:
    path: "{{storage.appdata_dir }}/loki"
    state: directory
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0777'

- name: Ensure all monitoring appdata owned by monitoring.user.name
  ansible.builtin.shell:
    cmd: |
      for d in "{{storage.appdata_dir }}/prometheus" "{{storage.appdata_dir }}/grafana" "{{storage.appdata_dir }}/loki" "{{storage.appdata_dir }}/promtail"; do
        if [ -e "$d" ]; then
          chown -R {{ monitoring.user.name }}:{{ monitoring.group.name }} "$d"
        fi
      done
  become: true
  args:
    executable: /bin/bash

- name: Create Prometheus configuration
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{storage.appdata_dir }}/prometheus/prometheus.yml"
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0644'

- name: Deploy Loki local config
  ansible.builtin.template:
    src: loki-local-config.yml.j2
    dest: "{{storage.appdata_dir }}/loki/local-config.yaml"
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0644'

- name: Deploy Promtail config
  ansible.builtin.template:
    src: promtail-config.yml.j2
    dest: "{{storage.appdata_dir }}/promtail/config.yml"
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0644'

- name: Create Grafana provisioning directories
  ansible.builtin.file:
    path: "{{storage.appdata_dir }}/grafana/provisioning/{{ item }}"
    state: directory
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0755'
  loop:
    - dashboards
    - datasources

- name: Configure Grafana datasources
  ansible.builtin.template:
    src: grafana-datasources.yml.j2
    dest: "{{storage.appdata_dir }}/grafana/provisioning/datasources/datasources.yml"
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0644'

- name: Pre-pull all enabled monitoring stack images
  community.docker.docker_image:
    name: "{{ item.image }}"
    source: pull
    state: present
    timeout: 300
  loop: "{{ monitoring.services.values() | selectattr('enabled', 'equalto', true) | list }}"
  loop_control:
    label: "{{ item.image }}"
  register: image_pull_results
  retries: 2
  delay: 10
  failed_when: false

- name: Set failed pulls fact for monitoring
  ansible.builtin.set_fact:
    monitoring_failed_pulls: "{{ image_pull_results.results | select('failed') | map(attribute='item.image') | list }}"

- name: Report failed monitoring image pulls
  ansible.builtin.debug:
    msg: "Warning: Failed to pull the following images: {{ monitoring_failed_pulls }}. Will retry during compose."
  when: monitoring_failed_pulls | length > 0

- name: Deploy monitoring stack compose file
  ansible.builtin.template:
    src: docker-compose-monitoring.yml.j2
    dest: "{{ storage.stacks }}/monitoring/docker-compose.yml"
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0644'

- name: Create Prometheus configuration
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{storage.appdata_dir }}/prometheus/prometheus.yml"
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0644'

- name: Deploy Loki local config
  ansible.builtin.template:
    src: loki-local-config.yml.j2
    dest: "{{storage.appdata_dir }}/loki/local-config.yaml"
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0644'

- name: Deploy Promtail config
  ansible.builtin.template:
    src: promtail-config.yml.j2
    dest: "{{storage.appdata_dir }}/promtail/config.yml"
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0644'

- name: Create Grafana provisioning directories
  ansible.builtin.file:
    path: "{{storage.appdata_dir }}/grafana/provisioning/{{ item }}"
    state: directory
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0755'
  loop:
    - dashboards
    - datasources

- name: Configure Grafana datasources
  ansible.builtin.template:
    src: grafana-datasources.yml.j2
    dest: "{{storage.appdata_dir }}/grafana/provisioning/datasources/datasources.yml"
    owner: "{{ monitoring.user.name }}"
    group: "{{ monitoring.group.name }}"
    mode: '0644'

- name: Validate monitoring compose syntax
  ansible.builtin.command:
    cmd: docker compose -f {{ storage.stacks }}/monitoring/docker-compose.yml config --quiet
  register: compose_validation
  failed_when: compose_validation.rc != 0
  changed_when: false

- name: Deploy monitoring stack with error handling
  block:
    - name: Start monitoring stack using compose
      community.docker.docker_compose_v2:
        project_src: "{{ storage.stacks }}/monitoring"
        state: present
        remove_orphans: true
        timeout: 300
      register: compose_result
      retries: 2
      delay: 30

  rescue:
    - name: Gather monitoring stack failure logs
      ansible.builtin.command:
        cmd: docker compose -f {{ storage.stacks }}/monitoring/docker-compose.yml logs --tail=50
      register: failure_logs
      failed_when: false

    - name: Display monitoring deployment failure context
      ansible.builtin.debug:
        msg: |
          Monitoring stack deployment failed.
          Recent logs:
          {{ failure_logs.stdout }}

    - name: Fail with context
      ansible.builtin.fail:
        msg: "Monitoring stack deployment failed. See logs above."

- name: Ensure monitoring appdata ownership matches container users (fix UID/GID mismatches)
  become: true
  ansible.builtin.shell: |
    set -eu
    BASE_DIR="{{storage.appdata_dir }}"
    for svc in loki grafana prometheus promtail; do
      # ask docker for the configured container user for the running container
      user_spec=$(docker inspect -f "{{'{{'}}.Config.User{{'}}'}}" "${svc}" 2>/dev/null || true)
      if [ -n "${user_spec}" ]; then
        # user_spec may be 'UID' or 'UID:GID'
        uid="${user_spec%%:*}"
        gid="${user_spec#*:}"
        if [ "${uid}" = "${user_spec}" ]; then
          gid="${uid}"
        fi
        target_dir="${BASE_DIR}/${svc}"
        if [ -d "${target_dir}" ]; then
          echo "Setting ownership of ${target_dir} -> ${uid}:${gid}"
          chown -R ${uid}:${gid} "${target_dir}" || true
        fi
      fi
    done
  args:
    executable: /bin/bash
  failed_when: false

- name: Verify monitoring containers are running
  ansible.builtin.command:
    cmd: docker compose -f {{ storage.stacks }}/monitoring/docker-compose.yml ps --filter "status=running" --format json
  register: running_containers
  changed_when: false
  failed_when: false

- name: Report monitoring container status
  ansible.builtin.debug:
    msg: "{{ (running_containers.stdout | from_json | length) }} monitoring containers are running"
  when: running_containers.rc == 0
