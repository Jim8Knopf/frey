services:
  {% if monitoring.dockge.enabled | default(false) -%}
  dockge:
    image: "{{ monitoring.dockge.image }}:{{ monitoring.dockge.version }}"
    container_name: dockge
    restart: unless-stopped
    # No direct host port; access via Traefik only
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "{{ storage.appdata_dir }}/dockge:/app/data"
      - "{{ storage.stacks }}:/opt/stacks"
    environment:
      - DOCKGE_STACKS_DIR=/opt/stacks
      - DOCKGE_ENABLE_CONSOLE=true
    networks:
      proxy:              # For Traefik access
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.dockge.rule=Host(`dockge.{{ network.domain_name }}`)"
      - "traefik.http.routers.dockge.entrypoints=websecure"
      - "traefik.http.routers.dockge.tls=true"
      - "traefik.http.routers.dockge.tls.certresolver=step-ca"
      - "traefik.http.routers.dockge-http.rule=Host(`dockge.{{ network.domain_name }}`)"
      - "traefik.http.routers.dockge-http.entrypoints=web"
      - "traefik.http.middlewares.dockge-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.dockge-http.middlewares=dockge-redirect"
      - "traefik.http.services.dockge.loadbalancer.server.port=5001"
  {% endif %}

  {% if monitoring.prometheus.enabled | default(false) -%}
  prometheus:
    image: "{{ monitoring.prometheus.image }}:{{ monitoring.prometheus.version }}"
    container_name: prometheus
    restart: unless-stopped
    user: "0"
    # No direct host port; access via Traefik only
    volumes:
      - "{{ storage.appdata_dir }}/prometheus:/etc/prometheus"
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{ storage.appdata_dir }}/prometheus/data:/prometheus"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    networks:
      proxy:              # For Traefik access
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.{{ network.domain_name }}`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.routers.prometheus.tls.certresolver=step-ca"
      - "traefik.http.routers.prometheus-http.rule=Host(`prometheus.{{ network.domain_name }}`)"
      - "traefik.http.routers.prometheus-http.entrypoints=web"
      - "traefik.http.middlewares.prometheus-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.prometheus-http.middlewares=prometheus-redirect"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
  {% endif %}

  {% if monitoring['node-exporter'].enabled | default(false) -%}
  node-exporter:
    image: "{{ monitoring['node-exporter'].image }}:{{ monitoring['node-exporter'].version }}"
    container_name: node-exporter
    restart: unless-stopped
    # No direct host port; access via Traefik only
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      proxy:              # For Traefik access
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.node-exporter.rule=Host(`metrics.{{ network.domain_name }}`)"
      - "traefik.http.routers.node-exporter.entrypoints=websecure"
      - "traefik.http.routers.node-exporter.tls=true"
      - "traefik.http.routers.node-exporter.tls.certresolver=step-ca"
      - "traefik.http.routers.node-exporter-http.rule=Host(`metrics.{{ network.domain_name }}`)"
      - "traefik.http.routers.node-exporter-http.entrypoints=web"
      - "traefik.http.middlewares.metrics-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.node-exporter-http.middlewares=metrics-redirect"
      - "traefik.http.services.node-exporter.loadbalancer.server.port=9100"
  {% endif %}

  {% if monitoring.cadvisor.enabled | default(false) -%}
  cadvisor:
    image: "{{ monitoring.cadvisor.image }}:{{ monitoring.cadvisor.version }}"
    container_name: cadvisor
    privileged: true
    devices:
      - /dev/kmsg:/dev/kmsg
    # No direct host port; access via Traefik only
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks:
      proxy:              # For Traefik access
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.cadvisor.rule=Host(`cadvisor.{{ network.domain_name }}`)"
      - "traefik.http.routers.cadvisor.entrypoints=websecure"
      - "traefik.http.routers.cadvisor.tls=true"
      - "traefik.http.routers.cadvisor.tls.certresolver=step-ca"
      - "traefik.http.routers.cadvisor-http.rule=Host(`cadvisor.{{ network.domain_name }}`)"
      - "traefik.http.routers.cadvisor-http.entrypoints=web"
      - "traefik.http.middlewares.cadvisor-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.cadvisor-http.middlewares=cadvisor-redirect"
      - "traefik.http.services.cadvisor.loadbalancer.server.port=8080"
  {% endif %}

  {% if monitoring.grafana.enabled | default(false) -%}
  grafana:
    image: "{{ monitoring.grafana.image }}:{{ monitoring.grafana.version }}"
    container_name: grafana
    restart: unless-stopped
    # No direct host port; access via Traefik only
    volumes:
      - "{{ storage.appdata_dir }}/grafana:/var/lib/grafana"
      - "{{ storage.appdata_dir }}/grafana/provisioning:/etc/grafana/provisioning"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD={{ monitoring.grafana.default_password | default('admin123') }}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
      # DNS-based root URL for Traefik access (primary access method)
      # OAuth flow: grafana.frey → auth.frey → grafana.frey
      # Works offline via AdGuard local DNS resolution
      - GF_SERVER_ROOT_URL=http://grafana.{{ network.domain_name }}
      - GF_SERVER_SERVE_FROM_SUB_PATH=false
{% if infrastructure.services.authentik.enabled | default(false) %}
      # OIDC/SSO Authentication with Authentik (uses internal Docker service name)
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Authentik
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID={{ monitoring.grafana.oidc_client_id }}
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET={{ grafana_oidc_client_secret }}
      - GF_AUTH_GENERIC_OAUTH_SCOPES={{ monitoring.grafana.oidc_scopes }}
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL={{ monitoring.grafana.oidc_auth_url }}
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL={{ monitoring.grafana.oidc_token_url }}
      - GF_AUTH_GENERIC_OAUTH_API_URL={{ monitoring.grafana.oidc_api_url }}
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH={{ monitoring.grafana.oidc_role_attribute_path }}
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_AUTH_SIGNOUT_REDIRECT_URL={{ monitoring.grafana.oidc_auth_url }}
{% endif %}
    networks:
      proxy:              # For Traefik access (resolves auth.frey via Traefik's network alias)
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.grafana.rule=Host(`grafana.{{ network.domain_name | default('local') }}`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.routers.grafana.tls.certresolver=step-ca"
      - "traefik.http.routers.grafana-http.rule=Host(`grafana.{{ network.domain_name | default('local') }}`)"
      - "traefik.http.routers.grafana-http.entrypoints=web"
      - "traefik.http.middlewares.grafana-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.grafana-http.middlewares=grafana-redirect"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
  {% endif %}

  {% if monitoring.loki.enabled | default(false) -%}
  loki:
    image: "{{ monitoring.loki.image }}:{{ monitoring.loki.version }}"
    container_name: loki
    restart: unless-stopped
    # No direct host port; access via Traefik only
    volumes:
      - "{{ storage.appdata_dir }}/loki:/loki"
    networks:
      proxy:              # For Traefik access
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.loki.rule=Host(`loki.{{ network.domain_name }}`)"
      - "traefik.http.routers.loki.entrypoints=websecure"
      - "traefik.http.routers.loki.tls=true"
      - "traefik.http.routers.loki.tls.certresolver=step-ca"
      - "traefik.http.routers.loki-http.rule=Host(`loki.{{ network.domain_name }}`)"
      - "traefik.http.routers.loki-http.entrypoints=web"
      - "traefik.http.middlewares.loki-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.loki-http.middlewares=loki-redirect"
      - "traefik.http.services.loki.loadbalancer.server.port=3100"
  {% endif %}

  {% if monitoring.promtail.enabled | default(false) -%}
  promtail:
    image: "{{ monitoring.promtail.image }}:{{ monitoring.promtail.version }}"
    container_name: promtail
    restart: unless-stopped
    volumes:
      - "{{ monitoring.dir }}/logs:/var/log:ro"
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - "{{ storage.appdata_dir }}/promtail:/etc/promtail"
    command: -config.file=/etc/promtail/config.yml
    networks:
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
  {% endif %}

  {% if monitoring['uptime-kuma'].enabled | default(false) -%}
  uptime-kuma:
    image: "{{ monitoring['uptime-kuma'].image }}:{{ monitoring['uptime-kuma'].version }}"
    container_name: uptime-kuma
    restart: unless-stopped
    # No direct host port; access via Traefik only
    volumes:
      - "{{ storage.appdata_dir }}/uptime-kuma:/app/data"
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      proxy:              # For Traefik access
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.uptime.rule=Host(`uptime.{{ network.domain_name }}`)"
      - "traefik.http.routers.uptime.entrypoints=websecure"
      - "traefik.http.routers.uptime.tls=true"
      - "traefik.http.routers.uptime.tls.certresolver=step-ca"
      - "traefik.http.routers.uptime-http.rule=Host(`uptime.{{ network.domain_name }}`)"
      - "traefik.http.routers.uptime-http.entrypoints=web"
      - "traefik.http.middlewares.uptime-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.uptime-http.middlewares=uptime-redirect"
      - "traefik.http.services.uptime.loadbalancer.server.port=3001"
  {% endif %}

  {% if monitoring.watchtower.enabled | default(false) -%}
  watchtower:
    image: "{{ monitoring.watchtower.image }}:{{ monitoring.watchtower.version }}"
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL={{ automation.watchtower_interval }}
      - WATCHTOWER_INCLUDE_RESTARTING=true
    command: --schedule "0 0 2 * * *"  # 2 AM daily
    networks:
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
  {% endif %}

  {% if monitoring['speedtest-tracker'].enabled | default(false) -%}
  speedtest-tracker:
    image: "{{ monitoring['speedtest-tracker'].image }}:{{ monitoring['speedtest-tracker'].version }}"
    container_name: speedtest-tracker
    environment:
      - PUID={{ media.media_uid | default(user.uid | default(1000)) }}
      - PGID={{ media.media_gid | default(user.gid | default(1000)) }}
      - TZ={{ network.timezone | default('UTC') }}
      - OOKLA_EULA_GDPR=true
    volumes:
      - '{{ storage.appdata_dir }}/speedtest:/config'
    # No direct host port; access via Traefik only
    restart: unless-stopped
    networks:
      proxy:              # For Traefik access
      localdns:          # For DNS resolution
      monitoring_network: # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.speedtest.rule=Host(`speedtest.{{ network.domain_name }}`)"
      - "traefik.http.routers.speedtest.entrypoints=websecure"
      - "traefik.http.routers.speedtest.tls=true"
      - "traefik.http.routers.speedtest.tls.certresolver=step-ca"
      - "traefik.http.routers.speedtest-http.rule=Host(`speedtest.{{ network.domain_name }}`)"
      - "traefik.http.routers.speedtest-http.entrypoints=web"
      - "traefik.http.middlewares.speedtest-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.speedtest-http.middlewares=speedtest-redirect"
      - "traefik.http.services.speedtest.loadbalancer.server.port=80"
  {% endif %}

networks:
  # Traefik routing - all web-accessible services join this
  proxy:
    external: true
  # DNS resolution between containers
  localdns:
    external: true
  
  # Service-specific network for monitoring
  monitoring_network:
    name: monitoring_network
    driver: bridge
    enable_ipv6: false
    internal: false
    attachable: true
    ipam:
      driver: default
      config:
        - subnet: 10.20.5.0/24  # Monitoring services subnet
    labels:
      com.docker.compose.network: monitoring_network
      com.docker.compose.project: monitoring
