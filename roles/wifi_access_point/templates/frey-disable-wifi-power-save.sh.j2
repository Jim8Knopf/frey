#!/bin/bash
# Auto-generated by Ansible. Disables WiFi power saving for stability.
set -euo pipefail

interfaces=(
{% for iface in wifi_power_save_interfaces %}
  "{{ iface }}"
{% endfor %}
)

log() {
  logger -t frey-disable-wifi-power-save "$1"
}

if ! command -v iw >/dev/null 2>&1 && ! command -v iwconfig >/dev/null 2>&1; then
  log "neither iw nor iwconfig found; cannot change power-save state"
  exit 0
fi

for iface in "${interfaces[@]}"; do
  [ -n "$iface" ] || continue
  if ! ip link show "$iface" >/dev/null 2>&1; then
    log "interface $iface missing; skipping"
    continue
  fi

  if command -v iw >/dev/null 2>&1; then
    iw dev "$iface" set power_save off >/dev/null 2>&1 || true
  fi
  if command -v iwconfig >/dev/null 2>&1; then
    iwconfig "$iface" power off >/dev/null 2>&1 || true
  fi
  log "disabled power-save on $iface"
done
