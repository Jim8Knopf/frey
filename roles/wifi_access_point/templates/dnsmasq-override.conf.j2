# ==============================================================================
# DNSMASQ SYSTEMD OVERRIDE - Fix Race Condition & Hot-Plug Support
# ==============================================================================
# This override ensures dnsmasq starts correctly even when:
# 1. Client interface (wlan0) has no network connection
# 2. AP interface (wlan1) is ready with static IP (10.20.0.1)
# 3. AP interface (wlan1) doesn't exist yet (USB WiFi adapter not plugged in)
#
# PROBLEM: dnsmasq tries to bind to 10.20.0.1 before dhcpcd assigns the IP
# SOLUTION: Wait for dhcpcd to start, then verify AP interface is ready
# KEY: Don't bind to dhcpcd fate (client interface may have no connection)
#
# HOT-PLUG: Only start if wlan1 exists; gracefully skip if missing
# ==============================================================================

[Unit]
# Only start if AP interface exists (hot-plug support)
# If interface missing, systemd skips this service (condition not met)
ConditionPathExists=/sys/class/net/{{ network.wifi.interface }}

# Start after dhcpcd begins (but don't bind to its fate)
# AP must work even if client interface (wlan0) has no connection
After=dhcpcd.service

# Don't require network-online.target (may never be satisfied offline)
# We only need wlan1's static IP, not internet connectivity
Requires=

# Prefer hostapd to be running, but don't fail if it's not
# Changed from BindsTo (hard dependency) to Wants (soft dependency)
# This prevents boot deadlock when wlan1 missing
After=hostapd.service
Wants=hostapd.service

# Prevent timer conflicts during deployment
Conflicts=frey-ensure-ap-interface.timer

[Service]
# Restart on failure (handles temporary issues during boot)
Restart=on-failure
RestartSec=5s

# Wait for AP interface to be ready (UP, IP assigned, hostapd active)
# Timeout: 30 seconds (60 iterations Ã— 0.5s)
ExecStartPre=/bin/bash -c '\
  echo "Waiting for {{ network.wifi.interface }} to be ready..."; \
  for i in {1..60}; do \
    if ! ip link show {{ network.wifi.interface }} | grep -q "state UP"; then \
      sleep 0.5; \
      continue; \
    fi; \
    if ! ip addr show {{ network.wifi.interface }} | grep -q "{{ network.wifi.ip }}"; then \
      sleep 0.5; \
      continue; \
    fi; \
    if ! systemctl is-active --quiet hostapd; then \
      sleep 0.5; \
      continue; \
    fi; \
    echo "{{ network.wifi.interface }} is ready (UP, IP assigned, hostapd active)"; \
    exit 0; \
  done; \
  echo "ERROR: {{ network.wifi.interface }} not ready after 30 seconds"; \
  exit 1'
