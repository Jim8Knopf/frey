#!/bin/bash
# ==============================================================================
# FREY AP HEALTH CHECK
# ==============================================================================
# Monitors WiFi AP critical services and restarts them if failed.
# Runs every 5 minutes via systemd timer.
# ==============================================================================

# Source shared library
source /usr/local/lib/frey/frey-wifi-lib.sh

LOG_TAG="frey-ap-healthcheck"
AP_INTERFACE="{{ network.wifi.interface }}"
AP_IP="{{ network.wifi.ip }}"

# Check critical services
FAILED=0
check_and_restart_service hostapd "$LOG_TAG" || FAILED=$((FAILED + 1))
check_and_restart_service dnsmasq "$LOG_TAG" || FAILED=$((FAILED + 1))
check_and_restart_service dhcpcd "$LOG_TAG" || FAILED=$((FAILED + 1))

# Check AP interface exists and has IP
if ! has_ip_address "$AP_INTERFACE" "$AP_IP"; then
    log_to_system "$LOG_TAG" "ERROR: AP interface $AP_INTERFACE missing or no IP"
    restart_service_safe dhcpcd "$LOG_TAG"
    FAILED=$((FAILED + 1))
fi

# Check dnsmasq is actually listening on port 53
if ! ss -ulnp | grep -q ':53.*dnsmasq'; then
    log_to_system "$LOG_TAG" "ERROR: dnsmasq not listening on port 53"
    restart_service_safe dnsmasq "$LOG_TAG"
    FAILED=$((FAILED + 1))
fi

# Check hostapd is broadcasting (has connected stations or at least is running)
if ! is_hostapd_responding "$AP_INTERFACE"; then
    log_to_system "$LOG_TAG" "WARNING: hostapd_cli ping failed - hostapd may not be responding"
    FAILED=$((FAILED + 1))
fi

if [ "$FAILED" -eq 0 ]; then
    log_to_system "$LOG_TAG" "Health check PASSED - all services operational"
else
    log_to_system "$LOG_TAG" "Health check found $FAILED issues - attempted automatic recovery"
fi

exit 0
