#!/bin/bash
# ==============================================================================
# FREY AP HEALTH CHECK
# ==============================================================================
# Monitors WiFi AP critical services and restarts them if failed.
# Runs every 5 minutes via systemd timer.
# ==============================================================================

# Source shared library
source /usr/local/lib/frey/frey-wifi-lib.sh

LOG_TAG="frey-ap-healthcheck"
AP_INTERFACE="{{ network.wifi.interface }}"
AP_IP="{{ network.wifi.ip }}"

# Check critical services
FAILED=0
check_and_restart_service hostapd "$LOG_TAG" || FAILED=$((FAILED + 1))
check_and_restart_service dnsmasq "$LOG_TAG" || FAILED=$((FAILED + 1))
check_and_restart_service dhcpcd "$LOG_TAG" || FAILED=$((FAILED + 1))

# Check AP interface exists and has IP
if ! has_ip_address "$AP_INTERFACE" "$AP_IP"; then
    log_to_system "$LOG_TAG" "ERROR: AP interface $AP_INTERFACE missing or no IP"
    restart_service_safe dhcpcd "$LOG_TAG"
    FAILED=$((FAILED + 1))
fi

# Check dnsmasq is actually listening on port 53
if ! ss -ulnp | grep -q ':53.*dnsmasq'; then
    log_to_system "$LOG_TAG" "ERROR: dnsmasq not listening on port 53"
    restart_service_safe dnsmasq "$LOG_TAG"
    FAILED=$((FAILED + 1))
fi

# Check hostapd is broadcasting (has connected stations or at least is running)
if ! is_hostapd_responding "$AP_INTERFACE"; then
    log_to_system "$LOG_TAG" "WARNING: hostapd_cli ping failed - hostapd may not be responding"
    FAILED=$((FAILED + 1))
fi

# ==============================================================================
# Service Restart Monitoring (Stability)
# ==============================================================================
# Check for frequent service restarts which indicate instability

# Check hostapd restarts in last 10 minutes
HOSTAPD_RESTARTS=$(journalctl -u hostapd --since "10 minutes ago" | grep -c "Started\|Starting" || echo 0)
if [ "$HOSTAPD_RESTARTS" -gt 2 ]; then
    log_to_system "$LOG_TAG" "WARNING: hostapd restarted $HOSTAPD_RESTARTS times in 10 minutes - possible instability"
    FAILED=$((FAILED + 1))
fi

# Check dnsmasq restarts in last 10 minutes
DNSMASQ_RESTARTS=$(journalctl -u dnsmasq --since "10 minutes ago" | grep -c "Started\|Starting" || echo 0)
if [ "$DNSMASQ_RESTARTS" -gt 2 ]; then
    log_to_system "$LOG_TAG" "WARNING: dnsmasq restarted $DNSMASQ_RESTARTS times in 10 minutes - possible instability"
    FAILED=$((FAILED + 1))
fi

# Check dhcpcd restarts in last 10 minutes
DHCPCD_RESTARTS=$(journalctl -u dhcpcd --since "10 minutes ago" | grep -c "Started\|Starting" || echo 0)
if [ "$DHCPCD_RESTARTS" -gt 2 ]; then
    log_to_system "$LOG_TAG" "WARNING: dhcpcd restarted $DHCPCD_RESTARTS times in 10 minutes - possible instability"
    FAILED=$((FAILED + 1))
fi

if [ "$FAILED" -eq 0 ]; then
    log_to_system "$LOG_TAG" "Health check PASSED - all services operational"
else
    log_to_system "$LOG_TAG" "Health check found $FAILED issues - attempted automatic recovery"
fi

exit 0
