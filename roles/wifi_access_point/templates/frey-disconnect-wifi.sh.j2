#!/bin/bash
# ==============================================================================
# FREY WIFI DISCONNECTOR - Disconnect from Public WiFi
# ==============================================================================
# Disconnects wlan0 from public WiFi and stops wpa_supplicant
#
# USAGE:
#   sudo frey-disconnect-wifi
#
# NOTES:
# - Only disconnects wlan0 (doesn't touch wlan1 AP)
# - NAT Manager will automatically disable internet passthrough
# - FreyHub AP continues working (local network only)
# ==============================================================================

set -e

# Source shared library
source /usr/local/lib/frey/frey-wifi-lib.sh

# Configuration
INTERFACE="{{ network.wifi.client_interface }}"

# Check if running as root
require_root

log "Disconnecting from WiFi..."

# Stop dhcpcd on wlan0
kill_dhcpcd "$INTERFACE"

# Clear roaming lock if present
rm -f /var/run/frey-wifi-locked-ssid || true

# Disconnect wpa_supplicant
if is_wpa_supplicant_running "$INTERFACE"; then
    wpa_disconnect "$INTERFACE"
    sleep 1

    log "Stopping wpa_supplicant..."
    kill_wpa_supplicant "$INTERFACE"
fi

# Bring interface down
bring_interface_down "$INTERFACE"

log "Disconnected from WiFi"
log_warning "NAT Manager will detect disconnect and disable internet passthrough"
echo ""
log "FreyHub AP is still running (local network only)"
