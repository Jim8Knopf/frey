#!/bin/bash
# Auto-generated: monitors upstream connectivity for the WiFi client interface.
set -euo pipefail

# Source shared library
source /usr/local/lib/frey/frey-wifi-lib.sh

TARGET="{{ network.wifi.connectivity_monitor.ping_target | default(ansible_default_ipv4.gateway | default('1.1.1.1')) }}"
PING_COUNT={{ network.wifi.connectivity_monitor.ping_count | default(3) }}
INTERFACE="{{ network.wifi.client_interface }}"
FAIL_THRESHOLD={{ network.wifi.connectivity_monitor.failure_threshold | default(1) }}
STATE_DIR="/run/frey"
STATE_FILE="$STATE_DIR/wifi-healthcheck.failures"
LOGGER_TAG="frey-wifi-healthcheck"

ensure_directory "$STATE_DIR" 0755

current_failures=0
if [ -f "$STATE_FILE" ]; then
  current_failures=$(cat "$STATE_FILE" 2>/dev/null || echo 0)
fi

if check_internet_connectivity "$TARGET" "$INTERFACE" "$PING_COUNT"; then
  echo 0 >"$STATE_FILE"
  exit 0
fi

current_failures=$((current_failures + 1))
echo "$current_failures" >"$STATE_FILE"

if [ "$current_failures" -lt "$FAIL_THRESHOLD" ]; then
  log_to_system "$LOGGER_TAG" "Ping to $TARGET via $INTERFACE failed ($current_failures/$FAIL_THRESHOLD)"
  exit 0
fi

log_to_system "$LOGGER_TAG" "Connectivity lost via $INTERFACE; applying recovery actions"
echo 0 >"$STATE_FILE"

if interface_exists "$INTERFACE"; then
  bring_interface_down "$INTERFACE"
  sleep 1
  ip -4 addr flush dev "$INTERFACE" >/dev/null 2>&1 || true
  bring_interface_up "$INTERFACE"
fi

if command -v wpa_cli >/dev/null 2>&1; then
  wpa_reconnect "$INTERFACE"
fi

# Only restart services if dhcpcd is active (safety check for NetworkManager systems)
if check_service_active dhcpcd; then
  {% if network.wifi.connectivity_monitor.restart_wpa_supplicant | default(true) %}
  SERVICE_NAME="wpa_supplicant-{{ network.wifi.client_interface }}.service"
  if systemctl list-unit-files "$SERVICE_NAME" >/dev/null 2>&1; then
    systemctl restart "$SERVICE_NAME" || true
  fi
  {% endif %}
  {% if network.wifi.connectivity_monitor.restart_dhcpcd | default(true) %}
  systemctl restart dhcpcd || true
  {% endif %}
else
  log_to_system "$LOGGER_TAG" "Skipping service restart - dhcpcd not active (NetworkManager may be in use)"
fi
