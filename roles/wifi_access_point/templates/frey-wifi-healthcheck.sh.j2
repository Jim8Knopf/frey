#!/bin/bash
# Auto-generated: monitors upstream connectivity for the WiFi client interface.
set -euo pipefail

TARGET="{{ network.wifi.connectivity_monitor.ping_target | default(ansible_default_ipv4.gateway | default('1.1.1.1')) }}"
PING_COUNT={{ network.wifi.connectivity_monitor.ping_count | default(3) }}
INTERFACE="{{ network.wifi.client_interface }}"
FAIL_THRESHOLD={{ network.wifi.connectivity_monitor.failure_threshold | default(1) }}
STATE_DIR="/run/frey"
STATE_FILE="$STATE_DIR/wifi-healthcheck.failures"
LOGGER_TAG="frey-wifi-healthcheck"

mkdir -p "$STATE_DIR"
current_failures=0
if [ -f "$STATE_FILE" ]; then
  current_failures=$(cat "$STATE_FILE" 2>/dev/null || echo 0)
fi

if ping -I "$INTERFACE" -c "$PING_COUNT" -W 3 "$TARGET" >/dev/null 2>&1; then
  echo 0 >"$STATE_FILE"
  exit 0
fi

current_failures=$((current_failures + 1))
echo "$current_failures" >"$STATE_FILE"

if [ "$current_failures" -lt "$FAIL_THRESHOLD" ]; then
  logger -t "$LOGGER_TAG" "Ping to $TARGET via $INTERFACE failed ($current_failures/$FAIL_THRESHOLD)"
  exit 0
fi

logger -t "$LOGGER_TAG" "Connectivity lost via $INTERFACE; applying recovery actions"
echo 0 >"$STATE_FILE"

if ip link show "$INTERFACE" >/dev/null 2>&1; then
  ip link set "$INTERFACE" down >/dev/null 2>&1 || true
  sleep 1
  ip -4 addr flush dev "$INTERFACE" >/dev/null 2>&1 || true
  ip link set "$INTERFACE" up >/dev/null 2>&1 || true
fi

if command -v wpa_cli >/dev/null 2>&1; then
  wpa_cli -i "$INTERFACE" reconnect >/dev/null 2>&1 || true
fi

{% if network.wifi.connectivity_monitor.restart_wpa_supplicant | default(true) %}
SERVICE_NAME="wpa_supplicant-{{ network.wifi.client_interface }}.service"
if systemctl list-unit-files "$SERVICE_NAME" >/dev/null 2>&1; then
  systemctl restart "$SERVICE_NAME" || true
fi
{% endif %}
{% if network.wifi.connectivity_monitor.restart_dhcpcd | default(true) %}
systemctl restart dhcpcd || true
{% endif %}
