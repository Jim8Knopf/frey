#!/bin/bash
# ==============================================================================
# FREY WIFI TUI - Interactive WiFi Network Manager
# ==============================================================================
# Custom TUI for easy WiFi connection using dialog and wpa_supplicant
#
# USAGE:
#   sudo frey-wifi-tui
#
# FEATURES:
# - Visual list of all available WiFi networks with signal strength
# - Easy network selection with arrow keys
# - Password entry dialog
# - Connection status display
# - Only manages wlan0 (doesn't touch wlan1 AP)
# ==============================================================================

set -e

# Configuration
INTERFACE="wlan0"
WPA_CONF="/etc/wpa_supplicant/wpa_supplicant-wlan0.conf"
WPA_CTRL="/var/run/wpa_supplicant"
TEMP_FILE="/tmp/frey-wifi-tui.$$"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Cleanup on exit
trap 'rm -f "$TEMP_FILE"*' EXIT

log() {
    echo -e "${GREEN}[$(date '+%H:%M:%S')]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    dialog --title "Error" --msgbox "This tool must be run as root.\n\nPlease run: sudo $0" 8 50
    exit 1
fi

# Check if dialog is installed
if ! command -v dialog >/dev/null 2>&1; then
    echo "ERROR: dialog is not installed"
    echo "Install with: sudo apt install dialog"
    exit 1
fi

# Check if interface exists
if ! ip link show "$INTERFACE" &>/dev/null; then
    dialog --title "Error" --msgbox "WiFi interface $INTERFACE not found!" 6 50
    exit 1
fi

# Bring interface up
ip link set "$INTERFACE" up 2>/dev/null || true
sleep 1

# Start wpa_supplicant if not running
if ! pgrep -f "wpa_supplicant.*$INTERFACE" >/dev/null; then
    # Create config if it doesn't exist
    if [ ! -f "$WPA_CONF" ]; then
        mkdir -p "$(dirname "$WPA_CONF")"
        cat > "$WPA_CONF" << EOF
ctrl_interface=$WPA_CTRL
update_config=1
country={{ network.wifi.country | default('US') }}
EOF
        chmod 600 "$WPA_CONF"
    fi

    wpa_supplicant -B -i "$INTERFACE" -c "$WPA_CONF" -P /var/run/wpa_supplicant-wlan0.pid 2>/dev/null
    sleep 2
fi

# Main menu loop
while true; do
    # Show main menu
    choice=$(dialog --clear --title "Frey WiFi Manager" \
        --menu "Choose an action:" 15 60 4 \
        1 "Scan and connect to WiFi network" \
        2 "Disconnect from WiFi" \
        3 "Show current status" \
        4 "Exit" \
        2>&1 >/dev/tty)

    case $choice in
        1)  # Scan and connect
            dialog --title "Scanning" --infobox "Scanning for WiFi networks...\nPlease wait..." 5 50

            # Scan for networks
            wpa_cli -i "$INTERFACE" scan >/dev/null 2>&1
            sleep 3

            # Get scan results and format them
            scan_results=$(wpa_cli -i "$INTERFACE" scan_results 2>/dev/null | grep "^bssid" -A 100 | tail -n +2)

            if [ -z "$scan_results" ]; then
                dialog --title "Error" --msgbox "No WiFi networks found.\n\nMake sure WiFi is enabled and try again." 8 50
                continue
            fi

            # Parse networks and create menu
            menu_items=()
            network_map=()
            counter=1

            while IFS= read -r line; do
                ssid=$(echo "$line" | awk -F'\t' '{print $5}')
                signal=$(echo "$line" | awk -F'\t' '{print $3}')
                flags=$(echo "$line" | awk -F'\t' '{print $4}')

                # Skip empty SSIDs
                [ -z "$ssid" ] && continue

                # Determine security type
                if echo "$flags" | grep -q "WPA"; then
                    security="WPA"
                elif echo "$flags" | grep -q "WEP"; then
                    security="WEP"
                else
                    security="Open"
                fi

                # Calculate signal bars
                if [ "$signal" -ge -50 ]; then
                    bars="▮▮▮▮"
                elif [ "$signal" -ge -60 ]; then
                    bars="▮▮▮▯"
                elif [ "$signal" -ge -70 ]; then
                    bars="▮▮▯▯"
                else
                    bars="▮▯▯▯"
                fi

                menu_items+=("$counter" "$ssid [$bars] $security")
                network_map[$counter]="$ssid|$security"
                counter=$((counter + 1))
            done <<< "$scan_results"

            # Show network selection menu
            selected=$(dialog --clear --title "Available WiFi Networks" \
                --menu "Select a network to connect:" 20 70 12 \
                "${menu_items[@]}" \
                2>&1 >/dev/tty)

            if [ -z "$selected" ]; then
                continue
            fi

            # Get selected network info
            network_info="${network_map[$selected]}"
            selected_ssid=$(echo "$network_info" | cut -d'|' -f1)
            selected_security=$(echo "$network_info" | cut -d'|' -f2)

            # Get password if needed
            password=""
            if [ "$selected_security" != "Open" ]; then
                password=$(dialog --clear --title "WiFi Password" \
                    --insecure --passwordbox "Enter password for:\n$selected_ssid" 10 60 \
                    2>&1 >/dev/tty)

                if [ -z "$password" ]; then
                    dialog --title "Cancelled" --msgbox "Connection cancelled." 6 40
                    continue
                fi
            fi

            # Connect to network
            (
                echo "10" ; sleep 0.5
                echo "# Adding network configuration..."

                # Add network
                network_id=$(wpa_cli -i "$INTERFACE" add_network | tail -1)

                echo "30" ; sleep 0.3
                echo "# Configuring SSID..."
                wpa_cli -i "$INTERFACE" set_network "$network_id" ssid "\"$selected_ssid\"" >/dev/null

                echo "50" ; sleep 0.3

                if [ "$selected_security" = "Open" ]; then
                    echo "# Configuring open network..."
                    wpa_cli -i "$INTERFACE" set_network "$network_id" key_mgmt NONE >/dev/null
                else
                    echo "# Configuring password..."
                    wpa_cli -i "$INTERFACE" set_network "$network_id" psk "\"$password\"" >/dev/null
                fi

                echo "70" ; sleep 0.3
                echo "# Enabling network..."
                wpa_cli -i "$INTERFACE" enable_network "$network_id" >/dev/null
                wpa_cli -i "$INTERFACE" save_config >/dev/null

                echo "85" ; sleep 2
                echo "# Waiting for connection..."
                sleep 3

                echo "95" ; sleep 0.5
                echo "# Getting IP address..."
                dhcpcd "$INTERFACE" >/dev/null 2>&1 || true
                sleep 2

                echo "100"
                echo "# Connection complete!"
                sleep 1
            ) | dialog --title "Connecting to WiFi" --gauge "Initializing..." 10 60 0

            # Check if connected
            if wpa_cli -i "$INTERFACE" status | grep -q "wpa_state=COMPLETED"; then
                ip_addr=$(ip -4 addr show "$INTERFACE" | grep inet | awk '{print $2}' | cut -d/ -f1)

                if [ -n "$ip_addr" ]; then
                    dialog --title "Success!" --msgbox "Connected to: $selected_ssid\n\nIP Address: $ip_addr\n\nInternet passthrough will be enabled automatically by the NAT Manager." 12 60
                else
                    dialog --title "Warning" --msgbox "Connected to WiFi but no IP address.\n\nTry running: sudo dhcpcd $INTERFACE" 10 60
                fi
            else
                dialog --title "Connection Failed" --msgbox "Failed to connect to: $selected_ssid\n\nPlease check:\n- Password is correct\n- Signal strength is good\n- Network is available" 12 60
                wpa_cli -i "$INTERFACE" remove_network "$network_id" >/dev/null 2>&1 || true
            fi
            ;;

        2)  # Disconnect
            if wpa_cli -i "$INTERFACE" disconnect >/dev/null 2>&1; then
                dhcpcd -k "$INTERFACE" 2>/dev/null || true
                dialog --title "Disconnected" --msgbox "Disconnected from WiFi.\n\nFreyHub AP is still running." 8 50
            else
                dialog --title "Error" --msgbox "Not connected to any network." 6 40
            fi
            ;;

        3)  # Show status
            status_output="Interface: $INTERFACE\n"
            status_output+="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n"

            # Get connection status
            if wpa_cli -i "$INTERFACE" status | grep -q "wpa_state=COMPLETED"; then
                connected_ssid=$(wpa_cli -i "$INTERFACE" status | grep "^ssid=" | cut -d'=' -f2)
                ip_addr=$(ip -4 addr show "$INTERFACE" | grep inet | awk '{print $2}' | cut -d/ -f1)
                gateway=$(ip route | grep "default.*$INTERFACE" | awk '{print $3}')

                status_output+="Status: Connected ✓\n"
                status_output+="Network: $connected_ssid\n"
                status_output+="IP Address: ${ip_addr:-N/A}\n"
                status_output+="Gateway: ${gateway:-N/A}\n"
            else
                status_output+="Status: Disconnected\n"
            fi

            dialog --title "WiFi Status" --msgbox "$status_output" 14 50
            ;;

        4|"")  # Exit
            clear
            log "WiFi TUI Manager closed"
            echo ""
            info "FreyHub AP is still running on wlan1"
            info "Check NAT status: sudo journalctl -u frey-nat-manager -n 10"
            echo ""
            exit 0
            ;;
    esac
done
