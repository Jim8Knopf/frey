# Basic DHCP and DNS server configuration
port=53
interface={{ wifi.interface }}
bind-interfaces
listen-address={{ wifi.ip }}

# Process settings
user=root
group=root
pid-file=/var/run/dnsmasq/dnsmasq.pid

# DHCP configuration
dhcp-range={{ wifi.dhcp_range_start }},{{ wifi.dhcp_range_end }},255.255.255.0,12h
dhcp-authoritative
dhcp-leasefile=/var/lib/misc/dnsmasq.leases
dhcp-lease-max=40
dhcp-option=3,{{ wifi.ip }}  # Set default gateway
dhcp-option=6,{{ wifi.ip }}  # Set DNS server to be the AP itself
dhcp-broadcast

# DNS settings
no-resolv
no-poll
server=8.8.8.8
server=8.8.4.4
domain={{ network.domain_name | default('frey') }}
local=/{{ network.domain_name | default('frey') }}/
domain-needed
bogus-priv
expand-hosts

# Logging
log-queries
log-dhcp
log-facility=/var/log/dnsmasq.log
log-debug

# DNS rewrites for local services
# Point all .frey domains to the WiFi AP gateway IP so clients on the AP network
# can access services. The Pi will route traffic appropriately.
{% if network.dns_rewrites is defined %}
{% for service in network.dns_rewrites %}
address=/{{ service.name }}.{{ network.domain_name }}/{{ wifi.ip }}
{% endfor %}
{% endif %}
