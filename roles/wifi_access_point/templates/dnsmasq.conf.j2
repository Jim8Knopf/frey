# ==============================================================================
# DNSMASQ CONFIGURATION - WiFi Access Point
# ==============================================================================
# Provides DNS resolution and DHCP services for WiFi AP clients.
#
# KEY FEATURES:
# - DNS caching for 50-100ms faster lookups (70-80% cache hit rate)
# - DHCP server for automatic IP assignment to WiFi clients
# - Local domain (.frey) resolution for internal services
# - Wildcard DNS to route all *.frey to Traefik reverse proxy
# - Upstream DNS forwarding (Cloudflare/Google plus uplink-provided servers)
#
# PERFORMANCE: With caching enabled, most DNS queries return in <10ms
# SECURITY: DNS rebinding protection enabled, localhost responses allowed
# ==============================================================================

# ------------------------------------------------------------------------------
# BASIC CONFIGURATION
# ------------------------------------------------------------------------------

# DNS port - standard port 53 for DNS queries
port=53

# Bind to specific interface only (security: don't respond to queries from other interfaces)
# This prevents DNS leaks and ensures only WiFi AP clients can use this DNS server
bind-interfaces
listen-address={{ network.wifi.ip }}

# PID file location for process management
pid-file=/var/run/dnsmasq/dnsmasq.pid

# Listen on WiFi AP interface only
interface={{ network.wifi.interface }}
except-interface=lo

# ------------------------------------------------------------------------------
# DHCP SERVER CONFIGURATION
# ------------------------------------------------------------------------------
# Automatically assigns IP addresses to WiFi clients when they connect

# DHCP range: {{ network.wifi.dhcp_range_start }} to {{ network.wifi.dhcp_range_end }}
# Netmask: 255.255.255.0 (10.20.0.0/24)
# Lease time: 12 hours (clients keep their IP for 12h even if disconnected briefly)
dhcp-range={{ network.wifi.dhcp_range_start }},{{ network.wifi.dhcp_range_end }},255.255.255.0,12h

# We are the authoritative DHCP server on this network (faster DHCP, no delays)
dhcp-authoritative

# Store DHCP leases persistently (survives dnsmasq restart)
dhcp-leasefile=/var/lib/misc/dnsmasq.leases

# ------------------------------------------------------------------------------
# DHCP OPTIONS - Configuration sent to WiFi clients
# ------------------------------------------------------------------------------

# Option 3: Default gateway (where to send internet traffic)
# WiFi clients route all internet traffic through the Pi
dhcp-option=3,{{ network.wifi.ip }}

# Option 6: DNS server (where to resolve domain names)
# WiFi clients use this dnsmasq server for all DNS lookups
dhcp-option=6,{{ network.wifi.ip }}

# ------------------------------------------------------------------------------
# LOCAL DOMAIN CONFIGURATION (.frey domain)
# ------------------------------------------------------------------------------
# All services are accessible via *.frey domain names

# Set local domain name
domain={{ network.domain_name }}

# Automatically append domain to hostnames (e.g., "jellyfin" becomes "jellyfin.frey")
expand-hosts

# Keep .frey domain queries local (don't forward to upstream DNS)
# This prevents DNS leaks and speeds up local service lookups
local=/{{ network.domain_name }}/

# ------------------------------------------------------------------------------
# HOST RECORDS - Specific service DNS entries
# ------------------------------------------------------------------------------
# These map service names to the Pi's IP address
# Example: jellyfin.frey → 10.20.0.1 → Traefik → jellyfin container

{% if network.dns_rewrites is defined %}
{% for service in network.dns_rewrites %}
{% set host_name = service.host | default(service.name ~ '.' ~ network.domain_name) %}
host-record={{ host_name }},{{ network.wifi.ip }}
{% endfor %}
{% endif %}

# ------------------------------------------------------------------------------
# WILDCARD DNS - Catch-all for any *.frey domain
# ------------------------------------------------------------------------------
# ANY subdomain of .frey resolves to the Pi's IP
# This ensures all services work even if not explicitly defined above
# Example: newservice.frey → 10.20.0.1 (then Traefik routes based on Host header)

address=/.{{ network.domain_name }}/{{ network.wifi.ip }}

# ------------------------------------------------------------------------------
# DNS CACHING - Performance Optimization
# ------------------------------------------------------------------------------
# Caching dramatically speeds up DNS queries and reduces upstream traffic

# Cache size: 1000 DNS responses (sufficient for typical use)
# PERFORMANCE: Cached queries return in <10ms vs 20-100ms for upstream queries
# BENEFIT: Reduces load on upstream DNS, works better on slow/congested public WiFi
cache-size=1000

# Negative caching: Remember "domain not found" responses for 60 seconds
# Prevents repeated lookups for typos or non-existent domains
neg-ttl=60

# Minimum cache TTL: Keep responses cached for at least 5 minutes
# Even if upstream DNS says TTL=0, we cache for 5min to reduce query load
# TRADE-OFF: Slightly stale DNS (max 5min) for much better performance
min-cache-ttl=300

# Maximum concurrent DNS queries
# Prevents resource exhaustion if many clients query simultaneously
dns-forward-max=150

# ------------------------------------------------------------------------------
# UPSTREAM DNS SERVERS
# ------------------------------------------------------------------------------
# Forward queries for external domains (not *.frey) to these DNS providers

# Primary upstream DNS resolvers (queried first)
{% set upstream_dns_servers = network.wifi.upstream_dns_servers | default(['1.1.1.1', '8.8.8.8']) %}
{% for resolver in upstream_dns_servers %}
server={{ resolver }}
{% endfor %}

{% if network.wifi.use_system_dns | default(true) %}
# Also trust DNS servers learned from the upstream interface (hotels often block public resolvers)
resolv-file={{ network.wifi.system_resolv_conf | default('/etc/resolv.conf') }}
{% else %}
# Stick to the hardcoded upstream servers only
no-resolv

# Don't monitor resolv.conf for changes when we ignore upstream DHCP DNS
no-poll
{% endif %}

# Don't read /etc/hosts file (we define our hosts explicitly above)
# Faster startup, no conflicts with system hosts file
no-hosts

# ------------------------------------------------------------------------------
# SECURITY CONFIGURATION
# ------------------------------------------------------------------------------

# Prevent DNS rebinding attacks
# Blocks responses with private IP addresses (192.168.x.x, 10.x.x.x) from external queries
# Protects against attackers trying to access internal network via DNS tricks
stop-dns-rebind

# Allow localhost responses (needed for local services)
rebind-localhost-ok

# Block specific private address ranges from being returned by upstream DNS
# Additional protection against DNS rebinding
rebind-domain-ok=/{{ network.domain_name }}/

# ------------------------------------------------------------------------------
# LOGGING CONFIGURATION
# ------------------------------------------------------------------------------
# Keep logging minimal by default for performance
# Uncomment for troubleshooting DNS or DHCP issues

# Uncomment to log all DNS queries (useful for debugging)
log-queries

# Uncomment to log DHCP transactions (useful for debugging WiFi client connections)
#log-dhcp

# Log to syslog with facility (default: daemon)
# View logs with: journalctl -u dnsmasq
log-facility=daemon
