# ==============================================================================
# DHCPCD CONFIGURATION - Network Interface Management
# ==============================================================================
# Manages network interface configuration for dual-mode WiFi operation:
# - One interface connects to upstream (home network or public WiFi)
# - Other interface broadcasts WiFi Access Point
#
# DYNAMIC MODE: Automatically adapts based on which interface has upstream
# STATIC AP: WiFi AP interface always has fixed IP (10.20.0.1)
# ==============================================================================

# ------------------------------------------------------------------------------
# GLOBAL DHCPCD SETTINGS
# ------------------------------------------------------------------------------

# Set system hostname based on DHCP if available
hostname

# Generate RFC4361-compliant client identifier for DHCP
# Uses hardware address + IAID for unique identification
clientid

# Persist lease information across reboots
# Allows faster reconnection without full DHCP negotiation
persistent

# Request rapid commit from DHCP server (faster IP acquisition)
# Server can respond with IP in single message instead of 4-message handshake
option rapid_commit

# Request standard DHCP options from server
option domain_name_servers     # DNS servers (e.g., 8.8.8.8, 1.1.1.1)
option domain_name             # Domain name (e.g., "home.local")
option domain_search           # Domain search list
option host_name               # Hostname
option classless_static_routes # Static routes (for complex networks)
option interface_mtu           # MTU size (usually 1500 for Ethernet, varies for others)

# Require DHCP server identifier in responses
# Security: Prevents rogue DHCP servers from responding
# NOTE: Commented out for compatibility with captive portal networks
#       Many public WiFi DHCP servers don't send this option correctly
# require dhcp_server_identifier

# ------------------------------------------------------------------------------
# CLIENT INTERFACE CONFIGURATION (Upstream Connection)
# ------------------------------------------------------------------------------
# This interface connects to home network or public WiFi for internet access
# It uses DHCP to automatically get IP, gateway, and DNS from upstream

# Interface: {{ network.wifi.client_interface }}
# PURPOSE: Connect to internet (home router or public WiFi)
# BEHAVIOR: Gets IP via DHCP automatically
interface {{ network.wifi.client_interface }}

# Routing metric (priority): Lower = preferred
# 100 = high priority, use this interface for default route first
# If this interface goes down, system falls back to other interfaces
metric 100

# Skip ARP check before accepting DHCP lease (faster, needed for some captive portals)
# Some captive portal networks have slow/broken ARP, which causes dhcpcd to timeout
# The connection script already uses --noarp flag, make it permanent here
noarp

# WPA SUPPLICANT HOOK ENABLED
# dhcpcd will now properly coordinate with wpa_supplicant for stable connections
# Note: Roaming daemon should be disabled when using this configuration

# WAIT FOR IP ADDRESS
# Block until IPv4 address is obtained or timeout occurs
# This ensures proper DHCP completion and prevents silent failures
# The AP interface (wlan1) can still come up independently
waitip 4
timeout 30   # Most DHCP servers respond in <5s; 30s is sufficient for detection
             # If DHCP fails, frey-connect-wifi.sh will retry with different methods

# LINK-LOCAL FALLBACK ENABLED
# Allow 169.254.x.x fallback if DHCP fails completely
# Provides graceful degradation instead of complete failure
# noipv4ll  # REMOVED: Enable fallback for resilience

# AUTOMATIC RETRY ON FAILURE
# Wait 10 seconds before retrying DHCP after failure
reboot 10

# ------------------------------------------------------------------------------
# ACCESS POINT INTERFACE CONFIGURATION (WiFi AP)
# ------------------------------------------------------------------------------
# This interface broadcasts the WiFi Access Point with static configuration
# It must have a fixed IP so dnsmasq can provide DHCP/DNS services

# Interface: {{ network.wifi.interface }}
# PURPOSE: Broadcast WiFi AP for clients to connect
# BEHAVIOR: Static IP, no DHCP client, no WPA supplicant
interface {{ network.wifi.interface }}

# STATIC IP CONFIGURATION
# IP Address: {{ network.wifi.ip }}/24 (10.20.0.1 with netmask 255.255.255.0)
# This is the gateway for WiFi clients and the DNS/DHCP server address
static ip_address={{ network.wifi.ip }}/24

# NO GATEWAY FOR AP INTERFACE
# This interface is the gateway itself, not a client
# Prevents dhcpcd from trying to set a default route via this interface
nogateway

# DISABLE WPA SUPPLICANT
# Don't try to connect to other WiFi networks on this interface
# This interface is for BROADCASTING, not connecting
nohook wpa_supplicant

# DISABLE IPv6
# Simplifies configuration, most home setups don't need IPv6
# Re-enable if you need IPv6: remove this line and configure static IPv6
noipv6

# DISABLE IPv4 LINK-LOCAL (169.254.x.x)
# Don't fall back to self-assigned IP if static config fails
# If static IP fails, we want to know immediately, not silently use 169.254.x.x
noipv4ll

# ROUTING METRIC
# 200 = lower priority than client interface (100)
# Traffic prefers client interface for internet, only uses AP for local
metric 200

# ------------------------------------------------------------------------------
# CONFIGURATION NOTES
# ------------------------------------------------------------------------------
#
# INTERFACE PRIORITY:
# - Client interface (metric 100) = preferred for internet traffic
# - AP interface (metric 200) = only for local WiFi AP traffic
#
# DHCP vs STATIC:
# - Client interface = DHCP (automatic, adapts to any network)
# - AP interface = Static (fixed, required for DHCP/DNS server)
#
# DUAL-MODE OPERATION:
# This configuration supports dual-mode where Pi can:
# 1. Connect to home network (192.168.0.x) OR public WiFi
# 2. Simultaneously broadcast its own WiFi AP (10.20.0.x)
# 3. Share internet from upstream to WiFi clients (NAT passthrough)
#
# TROUBLESHOOTING:
# - Check interface status: ip addr show
# - Check routing table: ip route show
# - Check DHCP leases: cat /var/lib/dhcpcd/*.lease
# - View dhcpcd logs: journalctl -u dhcpcd
# ==============================================================================
