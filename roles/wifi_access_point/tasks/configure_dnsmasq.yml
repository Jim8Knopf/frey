---
# Tasks for managing dnsmasq service
- name: Stop dnsmasq if running
  ansible.builtin.service:
    name: dnsmasq
    state: stopped

- name: Create required directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: dnsmasq
    group: dnsmasq
    mode: '0755'
  with_items:
    - /var/run/dnsmasq
    - /var/lib/misc
    - /etc/dnsmasq.d

- name: Configure dnsmasq service dependencies
  ansible.builtin.copy:
    dest: /etc/systemd/system/dnsmasq.service.d/override.conf
    content: |
      [Unit]
      Requires=network.target
      After=network.target
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=forking
      RestartSec=5
      Restart=on-failure
    mode: '0644'

- name: Configure dnsmasq
  ansible.builtin.template:
    src: dnsmasq.conf.j2
    dest: /etc/dnsmasq.d/01-wifi-ap.conf
    owner: root
    group: root
    mode: '0644'

- name: Verify configuration
  ansible.builtin.command: dnsmasq --test
  register: dnsmasq_test
  changed_when: false

- name: Ensure interface has IP
  ansible.builtin.shell: |
    ip addr show {{ network.wifi.interface }} | grep -q {{ network.wifi.ip }}
  register: interface_check
  changed_when: false

- name: Start dnsmasq service
  ansible.builtin.systemd:
    name: dnsmasq
    state: restarted
    enabled: yes
    daemon_reload: yes
  when: dnsmasq_test.rc == 0 and interface_check.rc == 0

- name: Wait for dnsmasq to be ready
  ansible.builtin.wait_for:
    path: /var/run/dnsmasq/dnsmasq.pid
    timeout: 30
  when: dnsmasq_test.rc == 0 and interface_check.rc == 0

- name: Wait for DNS port
  ansible.builtin.wait_for:
    port: 53
    host: "{{ network.wifi.ip }}"
    timeout: 30
  when: dnsmasq_test.rc == 0 and interface_check.rc == 0