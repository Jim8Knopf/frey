---
# roles/wifi_access_point/tasks/main.yml
# Final clean single-document tasks for AP bring-up.

- name: Assert required wifi variables are defined
  ansible.builtin.assert:
    that:
      - network.wifi.interface is defined
      - network.wifi.ssid is defined
      - network.wifi.password is defined
      - network.wifi.ip is defined
      - network.wifi.dhcp_range_start is defined
      - network.wifi.dhcp_range_end is defined
    msg: "Required wifi_access_point variables missing. See roles/wifi_access_point/README.md"

- name: Fail if attempting to configure the control interface (avoid disconnecting admin)
  ansible.builtin.fail:
    msg: "Refusing to modify {{ network.wifi.interface }} because it matches the control interface {{ ansible_default_ipv4.interface }}. Set network.wifi.interface to a secondary adapter (e.g. wlan1) or set force_apply=true to override."
  when:
    - (network.wifi.interface == ansible_default_ipv4.interface) and (force_apply | default(false) | bool) == false

- name: Install packages required for AP
  ansible.builtin.apt:
    name: "{{ wifi_ap_packages | default(['hostapd','dnsmasq','rfkill','iw','dhcpcd5','wpasupplicant','dialog']) }}"
    state: present
    update_cache: yes

- name: Check which conflicting services exist
  ansible.builtin.systemd:
    name: "{{ item }}"
  loop:
    - systemd-resolved
    - NetworkManager
    - wpa_supplicant
    - dialog
  register: service_check
  failed_when: false
  changed_when: false

- name: Stop and disable conflicting services (best-effort)
  ansible.builtin.systemd:
    name: "{{ item.item }}"
    state: stopped
    enabled: no
    masked: yes
  loop: "{{ service_check.results }}"
  when: item.status is defined and item.status.LoadState == "loaded"
  ignore_errors: yes

- name: Deploy dhcpcd configuration for the AP
  ansible.builtin.template:
    src: dhcpcd.conf.j2
    dest: /etc/dhcpcd.conf
    mode: '0644'
    backup: yes

- name: Restart dhcpcd
  ansible.builtin.service:
    name: dhcpcd
    state: restarted
    enabled: yes

- name: Wait for AP IP to be present on the host
  ansible.builtin.wait_for:
    host: "{{ network.wifi.ip }}"
    timeout: 20

- name: Unblock all WiFi devices via rfkill (Critical for AP startup)
  ansible.builtin.command:
    cmd: rfkill unblock wifi
  changed_when: true
  failed_when: false

- name: Bring up WiFi AP interface unconditionally
  ansible.builtin.command:
    cmd: ip link set {{ network.wifi.interface }} up
  changed_when: true
  failed_when: false

- name: Deploy hostapd configuration
  ansible.builtin.template:
    src: hostapd.conf.j2
    dest: /etc/hostapd/hostapd.conf
    mode: '0644'

- name: Ensure hostapd points at the service config
  ansible.builtin.lineinfile:
    path: /etc/default/hostapd
    regexp: '^#?DAEMON_CONF='
    line: 'DAEMON_CONF="/etc/hostapd/hostapd.conf"'

- name: Unmask hostapd service (required on fresh Raspberry Pi OS)
  ansible.builtin.systemd:
    name: hostapd
    masked: no

- name: Start hostapd
  block:
    - name: Try to reconfigure hostapd (if already running)
      ansible.builtin.command:
        cmd: hostapd_cli -i {{ network.wifi.interface }} reconfigure
      register: hostapd_reconf
      changed_when: hostapd_reconf.rc == 0
      failed_when: false

    - name: Start hostapd if it was not running or reconfigure failed
      ansible.builtin.service:
        name: hostapd
        state: started
        enabled: yes
      when: hostapd_reconf is not defined or hostapd_reconf.rc != 0

  rescue:
    - name: Ensure hostapd service is started (rescue)
      ansible.builtin.service:
        name: hostapd
        state: started
        enabled: yes

- name: Pause briefly to let hostapd initialize
  ansible.builtin.pause:
    seconds: 3

- name: Backup and disable main dnsmasq.conf to prevent conflicts
  ansible.builtin.copy:
    content: |
      # Main dnsmasq.conf disabled by Ansible wifi_access_point role
      # All configuration is in /etc/dnsmasq.d/01-wifi-ap.conf
      # This prevents conflicts with the WiFi AP DHCP/DNS configuration

      # Read configuration from /etc/dnsmasq.d/ directory
      conf-dir=/etc/dnsmasq.d/,.dpkg-dist,.dpkg-old,.dpkg-new
    dest: /etc/dnsmasq.conf
    backup: yes
    mode: '0644'

- name: Ensure dnsmasq directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /var/run/dnsmasq
    - /var/lib/misc
    - /etc/dnsmasq.d

- name: Ensure dnsmasq leases file exists
  ansible.builtin.file:
    path: /var/lib/misc/dnsmasq.leases
    state: touch
    mode: '0644'

- name: Deploy dnsmasq config snippet for AP
  ansible.builtin.template:
    src: dnsmasq.conf.j2
    dest: /etc/dnsmasq.d/01-wifi-ap.conf
    mode: '0644'

- name: Create dnsmasq systemd override directory
  ansible.builtin.file:
    path: /etc/systemd/system/dnsmasq.service.d
    state: directory
    mode: '0755'

- name: Deploy dnsmasq systemd override (fix race condition)
  ansible.builtin.template:
    src: dnsmasq-override.conf.j2
    dest: /etc/systemd/system/dnsmasq.service.d/override.conf
    mode: '0644'

- name: Deploy Frey NAT Manager script
  ansible.builtin.template:
    src: frey-nat-manager.sh.j2
    dest: /usr/local/bin/frey-nat-manager.sh
    mode: '0755'

- name: Deploy Frey NAT Manager service
  ansible.builtin.template:
    src: frey-nat-manager.service.j2
    dest: /etc/systemd/system/frey-nat-manager.service
    mode: '0644'

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Unmask dnsmasq service (required on fresh Raspberry Pi OS)
  ansible.builtin.systemd:
    name: dnsmasq
    masked: no

- name: Test dnsmasq configuration
  ansible.builtin.command: dnsmasq --test
  register: dnsmasq_test
  changed_when: false
  failed_when: dnsmasq_test.rc != 0

- name: Force restart dnsmasq to apply new configuration
  ansible.builtin.service:
    name: dnsmasq
    state: restarted
    enabled: yes
  when: dnsmasq_test.rc == 0

- name: Enable and start Frey NAT Manager service
  ansible.builtin.service:
    name: frey-nat-manager
    state: started
    enabled: yes

- name: Wait for dnsmasq to bind on port 53 (DNS)
  ansible.builtin.wait_for:
    host: "{{ network.wifi.ip }}"
    port: 53
    timeout: 30

- name: Verify dnsmasq is listening on DHCP port 67
  ansible.builtin.shell: ss -ulnp | grep ':67' || echo "DHCP_NOT_LISTENING"
  register: dhcp_check
  changed_when: false
  failed_when: "'DHCP_NOT_LISTENING' in dhcp_check.stdout"

- name: Display dnsmasq listening ports
  ansible.builtin.shell: ss -ulnp | grep dnsmasq
  register: dnsmasq_ports
  changed_when: false

- name: Show dnsmasq listening status
  ansible.builtin.debug:
    msg: |
      dnsmasq is listening on:
      {{ dnsmasq_ports.stdout_lines | join('\n') }}

- name: Read DHCP leases (best-effort)
  ansible.builtin.command: cat /var/lib/misc/dnsmasq.leases
  register: dhcp_leases
  changed_when: false
  failed_when: false

- name: Deploy WiFi connection helper script
  ansible.builtin.template:
    src: frey-connect-wifi.sh.j2
    dest: /usr/local/bin/frey-connect-wifi
    mode: '0755'

- name: Deploy WiFi disconnection helper script
  ansible.builtin.template:
    src: frey-disconnect-wifi.sh.j2
    dest: /usr/local/bin/frey-disconnect-wifi
    mode: '0755'

- name: Deploy WiFi TUI script
  ansible.builtin.template:
    src: frey-wifi-tui.sh.j2
    dest: /usr/local/bin/frey-wifi-tui
    mode: '0755'

- name: Deploy WiFi connection guide
  ansible.builtin.copy:
    src: CONNECT-TO-WIFI.md
    dest: "{{ storage.base_dir | default('/opt/frey') }}/CONNECT-TO-WIFI.md"
    mode: '0644'

# ==============================================================================
# BLOCK DNS-over-HTTPS (DoH) - Force clients to use local DNS
# ==============================================================================
# Modern browsers and OS use DoH by default, bypassing local DNS servers.
# This breaks .frey domain resolution even though clients are configured to use 10.20.0.1 DNS.
# Solution: Block HTTPS (port 443) connections to known DoH providers, forcing clients to use standard DNS.

- name: Block Google DoH servers (8.8.8.8, 8.8.4.4) to force local DNS usage
  community.general.ufw:
    rule: reject
    proto: tcp
    to_ip: "{{ item }}"
    to_port: '443'
    from_ip: "{{ network.wifi.network | default('10.20.0.0/24') }}"
    comment: "WIFI_AP: Block DoH to force local DNS"
  loop:
    - 8.8.8.8
    - 8.8.4.4
  ignore_errors: yes

- name: Block Cloudflare DoH servers (1.1.1.1, 1.0.0.1) to force local DNS usage
  community.general.ufw:
    rule: reject
    proto: tcp
    to_ip: "{{ item }}"
    to_port: '443'
    from_ip: "{{ network.wifi.network | default('10.20.0.0/24') }}"
    comment: "WIFI_AP: Block DoH to force local DNS"
  loop:
    - 1.1.1.1
    - 1.0.0.1
  ignore_errors: yes

- name: Block Quad9 DoH servers (9.9.9.9, 149.112.112.112) to force local DNS usage
  community.general.ufw:
    rule: reject
    proto: tcp
    to_ip: "{{ item }}"
    to_port: '443'
    from_ip: "{{ network.wifi.network | default('10.20.0.0/24') }}"
    comment: "WIFI_AP: Block DoH to force local DNS"
  loop:
    - 9.9.9.9
    - 149.112.112.112
  ignore_errors: yes

- name: Display concise AP status
  ansible.builtin.debug:
    msg: |
      WiFi AP Summary:
      Interface: {{ network.wifi.interface }} ({{ network.wifi.ip }})
      SSID: {{ network.wifi.ssid }}
      Hostapd: {{ 'running' if (ansible_facts.services is defined and ansible_facts.services['hostapd.service'] is defined and ansible_facts.services['hostapd.service'].state == 'running') else 'unknown' }}
      dnsmasq: {{ 'running' if (ansible_facts.services is defined and ansible_facts.services['dnsmasq.service'] is defined and ansible_facts.services['dnsmasq.service'].state == 'running') else 'unknown' }}
      DHCP leases entries: {{ dhcp_leases.stdout_lines | length }}

      WiFi Connection Tools:
      - TUI Manager (easiest): sudo frey-wifi-tui
      - CLI Connect: sudo frey-connect-wifi "WiFiName" "password"
      - CLI Disconnect: sudo frey-disconnect-wifi
      - Documentation: {{ storage.base_dir | default('/opt/frey') }}/CONNECT-TO-WIFI.md

# ==============================================================================
# AUTOMATIC WIFI ROAMING SYSTEM
# ==============================================================================

- name: Install WiFi roaming dependencies
  ansible.builtin.apt:
    name:
      - w3m                  # Text browser for captive portals
      - jq                   # JSON parsing for network history
      - mosquitto-clients    # MQTT for Home Assistant integration
    state: present
    update_cache: no
  when: network.wifi.roaming.enabled | default(false)

- name: Create Frey configuration directory
  ansible.builtin.file:
    path: /etc/frey
    state: directory
    mode: '0755'
  when: network.wifi.roaming.enabled | default(false)

- name: Create Frey state directory
  ansible.builtin.file:
    path: /var/lib/frey
    state: directory
    mode: '0755'
  when: network.wifi.roaming.enabled | default(false)

- name: Deploy WiFi roaming utility scripts
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: '0755'
  loop:
    - frey-wifi-internet-verify.sh
    - frey-wifi-captive-portal-auto.sh
    - frey-wifi-network-scorer.sh
    - frey-wifi-roaming-daemon.sh
  when: network.wifi.roaming.enabled | default(false)

- name: Deploy WiFi roaming configuration
  ansible.builtin.template:
    src: wifi-roaming.conf.j2
    dest: /etc/frey/wifi-roaming.conf
    mode: '0644'
  when: network.wifi.roaming.enabled | default(false)

- name: Deploy known networks configuration
  ansible.builtin.template:
    src: known-networks.conf.j2
    dest: /etc/frey/known-networks.conf
    mode: '0600'
  when: network.wifi.roaming.enabled | default(false)

- name: Deploy WiFi roaming systemd service
  ansible.builtin.template:
    src: frey-wifi-roaming.service.j2
    dest: /etc/systemd/system/frey-wifi-roaming.service
    mode: '0644'
  when: network.wifi.roaming.enabled | default(false)
  notify: Reload systemd

- name: Enable and start WiFi roaming service
  ansible.builtin.systemd:
    name: frey-wifi-roaming
    enabled: yes
    state: started
    daemon_reload: yes
  when: network.wifi.roaming.enabled | default(false)

- name: Display WiFi roaming status
  ansible.builtin.debug:
    msg: |
      ======================================
      WiFi Automatic Roaming System
      ======================================
      Status: {{ 'Enabled' if (network.wifi.roaming.enabled | default(false)) else 'Disabled' }}
      {% if network.wifi.roaming.enabled | default(false) %}
      Service: frey-wifi-roaming.service
      Config: /etc/frey/wifi-roaming.conf
      Known Networks: /etc/frey/known-networks.conf

      Control Commands:
      - Check status: sudo systemctl status frey-wifi-roaming
      - View logs: sudo journalctl -u frey-wifi-roaming -f
      - Stop service: sudo systemctl stop frey-wifi-roaming
      - Start service: sudo systemctl start frey-wifi-roaming

      MQTT Topics (Home Assistant):
      - Status: {{ network.wifi.roaming.mqtt_topic | default('frey/wifi/roaming') }}/status/#
      - Control: {{ network.wifi.roaming.mqtt_topic | default('frey/wifi/roaming') }}/control/#
      {% endif %}
