---
# ==============================================================================
# WiFi Access Point Role - Main Tasks
# ==============================================================================
# This role configures a Raspberry Pi as a WiFi Access Point while maintaining
# its existing WiFi client connection (dual-interface setup).
#
# Architecture:
# - wlan0: Client interface (connects to existing WiFi for internet)
# - wlan1: Access Point interface (provides WiFi network to clients)
# ==============================================================================

# ------------------------------------------------------------------------------
# VALIDATION & PREREQUISITES
# ------------------------------------------------------------------------------

- name: Assert required variables are defined
  ansible.builtin.assert:
    that:
      - wifi.interface is defined
      - wifi.ssid is defined
      - wifi.password is defined
      - wifi.country is defined
      - wifi.ip is defined
      - wifi.network is defined
      - wifi.client_interface is defined
    msg: "One or more required wifi_access_point variables are not set. Please check your configuration."

- name: Check wireless card capabilities for AP mode
  ansible.builtin.command:
    cmd: "iw list"
  register: iw_list_output
  changed_when: false
  failed_when: false

- name: Verify that AP mode is supported
  ansible.builtin.fail:
    msg: "ERROR: Your wireless hardware does not report AP mode support. Cannot proceed."
  when: "'AP' not in iw_list_output.stdout"

# ------------------------------------------------------------------------------
# PACKAGE INSTALLATION
# ------------------------------------------------------------------------------

- name: Install required packages for WiFi AP
  ansible.builtin.apt:
    name:
      - hostapd      # Creates the WiFi access point
      - dnsmasq      # Provides DHCP and DNS services
      - rfkill       # Manages radio killswitches
      - iw           # Wireless configuration tool
      - dhcpcd5      # DHCP client daemon for static IP configuration
    state: present

# ------------------------------------------------------------------------------
# SYSTEM CONFIGURATION - CONFLICTS & INTERFERENCE
# ------------------------------------------------------------------------------

- name: Check for systemd-resolved service
  ansible.builtin.stat:
    path: "/lib/systemd/system/systemd-resolved.service"
  register: resolved_service

- name: Disable systemd-resolved to prevent conflict with dnsmasq
  ansible.builtin.systemd:
    name: systemd-resolved
    state: stopped
    enabled: no
  when: resolved_service.stat.exists

- name: Configure NetworkManager to ignore the AP interface
  ansible.builtin.copy:
    dest: /etc/NetworkManager/conf.d/99-ansible-ap-ignore.conf
    content: |
      [keyfile]
      unmanaged-devices=interface-name:{{ wifi.interface }}
    mode: '0644'
  register: nm_config

- name: Notify about NetworkManager configuration
  ansible.builtin.debug:
    msg: >
      NetworkManager configuration has been updated.
      You may need to reload NetworkManager manually after the playbook completes:
      sudo systemctl reload NetworkManager
  when: nm_config.changed

- name: Ensure WiFi interface is unblocked
  ansible.builtin.command:
    cmd: "rfkill unblock wifi"
  changed_when: false

# ------------------------------------------------------------------------------
# INTERFACE PREPARATION
# ------------------------------------------------------------------------------

- name: Stop services before configuration
  ansible.builtin.service:
    name: "{{ item }}"
    state: stopped
  loop:
    - hostapd
    - dnsmasq
  failed_when: false

- name: Bring down AP interface before configuration
  ansible.builtin.command:
    cmd: ip link set {{ wifi.interface }} down
  changed_when: false
  failed_when: false

- name: Flush any existing IP addresses on AP interface
  ansible.builtin.command:
    cmd: ip addr flush dev {{ wifi.interface }}
  changed_when: false
  failed_when: false

# ------------------------------------------------------------------------------
# NETWORK CONFIGURATION FILES
# ------------------------------------------------------------------------------

- name: Configure static IP for AP interface via dhcpcd
  ansible.builtin.template:
    src: dhcpcd.conf.j2
    dest: /etc/dhcpcd.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify: restart dhcpcd

- name: Configure hostapd for WiFi AP
  ansible.builtin.template:
    src: hostapd.conf.j2
    dest: /etc/hostapd/hostapd.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart hostapd

- name: Point hostapd daemon to its config file
  ansible.builtin.lineinfile:
    path: /etc/default/hostapd
    regexp: '^#?DAEMON_CONF='
    line: 'DAEMON_CONF="/etc/hostapd/hostapd.conf"'
  notify: restart hostapd

- name: Enable debug logging for hostapd
  ansible.builtin.lineinfile:
    path: /etc/default/hostapd
    regexp: '^#?DAEMON_OPTS='
    line: 'DAEMON_OPTS="-d"'
  notify: restart hostapd

- name: Disable default dnsmasq.conf (we use dnsmasq.d instead)
  ansible.builtin.command:
    cmd: mv /etc/dnsmasq.conf /etc/dnsmasq.conf.disabled
    creates: /etc/dnsmasq.conf.disabled
  failed_when: false

- name: Configure dnsmasq for DHCP and DNS
  ansible.builtin.template:
    src: dnsmasq.conf.j2
    dest: /etc/dnsmasq.d/01-wifi-ap.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify: restart dnsmasq

# ------------------------------------------------------------------------------
# NETWORK FORWARDING & ROUTING
# ------------------------------------------------------------------------------

- name: Enable IP forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: yes
    state: present
    reload: yes

# ------------------------------------------------------------------------------
# INTERFACE ACTIVATION
# ------------------------------------------------------------------------------

- name: Bring up AP interface
  ansible.builtin.command:
    cmd: ip link set {{ wifi.interface }} up
  changed_when: false

- name: Assign IP address to AP interface
  ansible.builtin.command:
    cmd: ip addr add {{ wifi.ip }}/24 dev {{ wifi.interface }}
  changed_when: false
  failed_when: false

- name: Flush handlers to apply dhcpcd changes
  meta: flush_handlers

- name: Wait for dhcpcd to assign IP
  ansible.builtin.command: ip addr show {{ wifi.interface }}
  register: ip_addr_output
  until: "wifi.ip in ip_addr_output.stdout"
  retries: 10
  delay: 2

# ------------------------------------------------------------------------------
# SERVICE STARTUP (ORDER MATTERS!)
# ------------------------------------------------------------------------------
# hostapd must start first to activate the wireless radio and establish carrier.
# Only then can dnsmasq bind to the interface successfully.
# ------------------------------------------------------------------------------

- name: Start and enable hostapd (activates the wireless radio)
  ansible.builtin.service:
    name: hostapd
    state: started
    enabled: yes

- name: Wait for hostapd to initialize and activate carrier
  ansible.builtin.pause:
    seconds: 3

- name: Verify interface has carrier (not NO-CARRIER)
  ansible.builtin.command: ip addr show {{ wifi.interface }}
  register: interface_check
  failed_when: "'NO-CARRIER' in interface_check.stdout"

- name: Start and enable dnsmasq (after hostapd has activated interface)
  ansible.builtin.service:
    name: dnsmasq
    state: started
    enabled: yes

- name: Wait for dnsmasq to be ready
  ansible.builtin.pause:
    seconds: 2

- name: Verify dnsmasq is listening on port 53
  ansible.builtin.command: ss -ulnp
  register: dnsmasq_check
  failed_when: "':53' not in dnsmasq_check.stdout or 'dnsmasq' not in dnsmasq_check.stdout"
  changed_when: false

# ------------------------------------------------------------------------------
# NAT & MASQUERADING
# ------------------------------------------------------------------------------
# Configure NAT to allow WiFi AP clients to access the internet through the
# client interface (wlan0). This makes the Pi act as a router.
# ------------------------------------------------------------------------------

- name: Ensure NAT rule is active for WiFi AP
  ansible.builtin.iptables:
    table: nat
    chain: POSTROUTING
    source: "{{ wifi.network }}"
    out_interface: "{{ wifi.client_interface }}"
    jump: MASQUERADE
    comment: "NAT for WiFi Access Point"

- name: Create iptables directory if it doesn't exist
  ansible.builtin.file:
    path: /etc/iptables
    state: directory
    mode: '0755'

- name: Save iptables rules
  ansible.builtin.shell:
    cmd: iptables-save > /etc/iptables/rules.v4
  changed_when: false
  failed_when: false

# ------------------------------------------------------------------------------
# POST-CONFIGURATION
# ------------------------------------------------------------------------------

- name: Gather service facts to check for Docker
  ansible.builtin.service_facts:

- name: Restart Docker to restore its network rules after iptables changes
  ansible.builtin.service:
    name: docker
    state: restarted
  when: "'docker.service' in ansible_facts.services"