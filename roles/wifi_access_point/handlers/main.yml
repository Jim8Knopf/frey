---
# handlers file for wifi_access_point
- name: restart networking
  ansible.builtin.service:
    name: networking
    state: restarted

- name: reload sysctl
  ansible.builtin.command: sysctl --system

- name: restart hostapd
  ansible.builtin.service:
    name: hostapd
    state: restarted

- name: save iptables
  ansible.builtin.command: netfilter-persistent save

- name: restart dhcpcd
  ansible.builtin.service:
    name: dhcpcd
    state: restarted

- name: restart dnsmasq
  ansible.builtin.service:
    name: dnsmasq
    state: restarted

- name: create dnsmasq pid directory
  listen: restart dnsmasq
  ansible.builtin.file:
    path: /var/run/dnsmasq
    state: directory
    mode: '0755'
    owner: dnsmasq
    group: dnsmasq

- name: create dnsmasq leases directory
  listen: restart dnsmasq
  ansible.builtin.file:
    path: /var/lib/misc
    state: directory
    mode: '0755'
    owner: dnsmasq
    group: dnsmasq

- name: validate dnsmasq config
  listen: restart dnsmasq
  ansible.builtin.command: dnsmasq --test
  changed_when: false
  register: dnsmasq_test

- name: show dnsmasq config errors
  ansible.builtin.debug:
    msg: "{{ dnsmasq_test.stderr_lines }}"
  when: dnsmasq_test is failed

- name: restart dnsmasq
  listen: restart dnsmasq
  ansible.builtin.service:
    name: dnsmasq
    state: restarted
  register: dnsmasq_restart

- name: collect dnsmasq diagnostics
  listen: restart dnsmasq
  ansible.builtin.shell: |
    echo "=== DNSMasq Status ==="
    systemctl status dnsmasq.service
    echo "=== Journal Log ==="
    journalctl -xeu dnsmasq.service --no-pager
    echo "=== Config Test ==="
    dnsmasq --test
    echo "=== Network Interfaces ==="
    ip addr show {{ network.wifi.interface }}
    echo "=== Port Check ==="
    ss -tulpn | grep dnsmasq
  register: dnsmasq_debug
  when: dnsmasq_restart is failed
  ignore_errors: yes

- name: display dnsmasq diagnostics
  ansible.builtin.debug:
    msg: "{{ dnsmasq_debug.stdout_lines | default([]) }}"
  when: dnsmasq_restart is failed

- name: wait for dnsmasq
  listen: restart dnsmasq
  ansible.builtin.wait_for:
    port: 53
    timeout: 10
    host: "{{ network.wifi.ip }}"
  when: dnsmasq_restart is success

- name: verify dnsmasq
  listen: restart dnsmasq
  ansible.builtin.command: pgrep dnsmasq
  register: dnsmasq_check
  failed_when: dnsmasq_check.rc != 0
  changed_when: false

- name: restart iptables
  ansible.builtin.shell:
    cmd: "iptables-restore < /etc/iptables.rules.v4"

- name: save iptables rules
  ansible.builtin.shell:
    cmd: "iptables-save > /etc/iptables.rules.v4"
