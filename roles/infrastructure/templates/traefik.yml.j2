global:
  checkNewVersion: true
  sendAnonymousUsage: false

api:
  dashboard: true
  insecure: false  # Secure dashboard access

entryPoints:
  web:
    address: ":80"
    transport:
      respondingTimeouts:
        readTimeout: 600s      # 10 minutes for reading request (large uploads)
        writeTimeout: 600s     # 10 minutes for writing response (large downloads)
        idleTimeout: 3600s     # 1 hour idle connection timeout for qBittorrent and other persistent connections
    # HTTP entrypoint - no global redirect to allow ACME HTTP-01 challenges
    # Individual routers will handle HTTPS redirects as needed
  websecure:
    address: ":443"
    transport:
      respondingTimeouts:
        readTimeout: 600s
        writeTimeout: 600s
        idleTimeout: 3600s
{% if infrastructure.services.traefik.metrics.enabled | default(false) %}
  metrics:
    address: ":8083"
{% endif %}

# Certificate management via Step-CA ACME
# Static certificates removed - using automated ACME instead

certificatesResolvers:
  step-ca:
    acme:
      email: admin@frey.local
      storage: /acme/acme.json
      # Connect to Step-CA's internal Docker port (9443, not external 9336)
      caServer: https://step-ca:9443/acme/acme/directory
      certificatesDuration: 2160  # 90 days
      keyType: EC256  # Use ECDSA keys for better performance
      # Use HTTP-01 challenge for validation (requires port 80 accessible)
      # Step CA will connect to http://service.frey/.well-known/acme-challenge/token
      httpChallenge:
        entryPoint: web

providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false  # Security: opt-in for container exposure
    network: proxy          # Use proxy network for routing
    watch: true

log:
  level: DEBUG  # Enabled for ACME troubleshooting

accessLog: {}  # Enable access logs

{% if infrastructure.services.traefik.metrics.enabled | default(false) %}
# Prometheus metrics
metrics:
  prometheus:
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true
    entryPoint: metrics
{% endif %}

# Provide a default TLS certificate (wildcard) as fallback
tls:
  certificates:
    - certFile: /certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_cert }}
      keyFile: /certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_key }}
