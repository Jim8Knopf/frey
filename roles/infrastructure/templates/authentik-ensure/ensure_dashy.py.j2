from django.db import transaction
from authentik.core.models import Application, Provider
from authentik.providers.oauth2.models import OAuth2Provider
from authentik.flows.models import Flow
from authentik.crypto.models import CertificateKeyPair

client_id = "{{ landing_page.oidc.client_id | default('dashy') }}"
hostname = "{{ landing_page.hostname }}"
alt_hostname = "{{ landing_page.alt_hostname | default('') }}"

auth_flow = Flow.objects.get(slug='default-authentication-flow')
authz_flow = Flow.objects.get(slug='default-provider-authorization-implicit-consent')
inv_flow = Flow.objects.get(slug='default-invalidation-flow')
signing_key = CertificateKeyPair.objects.filter(name='authentik Self-signed Certificate').first()

redirect_uris = [
    {"matching_mode": "regex", "url": f"https://{hostname}(/.*)?"},
]

if alt_hostname:
    redirect_uris.append({"matching_mode": "regex", "url": f"https://{alt_hostname}(/.*)?"})

with transaction.atomic():
    app, _ = Application.objects.get_or_create(slug='dashy', defaults={"name": "Frey Landing"})

    candidates = []
    if app.provider_id:
        try:
            candidates.append(Provider.objects.get(id=app.provider_id))
        except Provider.DoesNotExist:
            pass

    try:
        candidates.append(Provider.objects.get(name='dashy-provider'))
    except Provider.DoesNotExist:
        pass

    provider = candidates[0] if candidates else Provider.objects.create(name='dashy-provider')

    provider.name = 'dashy-provider'
    provider.authentication_flow = auth_flow
    provider.authorization_flow = authz_flow
    provider.invalidation_flow = inv_flow
    provider.save()

    oauth, _ = OAuth2Provider.objects.get_or_create(provider_ptr=provider)
    oauth.client_type = 'public'
    oauth.client_id = client_id
    oauth.include_claims_in_id_token = True
    oauth.refresh_token_validity = "days=30"
    oauth.access_code_validity = "minutes=1"
    oauth.access_token_validity = "minutes=10"
    if signing_key:
        oauth.signing_key = signing_key
    oauth._redirect_uris = redirect_uris
    oauth.save()

    app.name = "Frey Landing"
    app.provider = provider
    app.meta_launch_url = f"https://{hostname}"
    app.meta_description = "Authenticated landing page and service catalog"
    app.meta_publisher = "Frey Hub"
    app.policy_engine_mode = "any"
    app.save()

print("OK: Dashy ensured and normalized")
