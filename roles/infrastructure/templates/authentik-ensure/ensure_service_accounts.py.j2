from django.db import transaction
from authentik.core.models import User, Group

ldap_password = "{{ authentik_ldap_bind_password }}"
admin_password = "{{ authentik_bootstrap_password }}"

with transaction.atomic():
    # Ensure ldap_bind internal user with password for LDAP binds
    u, _ = User.objects.get_or_create(username='ldap_bind', defaults={
        'type': 'internal',
        'is_active': True,
        'email': 'ldap_bind@service.local',
        'name': 'LDAP Bind Service Account',
    })
    u.type = 'internal'
    u.is_active = True
    u.set_password(ldap_password)
    u.save()

    # Ensure membership in jellyfin_users
    try:
        jellyfin_users = Group.objects.get(name='jellyfin_users')
        u.group_set.add(jellyfin_users)
    except Group.DoesNotExist:
        pass

    # Ensure main admin user 'jason'
    admin, _ = User.objects.get_or_create(username='jason', defaults={
        'type': 'internal',
        'is_active': True,
        'email': 'Jason.Kolb@ik.me',
        'name': 'Jason Kolb',
    })
    admin.type = 'internal'
    admin.is_active = True
    admin.set_password(admin_password)
    admin.save()

    # Add admin users to admin group
    try:
        admin_group = Group.objects.get(name='admin')
        admin.group_set.add(admin_group)
        try:
            akadmin = User.objects.get(username='akadmin')
            akadmin.group_set.add(admin_group)
        except User.DoesNotExist:
            pass
    except Group.DoesNotExist:
        pass

print("OK: Service accounts ensured")

