from django.db import transaction
from authentik.core.models import Application, Provider
from authentik.providers.oauth2.models import OAuth2Provider
from authentik.flows.models import Flow
from authentik.crypto.models import CertificateKeyPair

domain = "{{ network.domain_name }}"
client_id = "{{ media.services.audiobookshelf.oidc_client_id | default('audiobookshelf') }}"
client_secret = "{{ audiobookshelf_oidc_client_secret }}"

auth_flow = Flow.objects.get(slug='default-authentication-flow')
authz_flow = Flow.objects.get(slug='default-provider-authorization-implicit-consent')
inv_flow = Flow.objects.get(slug='default-invalidation-flow')
signing_key = CertificateKeyPair.objects.filter(name='authentik Self-signed Certificate').first()

redirect_uris = [
    {"matching_mode": "strict", "url": f"https://audiobookshelf.{domain}/auth/openid/callback"},
    {"matching_mode": "strict", "url": f"http://audiobookshelf.{domain}/auth/openid/callback"},
]

with transaction.atomic():
    p, _ = Provider.objects.get_or_create(
        name='audiobookshelf-provider',
        defaults={
            'authentication_flow': auth_flow,
            'authorization_flow': authz_flow,
            'invalidation_flow': inv_flow,
        },
    )
    p.authentication_flow = auth_flow
    p.authorization_flow = authz_flow
    p.invalidation_flow = inv_flow
    p.save()

    try:
        op = OAuth2Provider.objects.get(provider_ptr=p)
    except OAuth2Provider.DoesNotExist:
        op = OAuth2Provider(provider_ptr=p)
    op.client_type = 'confidential'
    op.client_id = client_id
    op.client_secret = client_secret
    op.include_claims_in_id_token = True
    op.refresh_token_validity = "days=30"
    op.access_code_validity = "minutes=1"
    op.access_token_validity = "minutes=10"
    if signing_key:
        op.signing_key = signing_key
    op.redirect_uris = redirect_uris
    op.save()

    app, _ = Application.objects.get_or_create(slug='audiobookshelf')
    app.name = 'Audiobookshelf'
    app.provider = p
    app.meta_launch_url = f"http://audiobookshelf.{domain}"
    app.meta_description = 'Audiobook and podcast server'
    app.meta_publisher = 'Frey Hub'
    app.policy_engine_mode = 'any'
    app.save()

print("OK: Audiobookshelf ensured")

