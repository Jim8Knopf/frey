# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
version: 1
metadata:
  name: Frey Hub - Service Accounts
  labels:
    blueprints.goauthentik.io/instantiate: "true"

entries:
  # Internal User for LDAP Bind (used by Jellyfin and other LDAP clients)
  # NOTE: Must be 'internal' type to support password authentication for LDAP bind.
  # Service accounts only support token authentication, not password-based LDAP bind.
  - model: authentik_core.user
    id: ldap-bind-user
    identifiers:
      username: ldap_bind
    attrs:
      username: ldap_bind
      name: LDAP Bind Service Account
      email: ldap_bind@service.local
      is_active: true
      type: internal
      path: users
      attributes:
        description: "Service account for LDAP authentication in Jellyfin and other services"
        ldap_unixhome: /home/ldap_bind
        ldapActive: true
      password: "{{ authentik_ldap_bind_password }}"

  # Add ldap_bind user to jellyfin_users group (required for LDAP search permissions)
  - model: authentik_core.group_user
    identifiers:
      user: !KeyOf ldap-bind-user
      group: !Find [authentik_core.group, [name, jellyfin_users]]
    attrs:
      user: !KeyOf ldap-bind-user
      group: !Find [authentik_core.group, [name, jellyfin_users]]

  # Create Jason user (main admin)
  - model: authentik_core.user
    id: jason-user
    identifiers:
      username: Jason
    attrs:
      username: Jason
      name: Jason Kolb
      email: Jason.Kolb@ik.me
      is_active: true
      type: internal
      path: users
      attributes:
        description: "Main administrator"

  # Add Jason to admin group for Audiobookshelf role mapping
  - model: authentik_core.group_user
    identifiers:
      user: !KeyOf jason-user
      group: !Find [authentik_core.group, [name, admin]]
    attrs:
      user: !KeyOf jason-user
      group: !Find [authentik_core.group, [name, admin]]

  # Add akadmin to admin group for Audiobookshelf role mapping
  - model: authentik_core.group_user
    identifiers:
      user: !Find [authentik_core.user, [username, akadmin]]
      group: !Find [authentik_core.group, [name, admin]]
    attrs:
      user: !Find [authentik_core.user, [username, akadmin]]
      group: !Find [authentik_core.group, [name, admin]]
