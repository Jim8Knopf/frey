# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
version: 1
metadata:
  name: Frey Hub - Grafana OIDC Provider
  labels:
    blueprints.goauthentik.io/instantiate: "true"

entries:
  # Custom property mapping for Grafana role
  - model: authentik_providers_oauth2.scopemapping
    id: grafana-role-mapping
    identifiers:
      name: Grafana Role Mapping
    attrs:
      name: Grafana Role Mapping
      scope_name: grafana
      description: Map Authentik groups to Grafana roles
      expression: |
        # Map groups to Grafana roles
        role = "Viewer"  # Default role

        for group in request.user.ak_groups.all():
            if group.name == "grafana_admins":
                role = "Admin"
                break
            elif group.name == "grafana_editors":
                role = "Editor"
                break
            elif group.name == "grafana_viewers":
                role = "Viewer"
                break

        return {
            "role": role,
            "grafana_role": role
        }

  # OAuth2 Provider for Grafana
  - model: authentik_providers_oauth2.oauth2provider
    id: grafana-provider
    identifiers:
      name: grafana-provider
    attrs:
      name: grafana-provider
      authentication_flow: !Find [authentik_flows.flow, [slug, default-authentication-flow]]
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      client_type: confidential
      client_id: {{ monitoring.grafana.oidc_client_id | default('grafana') }}
      client_secret: {{ grafana_oidc_client_secret }}
      redirect_uris:
        # DNS-based redirect (works when DNS resolves) - HTTPS
        - matching_mode: strict
          url: https://grafana.{{ network.domain_name }}/login/generic_oauth
        # DNS-based redirect (works when DNS resolves) - HTTP fallback
        - matching_mode: strict
          url: http://grafana.{{ network.domain_name }}/login/generic_oauth
        # LAN IP redirect (client_interface_ip - accessible from LAN)
        - matching_mode: strict
          url: http://{{ network.wifi.client_interface_ip }}:{{ monitoring.grafana.port | default(3000) }}/login/generic_oauth
        # WiFi AP IP redirect (works from WiFi clients)
        - matching_mode: strict
          url: http://{{ network.wifi.ip }}:{{ monitoring.grafana.port | default(3000) }}/login/generic_oauth
        # Localhost fallback (for local access or if header detection fails)
        - matching_mode: strict
          url: http://localhost:3000/login/generic_oauth
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      access_code_validity: minutes=1
      access_token_validity: minutes=10
      refresh_token_validity: days=30
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
        - !KeyOf grafana-role-mapping
      include_claims_in_id_token: true

  # Application for Grafana
  - model: authentik_core.application
    identifiers:
      slug: grafana
    attrs:
      name: Grafana
      slug: grafana
      provider: !KeyOf grafana-provider
      policy_engine_mode: any
      meta_launch_url: http://grafana.{{ network.domain_name }}
      meta_description: Monitoring and observability dashboards
      meta_publisher: Frey Hub
