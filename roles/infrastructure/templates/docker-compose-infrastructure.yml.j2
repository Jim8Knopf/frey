services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    # Publish ports as specified in architecture guide
    ports:
      - "80:80"       # HTTP - accessible from WiFi AP
      - "443:443"     # HTTPS - accessible from WiFi AP
      - "{{ infrastructure.services.traefik.ports.dashboard }}:8080" # Dashboard (localhost only)
{% if infrastructure.services.traefik.metrics.enabled | default(false) %}
      - "{{ infrastructure.services.traefik.metrics.port }}:8083" # Prometheus metrics
{% endif %}
    environment:
      # Trust Step CA root certificate for ACME client (Lego)
      - LEGO_CA_CERTIFICATES=/etc/ssl/step-ca/root_ca.crt
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{storage.appdata_dir }}/traefik/traefik.yml:/etc/traefik/traefik.yml:ro"
      - "{{storage.appdata_dir }}/traefik/certificates:/certificates" # For Let's Encrypt certificates
      - "{{storage.appdata_dir }}/traefik/dynamic:/dynamic:ro" # Dynamic TLS configuration (default certificate)
      - "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt:/etc/ssl/step-ca/root_ca.crt:ro"  # Trust Step CA root cert
      - "{{ storage.appdata_dir }}/traefik/acme:/acme" # ACME storage
    networks:
      proxy:              # Required for Traefik routing
        aliases:
{% for service in network.dns_rewrites | default([]) %}
          - {{ service.host | default(service.name ~ '.' ~ network.domain_name) }}
{% endfor %}
      backend:            # Internal service communication
        aliases:
{% for service in network.dns_rewrites | default([]) %}
          - {{ service.host | default(service.name ~ '.' ~ network.domain_name) }}
{% endfor %}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"  # Explicitly specify proxy network
      - "traefik.http.routers.traefik.rule=Host(`traefik.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.tls.certresolver=step-ca"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    # No direct host port; access via Traefik only
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "{{storage.appdata_dir }}/portainer/data:/data"
    networks:
      proxy:              # Required for Traefik routing
      backend:            # Internal service communication
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"  # Explicitly specify proxy network
      - "traefik.http.routers.portainer.rule=Host(`portainer.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.routers.portainer.tls.certresolver=step-ca"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

  # ==============================================================================
  # STEP-CA - PRIVATE CERTIFICATE AUTHORITY
  # ==============================================================================
  # Provides automated certificate management via ACME protocol
  # Integrates with Traefik for automatic cert generation and renewal
{% if infrastructure.services.step_ca.enabled | default(false) %}
{% set dns_hosts = namespace(values=[]) %}
{% for service in network.dns_rewrites | default([]) %}
{% set host_name = service.host | default(service.name ~ '.' ~ network.domain_name) %}
{% if host_name not in dns_hosts.values %}
{% set dns_hosts.values = dns_hosts.values + [host_name] %}
{% endif %}
{% endfor %}
  step-ca:
    image: smallstep/step-ca:{{ infrastructure.services.step_ca.version | default('latest') }}
    container_name: step-ca
    restart: unless-stopped
    # No direct host port; Traefik and internal clients use the container network
    volumes:
      - "{{ storage.appdata_dir }}/step-ca:/home/step"
    networks:
      proxy:              # Required for Traefik routing
      backend:            # Internal service communication
    # No extra_hosts needed - using Traefik network aliases for ACME validation
    # Health check uses step CLI which connects via internal service name
    environment:
      - DOCKER_STEPCA_INIT_NAME={{ infrastructure.services.step_ca.ca_name }}
{% if infrastructure.services.step_ca.dns_names is string %}
      - DOCKER_STEPCA_INIT_DNS_NAMES={{ infrastructure.services.step_ca.dns_names }}
{% else %}
      - DOCKER_STEPCA_INIT_DNS_NAMES={{ infrastructure.services.step_ca.dns_names | join(',') }}
{% endif %}
      - DOCKER_STEPCA_INIT_PROVISIONER_NAME={{ infrastructure.services.step_ca.provisioner_name }}
      - DOCKER_STEPCA_INIT_PASSWORD={{ infrastructure.services.step_ca.admin_password }}
      - STEPCA_EXTERNAL_PORT=9336  # External port for reference
      - STEPCA_DEFAULT_CNS=ca.{{ network.domain_name }}
      - DOCKER_STEPCA_INIT_ACME=true
      - DOCKER_STEPCA_INIT_SSH=false
      - SSL_CERT_FILE=/home/step/certs/root_ca.crt  # Trust our own CA certificate
      - STEPCLI_PASSWORD={{ infrastructure.services.step_ca.admin_password }}
      - CERTIFICATE_PASSWORD={{ infrastructure.services.step_ca.admin_password }}
      - SECRETS_PASSWORD={{infrastructure.services.step_ca.admin_password }}
      - DOCKER_STEPCA_INIT_ADDRESS=:9443  # Internal port (Traefik connects here)
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.step-ca.rule=Host(`ca.{{ network.domain_name }}`)"
      - "traefik.http.routers.step-ca.entrypoints=web,websecure"
      - "traefik.http.routers.step-ca.tls=true"
      - "traefik.http.routers.step-ca.tls.certresolver=step-ca"
      - "traefik.http.services.step-ca.loadbalancer.server.port=9443"  # Internal port
      - "traefik.http.services.step-ca.loadbalancer.server.scheme=https"
    healthcheck:
      test: ["CMD", "step", "ca", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
{% endif %}

  # ==============================================================================
  # CAPTIVE PORTAL RESPONDER - Offline Connectivity Validation
  # ==============================================================================
  # Returns HTTP 204 for Android/iOS captive portal detection requests
  # Makes devices think FreyHub has internet even when offline
  # Enables Immich downloads and other app features without internet
  captive-portal:
    image: python:3-alpine
    container_name: captive-portal
    restart: unless-stopped
    command:
      - python3
      - -c
      - |
        from http.server import HTTPServer, BaseHTTPRequestHandler
        class Handler(BaseHTTPRequestHandler):
          def do_GET(self):
            self.send_response(204)
            self.send_header('Content-Length', '0')
            self.send_header('Cache-Control', 'no-cache, no-store, must-revalidate')
            self.send_header('Pragma', 'no-cache')
            self.send_header('Expires', '0')
            self.end_headers()
          def do_HEAD(self):
            self.send_response(204)
            self.send_header('Content-Length', '0')
            self.send_header('Cache-Control', 'no-cache, no-store, must-revalidate')
            self.end_headers()
          def log_message(self, *args): pass
        HTTPServer(('0.0.0.0', 80), Handler).serve_forever()
    networks:
      proxy:
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # Android captive portal domains
      - "traefik.http.routers.captive-android.rule=Host(`connectivitycheck.gstatic.com`) || Host(`clients3.google.com`) || Host(`www.gstatic.com`)"
      - "traefik.http.routers.captive-android.entrypoints=web"
      - "traefik.http.routers.captive-android.priority=200"
      - "traefik.http.routers.captive-android-https.rule=Host(`connectivitycheck.gstatic.com`) || Host(`clients3.google.com`) || Host(`www.gstatic.com`)"
      - "traefik.http.routers.captive-android-https.entrypoints=websecure"
      - "traefik.http.routers.captive-android-https.priority=200"
      - "traefik.http.routers.captive-android-https.tls=true"
      # GrapheneOS captive portal domain
      - "traefik.http.routers.captive-graphene.rule=Host(`connectivitycheck.grapheneos.network`)"
      - "traefik.http.routers.captive-graphene.entrypoints=web"
      - "traefik.http.routers.captive-graphene.priority=200"
      - "traefik.http.routers.captive-graphene-https.rule=Host(`connectivitycheck.grapheneos.network`)"
      - "traefik.http.routers.captive-graphene-https.entrypoints=websecure"
      - "traefik.http.routers.captive-graphene-https.priority=200"
      - "traefik.http.routers.captive-graphene-https.tls=true"
      # iOS captive portal domains
      - "traefik.http.routers.captive-ios.rule=Host(`captive.apple.com`) || Host(`www.apple.com`)"
      - "traefik.http.routers.captive-ios.entrypoints=web"
      - "traefik.http.routers.captive-ios.priority=200"
      - "traefik.http.routers.captive-ios-https.rule=Host(`captive.apple.com`) || Host(`www.apple.com`)"
      - "traefik.http.routers.captive-ios-https.entrypoints=websecure"
      - "traefik.http.routers.captive-ios-https.priority=200"
      - "traefik.http.routers.captive-ios-https.tls=true"
      # Friendly testing domain
      - "traefik.http.routers.captive-test.rule=Host(`connect.{{ network.domain_name }}`)"
      - "traefik.http.routers.captive-test.entrypoints=web"
      - "traefik.http.routers.captive-test.priority=200"
      - "traefik.http.routers.captive-test-https.rule=Host(`connect.{{ network.domain_name }}`)"
      - "traefik.http.routers.captive-test-https.entrypoints=websecure"
      - "traefik.http.routers.captive-test-https.priority=200"
      - "traefik.http.routers.captive-test-https.tls=true"
      # Single service for all routers
      - "traefik.http.services.captive-portal.loadbalancer.server.port=80"

# Network definitions - simplified architecture
networks:
  proxy:
    external: true            # Main network for Traefik routing
  backend:
    external: true            # Internal service communication
