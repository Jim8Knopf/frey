services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    # Publish ports as specified in architecture guide
    ports:
      - "80:80"       # HTTP - accessible from WiFi AP
      - "443:443"     # HTTPS - accessible from WiFi AP
      - "{{ infrastructure.services.traefik.ports.dashboard }}:8080" # Dashboard (localhost only)
{% if infrastructure.services.traefik.metrics.enabled | default(false) %}
      - "{{ infrastructure.services.traefik.metrics.port }}:8083" # Prometheus metrics
{% endif %}
    environment:
      # Trust Step CA root certificate for ACME client (Lego)
      - LEGO_CA_CERTIFICATES=/etc/ssl/step-ca/root_ca.crt
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{storage.appdata_dir }}/traefik/traefik.yml:/etc/traefik/traefik.yml:ro"
      - "{{storage.appdata_dir }}/traefik/certificates:/certificates" # For Let's Encrypt certificates
      - "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt:/etc/ssl/step-ca/root_ca.crt:ro"  # Trust Step CA root cert
      - "{{ storage.appdata_dir }}/traefik/acme:/acme" # ACME storage
    networks:
      proxy:              # Required for Traefik routing
        aliases:
          - auth.{{ network.domain_name }}  # Allow backend containers to reach Authelia via Traefik
      localdns:          # Required for DNS resolution
        aliases:
          - auth.{{ network.domain_name }}  # Allow backend containers to reach Authelia via Traefik
      infrastructure_network:  # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"  # Explicitly specify proxy network
      - "traefik.http.routers.traefik.rule=Host(`traefik.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.tls.certresolver=step-ca"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    # No direct host port; access via Traefik only
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "{{storage.appdata_dir }}/portainer/data:/data"
    networks:
      proxy:              # Required for Traefik routing
      localdns:          # Required for DNS resolution
      infrastructure_network:  # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"  # Explicitly specify proxy network
      - "traefik.http.routers.portainer.rule=Host(`portainer.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.routers.portainer.tls.certresolver=step-ca"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"



  # ==============================================================================
  # STEP-CA - PRIVATE CERTIFICATE AUTHORITY
  # ==============================================================================
  # Provides automated certificate management via ACME protocol
  # Integrates with Traefik for automatic cert generation and renewal
{% if infrastructure.services.step_ca.enabled | default(false) %}
{% set dns_hosts = namespace(values=[]) %}
{% for service in network.dns_rewrites | default([]) %}
{% set host_name = service.host | default(service.name ~ '.' ~ network.domain_name) %}
{% if host_name not in dns_hosts.values %}
{% set dns_hosts.values = dns_hosts.values + [host_name] %}
{% endif %}
{% endfor %}
  step-ca:
    image: smallstep/step-ca:{{ infrastructure.services.step_ca.version | default('latest') }}
    container_name: step-ca
    restart: unless-stopped
    # No direct host port; Traefik and internal clients use the container network
    volumes:
      - "{{ storage.appdata_dir }}/step-ca:/home/step"
    networks:
      proxy:              # Required for Traefik routing
      infrastructure_network:  # Service-specific network
      localdns:          # Required for DNS resolution
    # Use AdGuard for DNS resolution of .frey domains (required for ACME validation)
    dns:
      - 172.19.0.2  # AdGuard on localdns network
    extra_hosts:
      "ca.{{ network.domain_name }}": "127.0.0.1"  # Required for health check
      # Map all *.frey domains to Traefik's IP on infrastructure_network for ACME HTTP-01 validation
      # Both Step-CA and Traefik are on this network, so HTTP connections work
{% for host_name in dns_hosts.values %}
      "{{ host_name }}": "172.20.0.4"  # Traefik on infrastructure_network
{% endfor %}
    environment:
      - DOCKER_STEPCA_INIT_NAME={{ infrastructure.services.step_ca.ca_name }}
      - DOCKER_STEPCA_INIT_DNS_NAMES={{ infrastructure.services.step_ca.dns_names | join(',') }}
      - DOCKER_STEPCA_INIT_PROVISIONER_NAME={{ infrastructure.services.step_ca.provisioner_name }}
      - DOCKER_STEPCA_INIT_PASSWORD={{ infrastructure.services.step_ca.admin_password }}
      - STEPCA_EXTERNAL_PORT=9336  # External port for reference
      - STEPCA_DEFAULT_CNS=ca.{{ network.domain_name }}
      - DOCKER_STEPCA_INIT_ACME=true
      - DOCKER_STEPCA_INIT_SSH=false
      - SSL_CERT_FILE=/etc/ssl/step-ca/root_ca.crt  # Trust our own CA certificate
      - STEPCLI_PASSWORD={{ infrastructure.services.step_ca.admin_password }}
      - CERTIFICATE_PASSWORD={{ infrastructure.services.step_ca.admin_password }}
      - SECRETS_PASSWORD={{infrastructure.services.step_ca.admin_password }}
      - DOCKER_STEPCA_INIT_ADDRESS=:9443  # Internal port (Traefik connects here)
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.step-ca.rule=Host(`ca.{{ network.domain_name }}`)"
      - "traefik.http.routers.step-ca.entrypoints=web,websecure"
      - "traefik.http.routers.step-ca.tls=true"
      - "traefik.http.routers.step-ca.tls.certresolver=step-ca"
      - "traefik.http.services.step-ca.loadbalancer.server.port=9443"  # Internal port
      - "traefik.http.services.step-ca.loadbalancer.server.scheme=https"
    healthcheck:
      test: ["CMD", "step", "ca", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
{% endif %}

# Network definitions as per architecture guide
networks:
  proxy:
    external: true            # Main network for Traefik routing
    name: "{{ infrastructure_networks.proxy.name | default('proxy') }}"
  localdns:
    external: true           # For DNS resolution
    name: "{{ infrastructure_networks.localdns.name | default('localdns') }}"
  infrastructure_network:    # Service-specific network
    external: true           # For DNS resolution
    name: "{{ infrastructure_networks.infrastructure_network.name | default('infrastructure_network') }}"
