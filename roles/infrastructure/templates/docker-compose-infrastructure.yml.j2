services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    # Publish ports as specified in architecture guide
    ports:
      - "80:80"       # HTTP - accessible from WiFi AP
      - "443:443"     # HTTPS - accessible from WiFi AP
      - "{{ infrastructure.services.traefik.ports.dashboard }}:8080" # Dashboard (localhost only)
{% if infrastructure.services.traefik.metrics.enabled | default(false) %}
      - "{{ infrastructure.services.traefik.metrics.port }}:8083" # Prometheus metrics
{% endif %}
    environment:
      # Trust Step CA root certificate for ACME client (Lego)
      - LEGO_CA_CERTIFICATES=/etc/ssl/step-ca/root_ca.crt
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{storage.appdata_dir }}/traefik/traefik.yml:/etc/traefik/traefik.yml:ro"
      - "{{storage.appdata_dir }}/traefik/certificates:/certificates" # For Let's Encrypt certificates
      - "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt:/etc/ssl/step-ca/root_ca.crt:ro"  # Trust Step CA root cert
      - "{{ storage.appdata_dir }}/traefik/acme:/acme" # ACME storage
    networks:
      proxy:              # Required for Traefik routing
        aliases:
          - auth.{{ network.domain_name }}  # Allow backend containers to reach Authentik via Traefik
      backend:            # Internal service communication
        aliases:
          - auth.{{ network.domain_name }}  # Allow backend containers to reach Authentik via Traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"  # Explicitly specify proxy network
      - "traefik.http.routers.traefik.rule=Host(`traefik.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.tls.certresolver=step-ca"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    # No direct host port; access via Traefik only
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "{{storage.appdata_dir }}/portainer/data:/data"
    networks:
      proxy:              # Required for Traefik routing
      backend:            # Internal service communication
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"  # Explicitly specify proxy network
      - "traefik.http.routers.portainer.rule=Host(`portainer.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.routers.portainer.tls.certresolver=step-ca"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"


  authentik-server:
    image: ghcr.io/goauthentik/server:{{ infrastructure.services.authentik.version | default('latest') }}
    container_name: authentik_server
    restart: unless-stopped
    command: server
    environment:
      AUTHENTIK_REDIS__HOST: authentik-redis
      AUTHENTIK_POSTGRESQL__HOST: authentik-db
      AUTHENTIK_POSTGRESQL__USER: {{ authentik_db_user | default('authentik') }}
      AUTHENTIK_POSTGRESQL__NAME: {{ authentik_db_name | default('authentik') }}
      AUTHENTIK_POSTGRESQL__PASSWORD: {{ authentik_postgres_password }}
      AUTHENTIK_SECRET_KEY: {{ authentik_secret_key }}
      # Bootstrap configuration (initial setup)
      AUTHENTIK_BOOTSTRAP_PASSWORD: {{ authentik_bootstrap_password }}
      AUTHENTIK_BOOTSTRAP_TOKEN: {{ authentik_bootstrap_token }}
      AUTHENTIK_BOOTSTRAP_EMAIL: {{ authentik_bootstrap_email | default('admin@local') }}
      # Auto-import and instantiate blueprints on startup
      AUTHENTIK_BOOTSTRAP_BLUEPRINTS: "/blueprints/*.yaml"
      # Ensure Authentik scans the mounted custom blueprint directory
      AUTHENTIK_BLUEPRINTS__DIRS: "/blueprints"
      # Error reporting (disabled for privacy)
      AUTHENTIK_ERROR_REPORTING__ENABLED: "false"
      # Trust proxy headers from Traefik
      AUTHENTIK_LISTEN__TRUSTED_PROXY_IP: "172.16.0.0/12,192.168.0.0/16,10.0.0.0/8"
      # Public-facing URL (tells Authentik what its external URL is)
      # Allows Authentik to accept OAuth requests from both internal (authentik_server:9000) and external (auth.frey)
      AUTHENTIK_SERVER_NAME: "auth.{{ network.domain_name }}"
    ports:
      - "{{ infrastructure.services.authentik.port | default(9000) }}:9000"
      - "{{ infrastructure.services.authentik.port_https | default(9446) }}:9446"
    volumes:
      - "{{ storage.appdata_dir }}/authentik/media:/media"
      - "{{ storage.appdata_dir }}/authentik/custom-templates:/templates"
      - "{{ storage.appdata_dir }}/authentik/blueprints:/blueprints:ro"
    networks:
      proxy:
      backend:
    depends_on:
      authentik-db:
        condition: service_healthy
      authentik-redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.authentik.rule=Host(`auth.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.authentik.entrypoints=websecure"
      - "traefik.http.routers.authentik.tls=true"
      - "traefik.http.routers.authentik.tls.certresolver=step-ca"
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"
{% set landing_cors_origins = landing_page.allowed_origins | default([]) if landing_page is defined else [] %}
{% if landing_cors_origins | length > 0 %}
      - "traefik.http.middlewares.authentik-cors.headers.accesscontrolalloworiginlist={{ landing_cors_origins | join(',') }}"
      - "traefik.http.middlewares.authentik-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.middlewares.authentik-cors.headers.accesscontrolallowmethods=GET,OPTIONS,POST"
      - "traefik.http.middlewares.authentik-cors.headers.accesscontrolallowheaders=Authorization,Content-Type"
      - "traefik.http.middlewares.authentik-cors.headers.addvaryheader=true"
      - "traefik.http.routers.authentik.middlewares=authentik-cors"
{% endif %}
      # HTTP router to support internal outposts reaching http://auth.frey
      - "traefik.http.routers.authentik-http.rule=Host(`auth.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.authentik-http.entrypoints=web"
      - "traefik.http.middlewares.auth-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.authentik-http.middlewares=auth-redirect"
    healthcheck:
      test: ["CMD-SHELL", "ak healthcheck || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  authentik-db:
    image: postgres:{{ infrastructure.services.authentik.postgres_version | default('16-alpine') }}
    container_name: authentik_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: {{ authentik_db_name | default('authentik') }}
      POSTGRES_USER: {{ authentik_db_user | default('authentik') }}
      POSTGRES_PASSWORD: {{ authentik_postgres_password }}
    volumes:
      - "{{ storage.appdata_dir }}/authentik/database:/var/lib/postgresql/data"
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ authentik_db_user | default('authentik') }}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  authentik-redis:
    image: redis:{{ infrastructure.services.authentik.redis_version | default('alpine') }}
    container_name: authentik_redis
    restart: unless-stopped
    command: --save 60 1 --loglevel warning
    volumes:
      - "{{ storage.appdata_dir }}/authentik/redis:/data"
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  authentik-worker:
    image: ghcr.io/goauthentik/server:{{ infrastructure.services.authentik.version | default('latest') }}
    container_name: authentik_worker
    restart: unless-stopped
    command: worker
    environment:
      AUTHENTIK_REDIS__HOST: authentik-redis
      AUTHENTIK_POSTGRESQL__HOST: authentik-db
      AUTHENTIK_POSTGRESQL__USER: {{ authentik_db_user | default('authentik') }}
      AUTHENTIK_POSTGRESQL__NAME: {{ authentik_db_name | default('authentik') }}
      AUTHENTIK_POSTGRESQL__PASSWORD: {{ authentik_postgres_password }}
      AUTHENTIK_SECRET_KEY: {{ authentik_secret_key }}
      AUTHENTIK_BLUEPRINTS__DIRS: "/blueprints"
      AUTHENTIK_ERROR_REPORTING__ENABLED: "false"
    user: root
    volumes:
      - "{{ storage.appdata_dir }}/authentik/media:/media"
      - "{{ storage.appdata_dir }}/authentik/certs:/certs"
      - "{{ storage.appdata_dir }}/authentik/custom-templates:/templates"
      - "{{ storage.appdata_dir }}/authentik/blueprints:/blueprints:ro"
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - backend
    depends_on:
      authentik-db:
        condition: service_healthy
      authentik-redis:
        condition: service_healthy
{% endif %}

  # ==============================================================================
  # STEP-CA - PRIVATE CERTIFICATE AUTHORITY
  # ==============================================================================
  # Provides automated certificate management via ACME protocol
  # Integrates with Traefik for automatic cert generation and renewal
{% if infrastructure.services.step_ca.enabled | default(false) %}
{% set dns_hosts = namespace(values=[]) %}
{% for service in network.dns_rewrites | default([]) %}
{% set host_name = service.host | default(service.name ~ '.' ~ network.domain_name) %}
{% if host_name not in dns_hosts.values %}
{% set dns_hosts.values = dns_hosts.values + [host_name] %}
{% endif %}
{% endfor %}
  step-ca:
    image: smallstep/step-ca:{{ infrastructure.services.step_ca.version | default('latest') }}
    container_name: step-ca
    restart: unless-stopped
    # No direct host port; Traefik and internal clients use the container network
    volumes:
      - "{{ storage.appdata_dir }}/step-ca:/home/step"
    networks:
      proxy:              # Required for Traefik routing
      backend:            # Internal service communication
    extra_hosts:
      "ca.{{ network.domain_name }}": "127.0.0.1"  # Required for health check
      # Map all *.frey domains to Traefik's IP on infrastructure_network for ACME HTTP-01 validation
      # Both Step-CA and Traefik are on this network, so HTTP connections work
{% for host_name in dns_hosts.values %}
      "{{ host_name }}": "10.20.3.3"  # Traefik on infrastructure_network
{% endfor %}
    environment:
      - DOCKER_STEPCA_INIT_NAME={{ infrastructure.services.step_ca.ca_name }}
{% if infrastructure.services.step_ca.dns_names is string %}
      - DOCKER_STEPCA_INIT_DNS_NAMES={{ infrastructure.services.step_ca.dns_names }}
{% else %}
      - DOCKER_STEPCA_INIT_DNS_NAMES={{ infrastructure.services.step_ca.dns_names | join(',') }}
{% endif %}
      - DOCKER_STEPCA_INIT_PROVISIONER_NAME={{ infrastructure.services.step_ca.provisioner_name }}
      - DOCKER_STEPCA_INIT_PASSWORD={{ infrastructure.services.step_ca.admin_password }}
      - STEPCA_EXTERNAL_PORT=9336  # External port for reference
      - STEPCA_DEFAULT_CNS=ca.{{ network.domain_name }}
      - DOCKER_STEPCA_INIT_ACME=true
      - DOCKER_STEPCA_INIT_SSH=false
      - SSL_CERT_FILE=/home/step/certs/root_ca.crt  # Trust our own CA certificate
      - STEPCLI_PASSWORD={{ infrastructure.services.step_ca.admin_password }}
      - CERTIFICATE_PASSWORD={{ infrastructure.services.step_ca.admin_password }}
      - SECRETS_PASSWORD={{infrastructure.services.step_ca.admin_password }}
      - DOCKER_STEPCA_INIT_ADDRESS=:9443  # Internal port (Traefik connects here)
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.step-ca.rule=Host(`ca.{{ network.domain_name }}`)"
      - "traefik.http.routers.step-ca.entrypoints=web,websecure"
      - "traefik.http.routers.step-ca.tls=true"
      - "traefik.http.routers.step-ca.tls.certresolver=step-ca"
      - "traefik.http.services.step-ca.loadbalancer.server.port=9443"  # Internal port
      - "traefik.http.services.step-ca.loadbalancer.server.scheme=https"
    healthcheck:
      test: ["CMD", "step", "ca", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
{% endif %}

# Network definitions - simplified architecture
networks:
  proxy:
    external: true            # Main network for Traefik routing
  backend:
    external: true            # Internal service communication
