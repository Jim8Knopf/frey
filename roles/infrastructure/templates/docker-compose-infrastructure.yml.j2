services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    # Publish ports as specified in architecture guide
    ports:
      - "80:80"       # HTTP - accessible from WiFi AP
      - "443:443"     # HTTPS - accessible from WiFi AP
      - "{{ infrastructure.services.traefik.ports.dashboard }}:8080" # Dashboard (localhost only)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{storage.appdata_dir }}/traefik/traefik.yml:/etc/traefik/traefik.yml:ro"
      - "{{storage.appdata_dir }}/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro"
      - "{{storage.appdata_dir }}/traefik/acme.json:/acme.json" # For Let's Encrypt certificates
    networks:
      proxy:              # Required for Traefik routing
        aliases:
          - auth.{{ network.domain_name }}  # Allow backend containers to reach Authentik via Traefik
      localdns:          # Required for DNS resolution
        aliases:
          - auth.{{ network.domain_name }}  # Allow backend containers to reach Authentik via Traefik
      infrastructure_network:  # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"  # Explicitly specify proxy network
      - "traefik.http.routers.traefik.rule=Host(`traefik.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.traefik.entrypoints=web"  # HTTP only for now
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    ports:
      - "{{ (infrastructure.services.portainer.port | default(9000)) }}:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "{{storage.appdata_dir }}/portainer/data:/data"
    networks:
      proxy:              # Required for Traefik routing
      localdns:          # Required for DNS resolution
      infrastructure_network:  # Service-specific network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"  # Explicitly specify proxy network
      - "traefik.http.routers.portainer.rule=Host(`portainer.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.portainer.entrypoints=web"  # HTTP only for now
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

{% if infrastructure.services.authentik.enabled | default(false) %}
  # ==============================================================================
  # AUTHENTIK - SSO & IDENTITY PROVIDER
  # ==============================================================================
  # Provides centralized authentication (OIDC, LDAP) for all services
  # Access: http://auth.{{ domain_name | default(network.domain_name | default('local')) }}

  authentik-server:
    image: ghcr.io/goauthentik/server:{{ infrastructure.services.authentik.version | default('latest') }}
    container_name: authentik_server
    restart: unless-stopped
    command: server
    environment:
      AUTHENTIK_REDIS__HOST: authentik-redis
      AUTHENTIK_POSTGRESQL__HOST: authentik-db
      AUTHENTIK_POSTGRESQL__USER: {{ authentik_db_user | default('authentik') }}
      AUTHENTIK_POSTGRESQL__NAME: {{ authentik_db_name | default('authentik') }}
      AUTHENTIK_POSTGRESQL__PASSWORD: {{ authentik_postgres_password }}
      AUTHENTIK_SECRET_KEY: {{ authentik_secret_key }}
      # Bootstrap configuration (initial setup)
      AUTHENTIK_BOOTSTRAP_PASSWORD: {{ authentik_bootstrap_password }}
      AUTHENTIK_BOOTSTRAP_TOKEN: {{ authentik_bootstrap_token }}
      AUTHENTIK_BOOTSTRAP_EMAIL: {{ authentik_bootstrap_email | default('admin@local') }}
      # Error reporting (disabled for privacy)
      AUTHENTIK_ERROR_REPORTING__ENABLED: "false"
      # Trust proxy headers from Traefik
      AUTHENTIK_LISTEN__TRUSTED_PROXY_IP: "172.16.0.0/12,192.168.0.0/16,10.0.0.0/8"
      # Public-facing URL (tells Authentik what its external URL is)
      # Allows Authentik to accept OAuth requests from both internal (authentik_server:9000) and external (auth.frey)
      AUTHENTIK_SERVER_NAME: "auth.{{ network.domain_name }}"
    ports:
      - "{{ infrastructure.services.authentik.port | default(9000) }}:9000"
      - "{{ infrastructure.services.authentik.port_https | default(9443) }}:9443"
    volumes:
      - "{{ storage.appdata_dir }}/authentik/media:/media"
      - "{{ storage.appdata_dir }}/authentik/custom-templates:/templates"
      - "{{ storage.appdata_dir }}/authentik/blueprints:/blueprints/custom:ro"
    networks:
      proxy:
      localdns:
      infrastructure_network:
    depends_on:
      authentik-db:
        condition: service_healthy
      authentik-redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.authentik.rule=Host(`auth.{{ domain_name | default(network.domain_name | default('local')) }}`)"
      - "traefik.http.routers.authentik.entrypoints=web"
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"
    healthcheck:
      test: ["CMD-SHELL", "ak healthcheck || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  authentik-db:
    image: postgres:{{ infrastructure.services.authentik.postgres_version | default('16-alpine') }}
    container_name: authentik_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: {{ authentik_db_name | default('authentik') }}
      POSTGRES_USER: {{ authentik_db_user | default('authentik') }}
      POSTGRES_PASSWORD: {{ authentik_postgres_password }}
    volumes:
      - "{{ storage.appdata_dir }}/authentik/database:/var/lib/postgresql/data"
    networks:
      - infrastructure_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ authentik_db_user | default('authentik') }}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  authentik-redis:
    image: redis:{{ infrastructure.services.authentik.redis_version | default('alpine') }}
    container_name: authentik_redis
    restart: unless-stopped
    command: --save 60 1 --loglevel warning
    volumes:
      - "{{ storage.appdata_dir }}/authentik/redis:/data"
    networks:
      - infrastructure_network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  authentik-worker:
    image: ghcr.io/goauthentik/server:{{ infrastructure.services.authentik.version | default('latest') }}
    container_name: authentik_worker
    restart: unless-stopped
    command: worker
    environment:
      AUTHENTIK_REDIS__HOST: authentik-redis
      AUTHENTIK_POSTGRESQL__HOST: authentik-db
      AUTHENTIK_POSTGRESQL__USER: {{ authentik_db_user | default('authentik') }}
      AUTHENTIK_POSTGRESQL__NAME: {{ authentik_db_name | default('authentik') }}
      AUTHENTIK_POSTGRESQL__PASSWORD: {{ authentik_postgres_password }}
      AUTHENTIK_SECRET_KEY: {{ authentik_secret_key }}
      AUTHENTIK_ERROR_REPORTING__ENABLED: "false"
    user: root
    volumes:
      - "{{ storage.appdata_dir }}/authentik/media:/media"
      - "{{ storage.appdata_dir }}/authentik/certs:/certs"
      - "{{ storage.appdata_dir }}/authentik/custom-templates:/templates"
      - "{{ storage.appdata_dir }}/authentik/blueprints:/blueprints/custom:ro"
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - infrastructure_network
    depends_on:
      authentik-db:
        condition: service_healthy
      authentik-redis:
        condition: service_healthy
{% endif %}

# Network definitions as per architecture guide
networks:
  proxy:
    external: true            # Main network for Traefik routing
  localdns:
    external: true           # For DNS resolution
  infrastructure_network:    # Service-specific network
    external: true           # For DNS resolution
