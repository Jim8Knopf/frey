---
- name: Setup intfrasructure stack user
  include_tasks: "templates/create_user.yml"
  vars:
    stack: "infrastructure"
    folders: [traefik, traefik/certificates, portainer, authentik, authentik/database, authentik/redis, authentik/media, authentik/certs, authentik/custom-templates, authentik/blueprints, step-ca]
    checkVar: [infrastructure, storage.base_dir, infrastructure.user.name, infrastructure.group.name, storage.stacks]

- name: Fix Step CA directory ownership for container user
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/step-ca"
    owner: 1000  # step user inside step-ca container
    group: 1000  # step group inside step-ca container
    mode: '0755'
    state: directory
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Check for Step CA configuration file
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/step-ca/config/ca.json"
  register: step_ca_config
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Check Step CA root certificate readability
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
  register: step_ca_root
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Ensure Step CA root certificate mode allows container access
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
    mode: '0644'
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_root.stat.exists

- name: Enforce 90-day certificates for Step CA ACME provisioner
  ansible.builtin.shell: |
    set -euo pipefail
    python3 - <<'PY'
    import json
    import pathlib

    config_path = pathlib.Path("{{ storage.appdata_dir }}/step-ca/config/ca.json")
    data = json.loads(config_path.read_text())

    provisioners = data.get("authority", {}).get("provisioners", [])
    changed = False
    acme_found = False

    for prov in provisioners:
        if prov.get("type") != "ACME":
            continue
        acme_found = True
        claims = prov.setdefault("claims", {})
        for key, value in (
            ("defaultTLSCertDuration", "2160h"),
            ("maxTLSCertDuration", "2160h"),
            ("minTLSCertDuration", "5m"),
        ):
            if claims.get(key) != value:
                claims[key] = value
                changed = True

    if not acme_found:
        print("noop")
    elif changed:
        config_path.write_text(json.dumps(data, indent=2) + "\n")
        print("updated")
    else:
        print("noop")
    PY
  args:
    executable: /bin/bash
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_config.stat.exists
  register: step_ca_claims
  changed_when: "'updated' in step_ca_claims.stdout"

# Certificate Generation Tasks
- name: Check if Frey CA certificate exists
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/traefik/certificates/frey-ca.crt"
  register: ca_cert_check

- name: Generate Frey Root CA private key
  ansible.builtin.command:
    cmd: >
      openssl genrsa
      -out {{ storage.appdata_dir }}/traefik/certificates/frey-ca.key
      4096
    creates: "{{ storage.appdata_dir }}/traefik/certificates/frey-ca.key"
  when: not ca_cert_check.stat.exists

- name: Generate Frey Root CA certificate
  ansible.builtin.command:
    cmd: >
      openssl req -x509 -new
      -key {{ storage.appdata_dir }}/traefik/certificates/frey-ca.key
      -out {{ storage.appdata_dir }}/traefik/certificates/frey-ca.crt
      -days 3650
      -subj "/CN=Frey Root CA/O=Frey Hub/C=US"
    creates: "{{ storage.appdata_dir }}/traefik/certificates/frey-ca.crt"
  when: not ca_cert_check.stat.exists

- name: Generate wildcard private key for *.frey
  ansible.builtin.command:
    cmd: >
      openssl genrsa
      -out {{ storage.appdata_dir }}/traefik/certificates/frey.key
      4096
    creates: "{{ storage.appdata_dir }}/traefik/certificates/frey.key"
  when: not ca_cert_check.stat.exists

- name: Generate certificate signing request for *.frey
  ansible.builtin.command:
    cmd: >
      openssl req -new
      -key {{ storage.appdata_dir }}/traefik/certificates/frey.key
      -out {{ storage.appdata_dir }}/traefik/certificates/frey.csr
      -subj "/CN=*.frey/O=Frey Hub/C=US"
    creates: "{{ storage.appdata_dir }}/traefik/certificates/frey.csr"
  when: not ca_cert_check.stat.exists

- name: Create OpenSSL extension file for SAN
  ansible.builtin.copy:
    content: |
      [v3_req]
      basicConstraints = CA:FALSE
      keyUsage = digitalSignature, keyEncipherment
      subjectAltName = @alt_names

      [alt_names]
      DNS.1 = *.frey
      DNS.2 = frey
    dest: "{{ storage.appdata_dir }}/traefik/certificates/san.cnf"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'
  when: not ca_cert_check.stat.exists

- name: Sign wildcard certificate with CA
  ansible.builtin.command:
    cmd: >
      openssl x509 -req
      -in {{ storage.appdata_dir }}/traefik/certificates/frey.csr
      -CA {{ storage.appdata_dir }}/traefik/certificates/frey-ca.crt
      -CAkey {{ storage.appdata_dir }}/traefik/certificates/frey-ca.key
      -CAcreateserial
      -out {{ storage.appdata_dir }}/traefik/certificates/frey.crt
      -days 3650
      -extensions v3_req
      -extfile {{ storage.appdata_dir }}/traefik/certificates/san.cnf
    creates: "{{ storage.appdata_dir }}/traefik/certificates/frey.crt"
  when: not ca_cert_check.stat.exists

- name: Set ownership on certificate files
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/traefik/certificates/{{ item }}"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'
  loop:
    - frey-ca.crt
    - frey-ca.key
    - frey.crt
    - frey.key
  when: not ca_cert_check.stat.exists

- name: Copy CA certificate to local Downloads directory
  ansible.builtin.fetch:
    src: "{{ storage.appdata_dir }}/traefik/certificates/frey-ca.crt"
    dest: "{{ lookup('env', 'HOME') }}/Downloads/frey-ca.crt"
    flat: yes
  when: ca_cert_check.stat.exists or not ca_cert_check.stat.exists

- name: Create Traefik static configuration
  ansible.builtin.template:
    src: traefik.yml.j2
    dest: "{{ storage.appdata_dir }}/traefik/traefik.yml"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'

- name: Template Authentik blueprint files
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "{{ storage.appdata_dir }}/authentik/blueprints/{{ item | basename | regex_replace('\\.j2$', '') }}"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'
  loop:
    - authentik-blueprints/00-groups.yaml.j2
    - authentik-blueprints/01-service-accounts.yaml.j2
    - authentik-blueprints/10-oidc-immich.yaml.j2
    - authentik-blueprints/11-oidc-audiobookshelf.yaml.j2
    - authentik-blueprints/12-oidc-grafana.yaml.j2
    - authentik-blueprints/13-oidc-homeassistant.yaml.j2
    - authentik-blueprints/14-oidc-mealie.yaml.j2
    - authentik-blueprints/15-oidc-dashy.yaml.j2
    - authentik-blueprints/16-proxy-traefik.yaml.j2
    - authentik-blueprints/20-ldap-jellyfin.yaml.j2
  when: infrastructure.services.authentik.enabled | default(false)
  register: authentik_blueprints_render

- name: Fix Redis data directory ownership (UID 999 required by Redis container)
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/authentik/redis"
    owner: 999
    group: 999
    mode: '0755'
    state: directory
  when: infrastructure.services.authentik.enabled | default(false)

- name: Deploy infrastructure compose file
  ansible.builtin.template:
    src: docker-compose-infrastructure.yml.j2
    dest: "{{ storage.stacks }}/infrastructure/docker-compose.yml"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'

- name: Create required Docker networks
  community.docker.docker_network:
    name: "{{ item }}"
    state: present
    driver: bridge
  loop:
    - proxy                     # For Traefik routing
    - localdns                  # For DNS resolution
    - infrastructure_network    # Service-specific network

- name: Start infrastructure containers using compose
  community.docker.docker_compose_v2:
    project_src: "{{ storage.stacks }}/infrastructure"
    state: present

- name: Restart Step CA after claim updates
  community.docker.docker_container:
    name: step-ca
    state: started
    restart: true
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_claims is defined
    - (step_ca_claims.stdout | default('')) is search('updated')

# --------------------------------------------------------------------------
# FORCE RENEWAL OF AUTH.FREY CERTIFICATE VIA STEP-CA
# --------------------------------------------------------------------------
- name: Stop Traefik to modify ACME store
  community.docker.docker_container:
    name: traefik
    state: stopped
  when: infrastructure.services.traefik is defined
  tags: [infrastructure, traefik, tls]

- name: Backup Traefik ACME store
  ansible.builtin.copy:
    src: "{{ storage.appdata_dir }}/traefik/acme/acme.json"
    dest: "{{ storage.appdata_dir }}/traefik/acme/acme.json.bak"
    remote_src: true
    mode: '0600'
    backup: yes
  tags: [infrastructure, traefik, tls]

- name: Reset ACME store to force renewal
  ansible.builtin.copy:
    content: "{}\n"
    dest: "{{ storage.appdata_dir }}/traefik/acme/acme.json"
    owner: root
    group: root
    mode: '0600'
  tags: [infrastructure, traefik, tls]

- name: Start Traefik after ACME edit
  community.docker.docker_container:
    name: traefik
    state: started
  tags: [infrastructure, traefik, tls]

- name: Wait for HTTPS (Traefik) on 443
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: 443
    timeout: 120
  tags: [infrastructure, traefik, tls]

# ==============================================================================
# AUTHENTIK BLUEPRINT APPLICATION
# ==============================================================================
# After containers are up, force-apply custom blueprints so deleted providers/
# applications are recreated (e.g., after SSL/URL changes).

- name: Wait for Authentik HTTP port to be reachable
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ infrastructure.services.authentik.port | default(9300) }}"
    timeout: 60
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints]

# ==============================================================================
# AUTHENTIK: Generic Blueprint Re-apply (full IaC)
# ==============================================================================

- name: Discover available Authentik blueprints
  ansible.builtin.find:
    paths: "{{ storage.appdata_dir }}/authentik/blueprints"
    patterns: "*.yaml"
    file_type: file
  register: ak_blueprints_files
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Determine reapply selector
  ansible.builtin.set_fact:
    ak_reapply_raw: "{{ authentik_reapply_blueprints | default(infrastructure.services.authentik.reapply_blueprints | default([])) }}"
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Normalize reapply selector
  ansible.builtin.set_fact:
    ak_reapply_var: >-
      {{ 'all' if (ak_reapply_raw | string) == 'all'
         else (
           ak_reapply_raw
           if (ak_reapply_raw is sequence and (ak_reapply_raw is not string))
           else (ak_reapply_raw | from_yaml)
         )
      }}
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Determine blueprints to re-apply
  ansible.builtin.set_fact:
    ak_reapply_list: "{{ (ak_blueprints_files.files | map(attribute='path') | map('basename') | list) if (ak_reapply_var | string) == 'all' else (ak_reapply_var | list) }}"
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Show blueprints to re-apply
  ansible.builtin.debug:
    msg: "Re-applying blueprints: {{ ak_reapply_list | default([]) | join(', ') }}"
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Delete blueprint instance records (force re-apply)
  ansible.builtin.shell: |
    set -euo pipefail
    PGPASSWORD={{ authentik_postgres_password | quote }} docker exec -e PGPASSWORD={{ authentik_postgres_password | quote }} authentik_postgres \
      psql -U {{ authentik_db_user | default('authentik') }} -d {{ authentik_db_name | default('authentik') }} -tAc \
      "DELETE FROM authentik_blueprints_blueprintinstance WHERE path='{{ item }}';"
  args:
    executable: /bin/bash
  loop: "{{ ak_reapply_list | default([]) }}"
  loop_control:
    label: "{{ item }}"
  register: ak_bp_delete
  changed_when: "'DELETE' in (stdout | default(''))"
  when: infrastructure.services.authentik.enabled | default(false) and (ak_reapply_list | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Restart authentik_server to trigger bootstrap import
  community.docker.docker_container:
    name: authentik_server
    state: started
    restart: true
  when: infrastructure.services.authentik.enabled | default(false) and (ak_reapply_list | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Wait for Authentik port after restart
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ infrastructure.services.authentik.port | default(9000) }}"
    timeout: 120
  when: infrastructure.services.authentik.enabled | default(false) and (ak_reapply_list | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Apply selected blueprints via blueprint_shell (HOME=/tmp)
  ansible.builtin.shell: |
    set -euo pipefail
    docker exec -e HOME=/tmp -i authentik_server sh -lc "printf 'apply -f /blueprints/{{ item }} --force\n' | ak blueprint_shell"
  args:
    executable: /bin/bash
  loop: "{{ ak_reapply_list | default([]) }}"
  loop_control:
    label: "{{ item }}"
  register: ak_bp_apply
  changed_when: false
  failed_when: false
  when: infrastructure.services.authentik.enabled | default(false) and (ak_reapply_list | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Import selected blueprints via import_blueprints (best-effort)
  ansible.builtin.shell: |
    set -euo pipefail
    docker exec -e HOME=/tmp -i authentik_server ak import_blueprints "/blueprints/{{ item }}" || true
  args:
    executable: /bin/bash
  loop: "{{ ak_reapply_list | default([]) }}"
  loop_control:
    label: "{{ item }}"
  register: ak_bp_import
  changed_when: false
  failed_when: false
  when: infrastructure.services.authentik.enabled | default(false) and (ak_reapply_list | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Verify blueprint instance status
  ansible.builtin.shell: |
    set -euo pipefail
    PGPASSWORD={{ authentik_postgres_password | quote }} docker exec -e PGPASSWORD={{ authentik_postgres_password | quote }} authentik_postgres \
      psql -U {{ authentik_db_user | default('authentik') }} -d {{ authentik_db_name | default('authentik') }} -tAc \
      "SELECT '{{ item }}:' || COALESCE((SELECT status FROM authentik_blueprints_blueprintinstance WHERE path='{{ item }}'),'missing');"
  args:
    executable: /bin/bash
  loop: "{{ ak_reapply_list | default([]) }}"
  loop_control:
    label: "{{ item }}"
  register: ak_bp_status
  changed_when: false
  when: infrastructure.services.authentik.enabled | default(false) and (ak_reapply_list | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Show blueprint statuses
  ansible.builtin.debug:
    msg: "{{ ak_bp_status.results | map(attribute='stdout') | map('trim') | reject('equalto','') | list }}"
  when: infrastructure.services.authentik.enabled | default(false) and (ak_reapply_list | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

 

- name: Ensure Immich via ORM when missing
  block:
    - name: Render immich ensure script on host
      ansible.builtin.template:
        src: authentik-ensure/ensure_immich.py.j2
        dest: "{{ storage.appdata_dir }}/authentik/ensure_immich.py"
        owner: "{{ infrastructure.user.name }}"
        group: "{{ infrastructure.group.name }}"
        mode: '0644'
    - name: Copy and execute immich ensure script in container
      ansible.builtin.shell: |
        set -euo pipefail
        docker cp "{{ storage.appdata_dir }}/authentik/ensure_immich.py" authentik_server:/tmp/ensure_immich.py
        docker exec authentik_server ak shell -c "exec(open('/tmp/ensure_immich.py').read())"
      args:
        executable: /bin/bash
      register: ak_ensure_immich
      changed_when: false
      failed_when: false
  when: >-
    infrastructure.services.authentik.enabled | default(false)
    and (ak_reapply_list | default([]) | select('equalto','10-oidc-immich.yaml') | list | length > 0)
    and (ak_bp_status.results | selectattr('item','equalto','10-oidc-immich.yaml') | map(attribute='stdout') | map('trim') | select('search',':missing') | list | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Ensure Service Accounts via ORM when missing
  block:
    - name: Render service accounts ensure script on host
      ansible.builtin.template:
        src: authentik-ensure/ensure_service_accounts.py.j2
        dest: "{{ storage.appdata_dir }}/authentik/ensure_service_accounts.py"
        owner: "{{ infrastructure.user.name }}"
        group: "{{ infrastructure.group.name }}"
        mode: '0644'
    - name: Copy and execute service accounts ensure script in container
      ansible.builtin.shell: |
        set -euo pipefail
        docker cp "{{ storage.appdata_dir }}/authentik/ensure_service_accounts.py" authentik_server:/tmp/ensure_service_accounts.py
        docker exec authentik_server ak shell -c "exec(open('/tmp/ensure_service_accounts.py').read())"
      args:
        executable: /bin/bash
      register: ak_ensure_sa
      changed_when: false
      failed_when: false
  when: >-
    infrastructure.services.authentik.enabled | default(false)
    and (ak_reapply_list | default([]) | select('equalto','01-service-accounts.yaml') | list | length > 0)
    and (ak_bp_status.results | selectattr('item','equalto','01-service-accounts.yaml') | map(attribute='stdout') | map('trim') | select('search',':missing') | list | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Ensure Audiobookshelf via ORM when missing
  block:
    - name: Render Audiobookshelf ensure script on host
      ansible.builtin.template:
        src: authentik-ensure/ensure_audiobookshelf.py.j2
        dest: "{{ storage.appdata_dir }}/authentik/ensure_audiobookshelf.py"
        owner: "{{ infrastructure.user.name }}"
        group: "{{ infrastructure.group.name }}"
        mode: '0644'
    - name: Copy and execute Audiobookshelf ensure script in container
      ansible.builtin.shell: |
        set -euo pipefail
        docker cp "{{ storage.appdata_dir }}/authentik/ensure_audiobookshelf.py" authentik_server:/tmp/ensure_audiobookshelf.py
        docker exec authentik_server ak shell -c "exec(open('/tmp/ensure_audiobookshelf.py').read())"
      args:
        executable: /bin/bash
      register: ak_ensure_abs
      changed_when: false
      failed_when: false
  when: >-
    infrastructure.services.authentik.enabled | default(false)
    and (ak_reapply_list | default([]) | select('equalto','11-oidc-audiobookshelf.yaml') | list | length > 0)
    and (ak_bp_status.results | selectattr('item','equalto','11-oidc-audiobookshelf.yaml') | map(attribute='stdout') | map('trim') | select('search',':missing') | list | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]


- name: Re-verify blueprint instance status after ensures
  ansible.builtin.shell: |
    set -euo pipefail
    PGPASSWORD={{ authentik_postgres_password | quote }} docker exec -e PGPASSWORD={{ authentik_postgres_password | quote }} authentik_postgres \
      psql -U {{ authentik_db_user | default('authentik') }} -d {{ authentik_db_name | default('authentik') }} -tAc \
      "SELECT '{{ item }}:' || COALESCE((SELECT status FROM authentik_blueprints_blueprintinstance WHERE path='{{ item }}'),'missing');"
  args:
    executable: /bin/bash
  loop: "{{ ak_reapply_list | default([]) }}"
  loop_control:
    label: "{{ item }}"
  register: ak_bp_status2
  changed_when: false
  when: infrastructure.services.authentik.enabled | default(false) and (ak_reapply_list | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Show final blueprint statuses
  ansible.builtin.debug:
    msg: "{{ ak_bp_status2.results | map(attribute='stdout') | map('trim') | reject('equalto','') | list }}"
  when: infrastructure.services.authentik.enabled | default(false) and (ak_reapply_list | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Check existence of ABS provider
  ansible.builtin.shell: |
    set -euo pipefail
    PGPASSWORD={{ authentik_postgres_password | quote }} docker exec -e PGPASSWORD={{ authentik_postgres_password | quote }} authentik_postgres \
      psql -U {{ authentik_db_user | default('authentik') }} -d {{ authentik_db_name | default('authentik') }} -tAc \
      "SELECT COUNT(*) FROM authentik_providers_oauth2_oauth2provider WHERE client_id='audiobookshelf'"
  register: ak_abs_count
  changed_when: false
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Check existence of Immich provider
  ansible.builtin.shell: |
    set -euo pipefail
    PGPASSWORD={{ authentik_postgres_password | quote }} docker exec -e PGPASSWORD={{ authentik_postgres_password | quote }} authentik_postgres \
      psql -U {{ authentik_db_user | default('authentik') }} -d {{ authentik_db_name | default('authentik') }} -tAc \
      "SELECT COUNT(*) FROM authentik_providers_oauth2_oauth2provider WHERE client_id='immich'"
  register: ak_immich_count
  changed_when: false
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Check existence of Mealie provider
  ansible.builtin.shell: |
    set -euo pipefail
    PGPASSWORD={{ authentik_postgres_password | quote }} docker exec -e PGPASSWORD={{ authentik_postgres_password | quote }} authentik_postgres \
      psql -U {{ authentik_db_user | default('authentik') }} -d {{ authentik_db_name | default('authentik') }} -tAc \
      "SELECT COUNT(*) FROM authentik_providers_oauth2_oauth2provider WHERE client_id='mealie'"
  register: ak_mealie_count
  changed_when: false
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Check existence of service accounts
  ansible.builtin.shell: |
    set -euo pipefail
    PGPASSWORD={{ authentik_postgres_password | quote }} docker exec -e PGPASSWORD={{ authentik_postgres_password | quote }} authentik_postgres \
      psql -U {{ authentik_db_user | default('authentik') }} -d {{ authentik_db_name | default('authentik') }} -tAc \
      "SELECT SUM(CASE WHEN username IN ('ldap_bind','jason') THEN 1 ELSE 0 END) FROM authentik_core_user"
  register: ak_sa_sum
  changed_when: false
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Compute acceptable-missing list
  ansible.builtin.set_fact:
    ak_ok_missing: >-
      {{
        (
          ['11-oidc-audiobookshelf.yaml'] if ((ak_abs_count.stdout | default('0') | trim | int) > 0) else []
        )
        + (
          ['10-oidc-immich.yaml'] if ((ak_immich_count.stdout | default('0') | trim | int) > 0) else []
        )
        + (
          ['14-oidc-mealie.yaml'] if ((ak_mealie_count.stdout | default('0') | trim | int) > 0) else []
        )
        + (
          ['01-service-accounts.yaml'] if ((ak_sa_sum.stdout | default('0') | trim | int) >= 1) else []
        )
      }}
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Compute missing list
  ansible.builtin.set_fact:
    ak_missing_list: "{{ ak_bp_status2.results | selectattr('stdout', 'search', ':missing') | map(attribute='item') | list }}"
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Compute unresolved missing list
  ansible.builtin.set_fact:
    ak_unresolved_missing: "{{ ak_missing_list | default([]) | difference(ak_ok_missing | default([])) }}"
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Show unresolved missing
  ansible.builtin.debug:
    msg: "Unresolved missing: {{ ak_unresolved_missing | default([]) }} (ok_missing={{ ak_ok_missing | default([]) }})"
  when: infrastructure.services.authentik.enabled | default(false)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

- name: Fail if any blueprint still unresolved
  ansible.builtin.fail:
    msg: |
      Some blueprints failed to apply or ensure.
      Unresolved missing: {{ ak_unresolved_missing | default([]) }}
  when: infrastructure.services.authentik.enabled | default(false) and (ak_unresolved_missing | default([]) | length > 0)
  tags: [infrastructure, authentik, blueprints, reapply, authentik_reapply]

 


- name: Restart authentik_server to (re)instantiate blueprints
  community.docker.docker_container:
    name: authentik_server
    state: started
    restart: true
  when: infrastructure.services.authentik.enabled | default(false) and (authentik_blueprints_render is defined and authentik_blueprints_render.changed)
  tags: [infrastructure, authentik, blueprints]

- name: Restart authentik_worker to (re)instantiate blueprints
  community.docker.docker_container:
    name: authentik_worker
    state: started
    restart: true
  when: infrastructure.services.authentik.enabled | default(false) and (authentik_blueprints_render is defined and authentik_blueprints_render.changed)
  tags: [infrastructure, authentik, blueprints]
