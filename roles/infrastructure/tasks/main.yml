---
- name: Setup media stack user
  include_tasks: "templates/create_user.yml"
  vars:
    stack: "infrastructure" 
    folders: [traefik, portainer]

- name: Create Traefik static configuration
  ansible.builtin.template:
    src: traefik.yml.j2
    dest: "{{ storage.appdata_dir }}/traefik/traefik.yml"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'

- name: Deploy infrastructure compose file
  ansible.builtin.template:
    src: docker-compose-infrastructure.yml.j2
    dest: "{{ docker.stacks }}/infrastructure/docker-compose.yml"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'

- name: Create proxy network for Traefik
  community.docker.docker_network:
    name: proxy
    state: present

- name: Start infrastructure containers using compose
  community.docker.docker_compose_v2:
    project_src: "{{ docker.stacks }}/infrastructure"
    state: present
