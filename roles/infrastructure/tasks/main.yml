---
- name: Setup intfrasructure stack user
  include_tasks: "templates/create_user.yml"
  vars:
    stack: "infrastructure"
    folders: [traefik, traefik/certificates, portainer, step-ca]
    checkVar: [infrastructure, storage.base_dir, infrastructure.user.name, infrastructure.group.name, storage.stacks]

- name: Fix Step CA directory ownership for container user
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/step-ca"
    owner: 1000  # step user inside step-ca container
    group: 1000  # step group inside step-ca container
    mode: '0755'
    state: directory
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Check for Step CA configuration file
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/step-ca/config/ca.json"
  register: step_ca_config
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Check Step CA root certificate entry
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
  register: step_ca_root
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Check Step CA intermediate certificate entry
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/step-ca/certs/intermediate_ca.crt"
  register: step_ca_intermediate
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Remove invalid Step CA root entry
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/step-ca/certs/root_ca.crt"
    state: absent
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_root.stat.isdir | default(false)

- name: Remove invalid Step CA intermediate entry
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/step-ca/certs/intermediate_ca.crt"
    state: absent
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_intermediate.stat.isdir | default(false)

- name: Ensure Step CA cert directory has proper ownership
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/step-ca/certs"
    state: directory
    owner: 1000
    group: 1000
    mode: '0755'
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Export Step CA root certificate
  ansible.builtin.command:
    cmd: docker exec step-ca step ca root
  register: step_ca_root_export
  changed_when: false
  failed_when: false
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Publish Step CA root certificate for download
  ansible.builtin.copy:
    dest: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
    content: "{{ step_ca_root_export.stdout }}"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_root_export.rc == 0

- name: Enforce 90-day certificates for Step CA ACME provisioner
  ansible.builtin.shell: |
    set -euo pipefail
    python3 - <<'PY'
    import json
    import pathlib

    config_path = pathlib.Path("{{ storage.appdata_dir }}/step-ca/config/ca.json")
    data = json.loads(config_path.read_text())

    provisioners = data.get("authority", {}).get("provisioners", [])
    changed = False
    acme_found = False

    for prov in provisioners:
        if prov.get("type") != "ACME":
            continue
        acme_found = True
        claims = prov.setdefault("claims", {})
        for key, value in (
            ("defaultTLSCertDuration", "{{ infrastructure.services.step_ca.default_cert_duration }}"),
            ("maxTLSCertDuration", "{{ infrastructure.services.step_ca.max_cert_duration }}"),
            ("minTLSCertDuration", "{{ infrastructure.services.step_ca.min_cert_duration }}"),
        ):
            if claims.get(key) != value:
                claims[key] = value
                changed = True

    if not acme_found:
        print("noop")
    elif changed:
        config_path.write_text(json.dumps(data, indent=2) + "\n")
        print("updated")
    else:
        print("noop")
    PY
  args:
    executable: /bin/bash
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_config.stat.exists
  register: step_ca_claims
  changed_when: "'updated' in step_ca_claims.stdout"

# Certificate Generation Tasks
- name: Check if CA certificate exists
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
  register: ca_cert_check

- name: Generate Root CA private key
  ansible.builtin.command:
    cmd: >
      openssl genrsa
      -out {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_key }}
      4096
    creates: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_key }}"
  when:
    - not ca_cert_check.stat.exists
    - not (infrastructure.services.step_ca.enabled | default(false))

- name: Generate Root CA certificate
  ansible.builtin.command:
    cmd: >
      openssl req -x509 -new
      -key {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_key }}
      -out {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}
      -days 3650
      -subj "/CN={{ infrastructure.services.step_ca.root_ca_cn }}/O={{ infrastructure.services.step_ca.organization }}/C={{ infrastructure.services.step_ca.country }}"
    creates: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
  when:
    - not ca_cert_check.stat.exists
    - not (infrastructure.services.step_ca.enabled | default(false))

- name: Generate wildcard private key for *.{{ network.domain_name }}
  ansible.builtin.command:
    cmd: >
      openssl genrsa
      -out {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_key }}
      4096
    creates: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_key }}"
  when:
    - not ca_cert_check.stat.exists
    - not (infrastructure.services.step_ca.enabled | default(false))

- name: Generate certificate signing request for *.{{ network.domain_name }}
  ansible.builtin.command:
    cmd: >
      openssl req -new
      -key {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_key }}
      -out {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_csr }}
      -subj "/CN=*.{{ network.domain_name }}/O={{ infrastructure.services.step_ca.organization }}/C={{ infrastructure.services.step_ca.country }}"
    creates: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_csr }}"
  when:
    - not ca_cert_check.stat.exists
    - not (infrastructure.services.step_ca.enabled | default(false))

- name: Create OpenSSL extension file for SAN
  ansible.builtin.copy:
    content: |
      [v3_req]
      basicConstraints = CA:FALSE
      keyUsage = digitalSignature, keyEncipherment
      subjectAltName = @alt_names

      [alt_names]
      DNS.1 = *.{{ network.domain_name }}
      DNS.2 = {{ network.domain_name }}
    dest: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.san_config }}"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'
  when:
    - not ca_cert_check.stat.exists
    - not (infrastructure.services.step_ca.enabled | default(false))

- name: Sign wildcard certificate with CA
  ansible.builtin.command:
    cmd: >
      openssl x509 -req
      -in {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_csr }}
      -CA {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}
      -CAkey {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_key }}
      -CAcreateserial
      -out {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_cert }}
      -days 3650
      -extensions v3_req
      -extfile {{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.san_config }}
    creates: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.wildcard_cert }}"
  when:
    - not ca_cert_check.stat.exists
    - not (infrastructure.services.step_ca.enabled | default(false))

- name: Set ownership on certificate files
  ansible.builtin.file:
    path: "{{ storage.appdata_dir }}/traefik/certificates/{{ item }}"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'
  loop:
    - "{{ infrastructure.services.step_ca.cert_files.root_ca }}"
    - "{{ infrastructure.services.step_ca.cert_files.root_key }}"
    - "{{ infrastructure.services.step_ca.cert_files.wildcard_cert }}"
    - "{{ infrastructure.services.step_ca.cert_files.wildcard_key }}"
  when:
    - not ca_cert_check.stat.exists
    - not (infrastructure.services.step_ca.enabled | default(false))

- name: Check CA certificate availability
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
  register: frey_ca_published

- name: Copy CA certificate to local Downloads directory
  ansible.builtin.fetch:
    src: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
    dest: "{{ lookup('env', 'HOME') }}/Downloads/Cert/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
    flat: yes
  when: frey_ca_published.stat.exists

- name: Create Traefik static configuration
  ansible.builtin.template:
    src: traefik.yml.j2
    dest: "{{ storage.appdata_dir }}/traefik/traefik.yml"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'

# ==============================================================================
# STEP-CA PRE-DEPLOYMENT CLEANUP
# ==============================================================================
- name: Check if Step-CA configuration is complete
  ansible.builtin.stat:
    path: "{{ storage.appdata_dir }}/step-ca/config/ca.json"
  register: step_ca_config_check
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Clean up incomplete Step-CA initialization
  block:
    - name: Stop and remove broken Step-CA container
      community.docker.docker_container:
        name: step-ca
        state: absent
      failed_when: false

    - name: Remove incomplete Step-CA configuration
      ansible.builtin.file:
        path: "{{ storage.appdata_dir }}/step-ca"
        state: absent

    - name: Recreate Step-CA directory with proper ownership
      ansible.builtin.file:
        path: "{{ storage.appdata_dir }}/step-ca"
        state: directory
        owner: 1000  # step user inside container
        group: 1000
        mode: '0755'
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - not step_ca_config_check.stat.exists

# ==============================================================================
# DOCKER COMPOSE DEPLOYMENT
# ==============================================================================
- name: Template infrastructure docker-compose file
  ansible.builtin.template:
    src: docker-compose-infrastructure.yml.j2
    dest: "{{ storage.stacks }}/infrastructure/docker-compose.yml"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'
  register: infrastructure_compose_template

- name: Validate infrastructure docker-compose syntax
  ansible.builtin.command:
    cmd: docker compose -f {{ storage.stacks }}/infrastructure/docker-compose.yml config --quiet
  changed_when: false
  register: infrastructure_compose_validation
  failed_when: infrastructure_compose_validation.rc != 0

- name: Start infrastructure stack with graceful error handling
  block:
    - name: Start infrastructure stack containers using compose
      community.docker.docker_compose_v2:
        project_src: "{{ storage.stacks }}/infrastructure"
        state: present
        remove_orphans: true
        timeout: 300
      register: compose_result
      retries: 2
      delay: 30

  rescue:
    - name: Handle compose failure - gather logs
      ansible.builtin.command:
        cmd: docker compose -f "{{ storage.stacks }}/infrastructure/docker-compose.yml" logs --tail=50
      register: compose_logs
      failed_when: false

    - name: Display compose error details
      ansible.builtin.debug:
        msg: |
          Infrastructure stack deployment failed. Recent logs:
          {{ compose_logs.stdout }}
      when: compose_logs.stdout is defined

    - name: Fail with helpful message
      ansible.builtin.fail:
        msg: "Infrastructure stack deployment failed. Check the logs above and ensure all required directories exist."

# ==============================================================================
# POST-DEPLOYMENT: STEP-CA VERIFICATION AND CERTIFICATE EXPORT
# ==============================================================================
- name: Wait for Step-CA to be healthy (if enabled)
  ansible.builtin.shell: |
    for i in {1..30}; do
      if docker exec step-ca step ca health 2>/dev/null; then
        echo "Step-CA is healthy"
        exit 0
      fi
      echo "Waiting for Step-CA to initialize... ($i/30)"
      sleep 2
    done
    echo "Step-CA failed to become healthy after 60 seconds"
    exit 1
  register: step_ca_health
  changed_when: false
  failed_when: false
  when: infrastructure.services.step_ca.enabled | default(false)

- name: Export Step-CA root certificate after successful initialization
  ansible.builtin.command:
    cmd: docker exec step-ca step ca root
  register: step_ca_root_export_post
  changed_when: false
  failed_when: false
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_health is succeeded

- name: Publish Step-CA root certificate for Traefik and client download
  ansible.builtin.copy:
    dest: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
    content: "{{ step_ca_root_export_post.stdout }}"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_root_export_post is succeeded
    - step_ca_root_export_post.stdout is defined

- name: Copy Step-CA certificate to local Downloads directory
  ansible.builtin.fetch:
    src: "{{ storage.appdata_dir }}/traefik/certificates/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
    dest: "{{ lookup('env', 'HOME') }}/Downloads/Cert/{{ infrastructure.services.step_ca.cert_files.root_ca }}"
    flat: yes
  when:
    - infrastructure.services.step_ca.enabled | default(false)
    - step_ca_root_export_post is succeeded
    - step_ca_root_export_post.stdout is defined
