---
- name: Setup intfrasructure stack user
  include_tasks: "templates/create_user.yml"
  vars:
    stack: "infrastructure" 
    folders: [traefik, portainer]
    checkVar: [infrastructure, storage.base_dir, infrastructure.user.name, infrastructure.group.name, docker.stacks]

- name: Create Traefik static configuration
  ansible.builtin.template:
    src: traefik.yml.j2
    dest: "{{ storage.appdata_dir }}/traefik/traefik.yml"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'

- name: Deploy infrastructure compose file
  ansible.builtin.template:
    src: docker-compose-infrastructure.yml.j2
    dest: "{{ docker.stacks }}/infrastructure/docker-compose.yml"
    owner: "{{ infrastructure.user.name }}"
    group: "{{ infrastructure.group.name }}"
    mode: '0644'

- name: Create required Docker networks
  community.docker.docker_network:
    name: "{{ item }}"
    state: present
    driver: bridge
  loop:
    - proxy      # For Traefik routing
    - localdns   # For DNS resolution

- name: Start infrastructure containers using compose
  community.docker.docker_compose_v2:
    project_src: "{{ docker.stacks }}/infrastructure"
    state: present
