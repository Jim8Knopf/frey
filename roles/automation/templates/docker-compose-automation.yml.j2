services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
{% if automation.services.ollama.gpu_enabled %}
    devices:
      - /dev/kfd
      - /dev/dri
{% endif %}
    restart: unless-stopped
    networks:
      - proxy
      - localdns
      - automation_network
    ports:
      - "{{ automation.services.ollama.port }}:11434"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.ollama.rule=Host(`ollama.frey`)"
      - "traefik.http.routers.ollama.entrypoints=web,websecure"
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"
      # Enable HTTPS redirect
      - "traefik.http.routers.ollama.tls=true"
      - "traefik.http.routers.ollama-http.rule=Host(`ollama.frey`)"
      - "traefik.http.routers.ollama-http.entrypoints=web"
      - "traefik.http.routers.ollama-http.middlewares=https-redirect"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
    volumes:
      - "{{ storage.appdata_dir }}/ollama:/root/.ollama"

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    networks:
      - proxy
      - localdns
      - automation_network
    ports:
      - "{{ automation.services.openwebui.port }}:8080"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.open-webui.rule=Host(`ai.frey`)"
      - "traefik.http.routers.open-webui.entrypoints=web,websecure"
      - "traefik.http.services.open-webui.loadbalancer.server.port=8080"
      # Enable HTTPS redirect
      - "traefik.http.routers.open-webui.tls=true"
      - "traefik.http.routers.open-webui-http.rule=Host(`ai.frey`)"
      - "traefik.http.routers.open-webui-http.entrypoints=web"
      - "traefik.http.routers.open-webui-http.middlewares=https-redirect"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
    environment:
      - OLLAMA_API_BASE_URL=http://ollama:11434
      - BACKEND_URL=http://open-webui:8080
      - OPENWEBUI_APP_URL=https://ai.frey
      - TZ=Europe/Berlin
    volumes:
      - "{{ storage.appdata_dir }}/open-webui:/app/backend/data"
    depends_on:
      - ollama

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    user: "{{ automation.user.uid }}:{{ automation.group.gid }}"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://n8n:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - proxy
      - localdns
      - automation_network
    ports:
      - "{{ automation.services.n8n.port }}:5678"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.n8n.rule=Host(`n8n.frey`)"
      - "traefik.http.routers.n8n.entrypoints=web,websecure"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      # Enable HTTPS redirect
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.routers.n8n-http.rule=Host(`n8n.frey`)"
      - "traefik.http.routers.n8n-http.entrypoints=web"
      - "traefik.http.routers.n8n-http.middlewares=https-redirect"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
    environment:
      - N8N_USER_FOLDER=/home/node/.n8n
      - GENERIC_TIMEZONE={{ network.timezone }}
      - NODE_ENV=production
      - N8N_SECURE_COOKIE=false
    volumes:
      - "{{ storage.appdata_dir }}/n8n:/home/node/.n8n"

{% if features.homeassistant | default(false) %}
  # ==============================================================================
  # HOME ASSISTANT - HOME AUTOMATION PLATFORM
  # ==============================================================================
  {% if homeassistant.services.homeassistant.enabled | default(false) -%}
  homeassistant:
    image: "ghcr.io/home-assistant/home-assistant:{{ homeassistant.services.homeassistant.version | default('stable') }}"
    container_name: homeassistant
    restart: unless-stopped
    ports:
      - "{{ homeassistant.services.homeassistant.port | default(8123) }}:8123"
    volumes:
      - "{{ storage.appdata_dir }}/homeassistant:/config"
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro  # For Bluetooth and other system integrations
    environment:
      - TZ={{ network.timezone | default('UTC') }}
{% if infrastructure.services.authentik.enabled | default(false) %}
    # OIDC/SSO Configuration (requires manual setup in Home Assistant UI)
    # Configure via: Settings → Users → Add Integration → OpenID Connect
    # Issuer URL: {{ network.authentik_public_url }}/application/o/homeassistant/
    # Client ID: {{ homeassistant.services.homeassistant.oidc_client_id | default('homeassistant') }}
    # Client Secret: {{ homeassistant_oidc_client_secret }}
{% endif %}
    privileged: true  # Required for USB device access (Zigbee, Z-Wave, etc.)
    networks:
      proxy:              # For Traefik access
      localdns:          # For DNS resolution
      automation_network:  # Automation services network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.homeassistant.rule=Host(`homeassistant.{{ network.domain_name }}`)"
      - "traefik.http.routers.homeassistant.entrypoints=web,websecure"
      - "traefik.http.routers.homeassistant.tls=true"
      - "traefik.http.services.homeassistant.loadbalancer.server.port=8123"
  {% endif %}

  {% if homeassistant.services.piper.enabled | default(false) -%}
  # Piper - Local Text-to-Speech (TTS) using Wyoming protocol
  piper:
    image: "rhasspy/wyoming-piper:{{ homeassistant.services.piper.version | default('latest') }}"
    container_name: piper
    restart: unless-stopped
    ports:
      - "{{ homeassistant.services.piper.port | default(10200) }}:10200"
    volumes:
      - "{{ storage.appdata_dir }}/piper:/data"
    command:
      --voice {{ homeassistant.services.piper.default_voice | default('en_US-lessac-medium') }}
      --download-dir /data
    networks:
      automation_network:  # Only accessible from automation network
    labels:
      - "traefik.enable=false"  # Internal service only
  {% endif %}

  {% if homeassistant.services.wyoming_whisper.enabled | default(false) -%}
  # Wyoming Whisper - Local Speech-to-Text (STT) using Faster Whisper
  wyoming-whisper:
    image: "rhasspy/wyoming-whisper:{{ homeassistant.services.wyoming_whisper.version | default('latest') }}"
    container_name: wyoming-whisper
    restart: unless-stopped
    ports:
      - "{{ homeassistant.services.wyoming_whisper.port | default(10300) }}:10300"
    volumes:
      - "{{ storage.appdata_dir }}/wyoming-whisper:/data"
    command:
      --model {{ homeassistant.services.wyoming_whisper.model | default('tiny-int8') }}
      --language {{ homeassistant.services.wyoming_whisper.language | default('en') }}
    networks:
      automation_network:  # Only accessible from automation network
    labels:
      - "traefik.enable=false"  # Internal service only
  {% endif %}
{% endif %}

networks:
  proxy:
    external: true
  localdns:
    external: true
  automation_network:
    name: automation_network
    ipam:
      config:
        - subnet: 10.20.2.0/24