---
# ==============================================================================
# PHASE 1: START IMAGE DOWNLOADS IN BACKGROUND
# ==============================================================================
# Kickoff downloads for automation services (Ollama models can be multi-GB).
# These run in background while we do setup work.

- name: Combine automation and homeassistant services for pre-pulling
  ansible.builtin.set_fact:
    automation_combined_services: >-
      {{
        automation.services
        | combine(homeassistant.services if (features.homeassistant | default(false)) else {})
      }}
  tags:
    - images

- name: Start background image pulls for automation stack
  include_tasks: "../playbooks/templates/async_prepull_start.yml"
  vars:
    stack: "automation"
    service_dict: "{{ automation_combined_services }}"
    prepull_timeout: 600  # Allow longer for large Ollama models
  tags:
    - images

# ==============================================================================
# PHASE 2: SETUP WORK (RUNS WHILE IMAGES DOWNLOAD)
# ==============================================================================

- name: Setup automation stack user and directories
  include_tasks: "templates/create_user.yml"
  vars:
    stack: "automation"
    folders: [ollama, n8n, open-webui, homeassistant, piper, wyoming-whisper]
    checkVar: [storage.base_dir, automation.user.name]

# ==============================================================================
# PHASE 3: WAIT FOR IMAGE DOWNLOADS TO COMPLETE
# ==============================================================================

- name: Wait for automation stack images to finish downloading
  include_tasks: "../playbooks/templates/async_prepull_wait.yml"
  vars:
    stack: "automation"
    prepull_retries: 120  # Longer for large Ollama models
    prepull_delay: 5
  tags:
    - images

# ==============================================================================
# PHASE 4: DEPLOY STACK
# ==============================================================================

- name: Deploy automation stack
  include_tasks: "../playbooks/templates/deploy_compose_stack.yml"
  vars:
    stack: "automation"
    compose_template: "docker-compose-automation.yml.j2"
    error_handling: "rescue"
    deploy_timeout: 300
    deploy_retries: 2
  tags:
    - deploy
