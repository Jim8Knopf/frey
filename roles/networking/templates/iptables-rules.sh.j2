#!/bin/bash
# This script configures NAT and forwarding for the WiFi AP.
# Configure NAT and forwarding for WiFi AP

# Clear existing rules
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# Set default policies
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

# Enable NAT from AP network to internet via client interface
iptables -t nat -A POSTROUTING -o {{ wifi_client_interface }} -j MASQUERADE
iptables -A FORWARD -i {{ wifi_client_interface }} -o {{ wifi_ap_interface }} -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i {{ wifi_ap_interface }} -o {{ wifi_client_interface }} -j ACCEPT

# Allow traffic within the AP network
iptables -A INPUT -i {{ wifi_ap_interface }} -j ACCEPT
iptables -A OUTPUT -o {{ wifi_ap_interface }} -j ACCEPT

# Allow DNS and DHCP on AP interface
iptables -A INPUT -i {{ wifi_ap_interface }} -p udp --dport 53 -j ACCEPT
iptables -A INPUT -i {{ wifi_ap_interface }} -p udp --dport 67 -j ACCEPT
iptables -A INPUT -i {{ wifi_ap_interface }} -p tcp --dport 53 -j ACCEPT

echo "iptables rules applied successfully"