#!/bin/bash
#
# Pre-commit Hook: Ansible Vault Auto-Encrypt
#
# This hook automatically encrypts the secrets file if it's unencrypted,
# and only fails if encryption is not possible.

set -e  # Exit on any error

FILE_PATTERN="group_vars/all/secrets.yml"
VAULT_PASSWORD_FILE=".vault_pass"
ENCRYPTED_PATTERN='^\$ANSIBLE_VAULT'

# Function to check if file is encrypted
is_encrypted() {
    head -1 "$1" | grep -q "$ENCRYPTED_PATTERN"
}

# Check if our secrets file is in the changes
if git diff --cached --name-only | grep -q "$FILE_PATTERN"; then
    echo "üîê Ansible Vault: Checking $FILE_PATTERN encryption status..."
    
    # Get the staged version of the file
    STAGED_FILE=$(mktemp)
    git show ":/$FILE_PATTERN" > "$STAGED_FILE" 2>/dev/null || true
    
    # If we can't get staged content, use the working directory file
    if [ ! -s "$STAGED_FILE" ]; then
        cp "$FILE_PATTERN" "$STAGED_FILE"
    fi
    
    # Check if the staged file is encrypted
    if ! is_encrypted "$STAGED_FILE"; then
        echo "‚ö†Ô∏è  $FILE_PATTERN is not encrypted. Attempting automatic encryption..."
        
        # Check if vault password file exists
        if [ ! -f "$VAULT_PASSWORD_FILE" ]; then
            echo "‚ùå ERROR: Vault password file '$VAULT_PASSWORD_FILE' not found!"
            echo "   Cannot encrypt $FILE_PATTERN automatically."
            echo "   Please create '$VAULT_PASSWORD_FILE' or encrypt manually with:"
            echo "   ansible-vault encrypt $FILE_PATTERN --vault-password-file $VAULT_PASSWORD_FILE"
            rm -f "$STAGED_FILE"
            exit 1
        fi
        
        # Ensure password file has secure permissions
        if [ "$(stat -c %a "$VAULT_PASSWORD_FILE" 2>/dev/null || stat -f %Lp "$VAULT_PASSWORD_FILE")" != "600" ]; then
            echo "‚ö†Ô∏è  Setting secure permissions on $VAULT_PASSWORD_FILE..."
            chmod 600 "$VAULT_PASSWORD_FILE"
        fi
        
        # Try to encrypt the file
        if ansible-vault encrypt "$FILE_PATTERN" --vault-password-file "$VAULT_PASSWORD_FILE" > /dev/null 2>&1; then
            echo "‚úÖ Successfully encrypted $FILE_PATTERN"
            
            # Stage the newly encrypted file
            git add "$FILE_PATTERN"
            echo "üì¶ Encrypted file has been added to git staging area"
        else
            echo "‚ùå ERROR: Failed to encrypt $FILE_PATTERN!"
            echo "   Please check that:"
            echo "   1. Your vault password in $VAULT_PASSWORD_FILE is correct"
            echo "   2. You have ansible-vault installed"
            echo "   3. The file $FILE_PATTERN exists and is valid YAML"
            rm -f "$STAGED_FILE"
            exit 1
        fi
    else
        echo "‚úÖ $FILE_PATTERN is already encrypted"
    fi
    
    # Cleanup
    rm -f "$STAGED_FILE"
fi

# Additional safety: Check for any potentially unencrypted secret files in the entire commit
echo "üîç Scanning for other potential unencrypted secret files..."
if git diff --cached --name-only | grep -E '\.(vault|secret|key|env|pem)$' | while read file; do
    if [ -f "$file" ] && ! is_encrypted "$file"; then
        echo "‚ö†Ô∏è  WARNING: $file looks like a secret file but is not encrypted with Ansible Vault"
        echo "   Consider encrypting it with: ansible-vault encrypt $file"
    fi
done; then
    echo "‚úÖ Security scan complete"
fi
